const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-BFudLC3v.js","./index-C9zlu8m2.css","./chartUtilsAm5-B8aRUWru.js","./Theme-CGdtSsh4.js","./Tooltip-WMJR54GJ.js","./DefaultTheme-C1RakiDr.js","./chartCommon-Bc-L_8SO.js","./Button-Co-1MgKD.js","./ColorSet-_WXMidHS.js","./pieChart-Dk8DFZ8L.js","./Tick-CjVtICwr.js","./xyChart-BJ8FDUCJ.js","./arcade-BCRykBCV.js","./languageUtils-Csgv-2tu.js","./executionError-BzD4dK1Y.js","./TimeOnly-Cz5zu_49.js","./number-DRyV2w6U.js","./arcade-BdhEvfAc.js","./WhereClause-B9_YQQsG.js","./unitConversion-GBle4jkI.js","./createVersion-DzYo6d9X.js","./CreateVersionParameters-CL9WiHki.js","./deleteVersion-CuxjrBcf.js","./serverVersionUtils-DYOH3JJE.js","./DeleteVersionParameters-CXXJnStG.js","./getVersion-CwgCDC8Z.js","./getVersionInfos-CsfSp_tD.js","./GetVersionInfosParameters-BHbkgP3L.js","./reconcile-Ub7_bLFA.js","./ReconcileParameters-C4x4MCxh.js","./post-C8Q4nij1.js","./PostParameters-DvUmuEEq.js","./alterVersion-BvhTcGKj.js","./AlterVersionParameters-6IcJhB3g.js","./startReading-Df3IqoCf.js","./stopReading-DaJlKb-G.js","./startEditing-BNdUwi6B.js","./deleteForwardEdits-CB_fP6Nb.js","./DeleteForwardEditsParameters-D1ecKMax.js","./stopEditing-B5dF_OLe.js","./index-BoOF33T4.js","./customElement-DWr-DuCW.js","./index-CYq2AVbR.js","./utils-C340IDCb.js","./index-D9YxSY9e.js","./index-BHTeevKI.js","./index-FRclNN51.js","./resources6-Cs2_VmEC.js","./index-DelJUcfE.js","./resources5-SciNIBSe.js","./index-CpwZb1xc.js","./index-Diog0XOc.js","./index-Bjr6sB9h.js","./index-D4Fyp3lU.js","./geometryEngineAsync-Bl5oqJGC.js","./index-lMnjL2dc.js","./index-Br9-2cP7.js"])))=>i.map(i=>d[i]);
import{aV as G,W as o,Z as l,e2 as at,aB as Ye,tK as or,ap as k,bV as ye,a1 as w,e6 as P,b as A,dN as ki,e5 as ar,lD as re,lu as he,dy as yt,lx as Fe,_,ly as p,lz as T,tL as Li,tM as Vi,qJ as $e,nq as Fs,nX as lr,tN as Cs,cG as Pi,h9 as dr,gj as nt,bv as cr,ak as se,ao as Vt,qu as ur,a4 as He,jD as ci,mS as Es,G as ot,tO as hr,mX as me,rF as pr,qK as mr,gW as gr,tP as fr,aq as yi,e9 as Je,kp as Ae,fr as Bt,as as ze,tQ as yr,tR as Ts,tS as vr,V as _r,dR as Re,aF as vi,ad as wr,dC as zt,$ as _i,m$ as br,aQ as Si,aO as Ir,ae as Mr,aj as Mt,tT as Ar,cD as $s,T as Fr,tU as Cr,tV as Er,am as Gt,a5 as Tr,a6 as $r,a7 as xr,aE as Pt,eT as kr,eU as Lr,a9 as Ce,dD as Ri,tW as be,tX as Oi,tY as Ni,ot as Vr,tZ as Y,t_ as At,t$ as Pr,u0 as Di,u1 as et,jW as Sr,dW as Rr,nG as Or,f1 as xs,hE as Nr,c1 as wi,a0 as Ne,jS as qt,d as Dr,P as Bi,jZ as qi,k5 as Br,k6 as qr,cI as ut,u2 as Ui,bq as ks,j1 as De,ea as Ls,ag as bi,u3 as ji,rE as Vs,u4 as Ut,qy as Ps,dv as vt,u5 as Ur,gY as jr,nr as Wr,ns as bt,nt as Ss,mD as Hr,u6 as zr,gu as Gr,ed as Qr,gO as Zr,hP as Jr,fh as Xr,eP as Yr,u7 as Kr,u8 as en,rG as Rs,lA as tn,lE as Os,jT as sn}from"./index-BFudLC3v.js";import{T as rn}from"./unitFormatUtils-C6twGqJQ.js";import{a as nn}from"./AttachmentInfo-BPXqTg-b.js";import{getSourceLayer as Ns,graphicCallback as jt,shouldOpenInNewTab as Ds,getFieldInfoLabel as Bs,isRelatedField as Ge,substituteFieldsInLinksAndAttributes as Qe,fixTokens as Wi,substituteAttributes as Hi,getFixedFieldNames as on,getFixedFieldName as ui,isExpressionField as qs,getFieldInfo as an,applyTextFormattingHTML as Ii,htmlEntities as Mi,findRelatedLayer as ln,findUtilityNetwork as dn,createFieldInfoMap as cn,getAllFieldInfos as zi,querySourceLayer as un,queryUpdatedFeature as hn,isRelatableFeatureSupportedLayer as pn,isAssociatedFeatureSupportedLayer as mn,formatEditInfo as gn,formatAttributes as Jt,preLayerQueryCallback as fn,preRequestCallback as yn}from"./featureUtils-B0LZyLYC.js";import{z as Ai,C as vn,R as Gi}from"./symbolUtils-DFtoUil5.js";import{s as Xt}from"./executeQueryJSON-CmtcvRhO.js";import{ae as _n}from"./languageUtils-Csgv-2tu.js";import{s as wn}from"./utils-CclteEI6.js";import{m as Qi,b as bn,f as In,j as Mn,y as An,I as Fn}from"./applyEditsUtils-CxATyH-C.js";import{checkEditingCapabilities as Cn,normalizeEdits as En,normalizeGeometries as Tn}from"./editingSupport-DbItHUpj.js";import"./affineTransformOperator-v1x_h6TK.js";import"./Transformation2D-DUa_jsnY.js";import{p as $n}from"./Association-BPndGKeH.js";import{t as xn}from"./ReactiveSet-nZfIAgSw.js";import{e as kn}from"./SubtypeSublayer-D45pFzxd.js";import{n as Ln}from"./layerViewUtils-B4pbvQOn.js";import"./ByteSizeUnit-BsxeN7wM.js";import"./quantityUtils-Sq0YaeAQ.js";import"./utils-CqB-nE1K.js";import"./utils-B90FjHHH.js";import"./cimSymbolUtils-BZWniSJI.js";import"./colorUtils-CW8biUm0.js";import"./webStyleSymbolUtils-1ovTVI4v.js";import"./devEnvironmentUtils-CnNDiFMM.js";import"./webStyleAcceptedFormats-CG7ZQ6BV.js";import"./query-DE9Vi8XE.js";import"./pbfQueryUtils-DFiURety.js";import"./pbf-BO7QTeVd.js";import"./executionError-BzD4dK1Y.js";import"./TimeOnly-Cz5zu_49.js";import"./number-DRyV2w6U.js";import"./MeshTransform-L5FzXYQf.js";import"./mat4f64-Dk4dwAN8.js";import"./quat-BxYdzspF.js";import"./mat3f64-q3fE-ZOt.js";import"./quatf64-aQ5IuZRd.js";import"./axisAngleDegrees-B8_3SZ7s.js";import"./SimpleGeometryCursor-B92kdZ15.js";import"./apiConverter-CppecMD3.js";import"./ProjectionTransformation-L8tGGcIU.js";import"./jsonConverter-CFjiQEq2.js";function _t(i,e,t,s){let r=null,n=1e3;typeof e=="number"?(n=e,s=t):(r=e??null,n=t);let a,d=0;const c=()=>{d=0,i.apply(s,a)},u=(...h)=>{r&&r.apply(s,h),a=h,n?d||(d=setTimeout(c,n)):c()};return u.remove=()=>{d&&(clearTimeout(d),d=0)},u.forceUpdate=()=>{d&&(clearTimeout(d),c())},u.hasPendingUpdates=()=>!!d,u}function hi(i){var e;switch(i==null?void 0:i.type){case"point":return i;case"extent":return i.center;case"polygon":return i.centroid;case"multipoint":case"polyline":return(e=i.extent)==null?void 0:e.center;default:return null}}const Zi={editing:!1,operations:{add:!0,update:!0,delete:!0}},Us=G.ofType(nn);let ae=class extends ye{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities={...Zi},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new Us,this.fileInfos=new G,this.graphic=null,this.mode="view",this.orderByFields=null,this.filesEnabled=!1,this.addHandles(w(()=>this.graphic,()=>this._graphicChanged(),P))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(e){return{...Zi,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:e}=this;if(!e)return!1;const t=e.layer||e.sourceLayer;return(t==null?void 0:t.loaded)&&"capabilities"in t&&t.capabilities&&"attachment"in t.capabilities&&t.capabilities.attachment&&"supportsResize"in t.capabilities.attachment&&t.capabilities.attachment.supportsResize||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t,orderByFields:s}=this;if(!e||typeof e.queryAttachments!="function")throw new A("invalid-layer","getAttachments(): A valid layer is required.");const r=this._getObjectId();if(typeof r!="number")throw new A("invalid-object-id","getAttachments(): Numeric object id is required");const n=s==null?void 0:s.map(h=>`${h.field} ${h.order==="descending"?"DESC":"ASC"}`),a=new ki({objectIds:[r],returnMetadata:!0,orderByFields:n}),d=[],c=e.queryAttachments(a).then(h=>h[r]||d).catch(()=>d);this._getAttachmentsPromise=c,this.notifyChange("state");const u=await c;return t.destroyAll(),u.length&&t.addMany(u),this._getAttachmentsPromise=null,this.notifyChange("state"),u}async addAttachment(e,t=this.graphic){var c;const{_attachmentLayer:s,attachmentInfos:r,capabilities:n}=this;if(!t)throw new A("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:t});if(!e)throw new A("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!((c=n.operations)!=null&&c.add))throw new A("invalid-capabilities","addAttachment(): add capabilities are required.");if(!s||typeof s.addAttachment!="function")throw new A("invalid-layer","addAttachment(): A valid layer is required.");const a=s.addAttachment(t,e).then(u=>this._queryAttachment(u.objectId,t)),d=await a;return r.add(d),d}async deleteAttachment(e){var c;const{_attachmentLayer:t,attachmentInfos:s,graphic:r,capabilities:n}=this;if(!e)throw new A("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!((c=n.operations)!=null&&c.delete))throw new A("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new A("invalid-layer","deleteAttachment(): A valid layer is required.");if(!r)throw new A("invalid-graphic","deleteAttachment(): A graphic is required.");const a=t.deleteAttachments(r,[e.id]).then(()=>e),d=await a;return s.remove(d),d.destroy(),d}async updateAttachment(e,t=this.activeAttachmentInfo){var h;const{_attachmentLayer:s,attachmentInfos:r,graphic:n,capabilities:a}=this;if(!e)throw new A("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new A("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!((h=a.operations)!=null&&h.update))throw new A("invalid-capabilities","updateAttachment(): Update capabilities are required.");const d=r.indexOf(t);if(!s||typeof s.updateAttachment!="function")throw new A("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new A("invalid-graphic","updateAttachment(): A graphic is required.");const c=s.updateAttachment(n,t.id,e).then(m=>this._queryAttachment(m.objectId)),u=await c;return r.splice(d,1,u),u}async commitFiles(){return await Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(e,t){if(!e||!t)return null;const s={file:e,form:t};return this.fileInfos.add(s),s}updateFile(e,t,s=this.activeFileInfo){if(!e||!t||!s)return null;const r=this.fileInfos.indexOf(s);return r>-1&&this.fileInfos.splice(r,1,{file:e,form:t}),this.fileInfos.items[r]}deleteFile(e){const t=this.fileInfos.find(s=>s.file===e);return t?(this.fileInfos.remove(t),t):null}async _queryAttachment(e,t){const{_attachmentLayer:s}=this;if(!e||!(s!=null&&s.queryAttachments))throw new A("invalid-attachment-id","Could not query attachment.");const r=this._getObjectId(t);if(typeof r!="number")throw new A("invalid-object-id","getAttachments(): Numeric object id is required");const n=new ki({objectIds:[r],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return s.queryAttachments(n).then(a=>a[r][0])}_getObjectId(e=this.graphic){return(e==null?void 0:e.getObjectId())??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>this.attachmentInfos.destroyAll()))}_setAttachmentLayer(){const{graphic:e}=this,t=Ns(e);this._attachmentLayer=t?t.type==="scene"&&t.associatedLayer!=null?t.associatedLayer:t:null}};o([l()],ae.prototype,"capabilities",void 0),o([at("capabilities")],ae.prototype,"castCapabilities",null),o([l()],ae.prototype,"activeAttachmentInfo",void 0),o([l()],ae.prototype,"activeFileInfo",void 0),o([l({readOnly:!0,type:Us})],ae.prototype,"attachmentInfos",void 0),o([l()],ae.prototype,"fileInfos",void 0),o([l({type:Ye})],ae.prototype,"graphic",void 0),o([l()],ae.prototype,"mode",void 0),o([l({type:[or]})],ae.prototype,"orderByFields",void 0),o([l({readOnly:!0})],ae.prototype,"state",null),o([l()],ae.prototype,"filesEnabled",void 0),o([l({readOnly:!0})],ae.prototype,"supportsResizeAttachments",null),ae=o([k("esri.widgets.Attachments.AttachmentsViewModel")],ae);const Fi=ae;function Ji(i){const e=i.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function Vn(i){const e=ar("esri/themes/base/images/files/");return i?i==="text/plain"?`${e}text-32.svg`:i==="application/pdf"?`${e}pdf-32.svg`:i==="text/csv"?`${e}csv-32.svg`:i==="application/gpx+xml"?`${e}gpx-32.svg`:i==="application/x-dwf"?`${e}cad-32.svg`:i==="application/postscript"||i==="application/json"||i==="text/xml"||i==="model/vrml"?`${e}code-32.svg`:i==="application/x-zip-compressed"||i==="application/x-7z-compressed"||i==="application/x-gzip"||i==="application/x-tar"||i==="application/x-gtar"||i==="application/x-bzip2"||i==="application/gzip"||i==="application/x-compress"||i==="application/x-apple-diskimage"||i==="application/x-rar-compressed"||i==="application/zip"?`${e}zip-32.svg`:i.includes("image/")?`${e}image-32.svg`:i.includes("audio/")?`${e}sound-32.svg`:i.includes("video/")?`${e}video-32.svg`:i.includes("msexcel")||i.includes("ms-excel")||i.includes("spreadsheetml")?`${e}excel-32.svg`:i.includes("msword")||i.includes("ms-word")||i.includes("wordprocessingml")?`${e}word-32.svg`:i.includes("powerpoint")||i.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}const Te={close:"esri-icon-close",collapse:"esri-icon-collapse",down:"esri-icon-down",downArrow:"esri-icon-down-arrow",dragHorizontal:"esri-icon-drag-horizontal",dragVertical:"esri-icon-drag-vertical",duplicate:"esri-icon-duplicate",expand:"esri-icon-expand",fontFallbackText:"esri-icon-font-fallback-text",forward:"esri-icon-forward",handleVertical:"esri-icon-handle-vertical",icon:"esri-icon",left:"esri-icon-left",locateCircled:"esri-icon-locate-circled",noticeTriangle:"esri-icon-notice-triangle",pause:"esri-icon-pause",play:"esri-icon-play",plus:"esri-icon-plus",radioChecked:"esri-icon-radio-checked",radioUnchecked:"esri-icon-radio-unchecked",refresh:"esri-icon-refresh",reverse:"esri-icon-reverse",right:"esri-icon-right",search:"esri-icon-search",swap:"esri-icon-swap",table:"esri-icon-table",trash:"esri-icon-trash",up:"esri-icon-up",upArrow:"esri-icon-up-arrow",upDownArrows:"esri-icon-up-down-arrows",urbanModel:"esri-icon-urban-model",zoomInMagnifyingGlass:"esri-icon-zoom-in-magnifying-glass",zoomToObject:"esri-icon-zoom-to-object"},Xi={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},V="esri-attachments",F={base:V,loaderContainer:`${V}__loader-container`,loader:`${V}__loader`,fadeIn:`${V}--fade-in`,container:`${V}__container`,containerList:`${V}__container--list`,containerPreview:`${V}__container--preview`,actions:`${V}__actions`,deleteButton:`${V}__delete-button`,addAttachmentButton:`${V}__add-attachment-button`,errorMessage:`${V}__error-message`,items:`${V}__items`,item:`${V}__item`,itemButton:`${V}__item-button`,itemMask:`${V}__item-mask`,itemMaskIcon:`${V}__item-mask--icon`,itemImage:`${V}__image`,itemImageResizable:`${V}__image--resizable`,itemLabel:`${V}__label`,itemFilename:`${V}__filename`,itemChevronIcon:`${V}__item-chevron-icon`,itemLink:`${V}__item-link`,itemLinkOverlay:`${V}__item-link-overlay`,itemLinkOverlayIcon:`${V}__item-link-overlay-icon`,itemEditIcon:`${V}__item-edit-icon`,itemAddIcon:`${V}__item-add-icon`,itemAddButton:`${V}__item-add-button`,formNode:`${V}__form-node`,fileFieldset:`${V}__file-fieldset`,fileLabel:`${V}__file-label`,fileName:`${V}__file-name`,fileInput:`${V}__file-input`,metadata:`${V}__metadata`,metadataFieldset:`${V}__metadata-fieldset`,progressBar:`${V}__progress-bar`},Yt=window.CSS;let ee=class extends he{constructor(e,t){super(e,t),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...Xi},this._supportsImageOrientation=Yt&&Yt.supports&&Yt.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}normalizeCtorArgs(e){return e!=null&&e.viewModel||(e={viewModel:new Fi,...e}),e}initialize(){this.addHandles([yt(()=>{var e;return(e=this.viewModel)==null?void 0:e.attachmentInfos},"change",()=>this.scheduleRender()),yt(()=>{var e;return(e=this.viewModel)==null?void 0:e.fileInfos},"change",()=>this.scheduleRender()),w(()=>{var e;return(e=this.viewModel)==null?void 0:e.mode},()=>this._modeChanged(),P)])}loadDependencies(){return Fe({icon:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vV),__vite__mapDeps([0,1]),import.meta.url)})}get capabilities(){return this.viewModel.capabilities}set capabilities(e){this.viewModel.capabilities=e}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get icon(){return"attachment"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}castVisibleElements(e){return{...Xi,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then(s=>(this._set("submitting",!1),this._set("error",null),t.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new A("attachments:add-attachment",this.messages.addErrorMessage,s)),s})}deleteAttachment(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then(s=>(this._set("submitting",!1),this._set("error",null),t.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new A("attachments:delete-attachment",this.messages.deleteErrorMessage,s)),s})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then(s=>(this._set("submitting",!1),this._set("error",null),e.mode="view",s)).catch(s=>{throw this._set("submitting",!1),this._set("error",new A("attachments:update-attachment",this.messages.updateErrorMessage,s)),s})}addFile(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e}updateFile(){const{viewModel:e}=this,t=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",t}deleteFile(e){var s;const t=this.viewModel.deleteFile(e||((s=this.viewModel.activeFileInfo)==null?void 0:s.file));return this.viewModel.mode="view",t}render(){const{submitting:e,viewModel:t}=this,{state:s}=t;return p("div",{class:this.classes(F.base,T.widget)},e?this._renderProgressBar():null,s==="loading"?this._renderLoading():this._renderAttachments(),this._renderErrorMessage())}_renderErrorMessage(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?p("div",{class:F.errorMessage,key:"error-message"},e.message):null}_renderAttachments(){const{activeFileInfo:e,mode:t,activeAttachmentInfo:s}=this.viewModel;return t==="add"?this._renderAddForm():t==="edit"?this._renderDetailsForm(s||e):this._renderAttachmentContainer()}_renderLoading(){return p("div",{class:F.loaderContainer,key:"loader"},p("div",{class:F.loader}))}_renderProgressBar(){return this.visibleElements.progressBar?p("div",{class:F.progressBar,key:"progress-bar"}):null}_renderAddForm(){const{submitting:e,selectedFile:t}=this,s=e||!t,r=this.visibleElements.cancelAddButton?p("button",{bind:this,class:this.classes(T.button,T.buttonTertiary,T.buttonSmall,T.buttonHalf,e&&T.buttonDisabled),disabled:e,onclick:this._cancelForm,type:"button"},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?p("button",{class:this.classes(T.button,T.buttonSecondary,T.buttonSmall,T.buttonHalf,{[T.buttonDisabled]:s}),disabled:s,type:"submit"},this.messages.add):null,a=t?p("span",{class:F.fileName,key:"file-name"},t.name):null,d=p("form",{afterCreate:Li,afterRemoved:Vi,bind:this,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},p("fieldset",{class:F.fileFieldset},a,p("label",{class:this.classes(F.fileLabel,T.button,T.buttonSecondary)},t?this.messages.changeFile:this.messages.selectFile,p("input",{bind:this,class:F.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))),n,r);return p("div",{class:F.formNode,key:"add-form-container"},d)}_renderDetailsForm(e){var N,D,O;const{visibleElements:t,viewModel:s,selectedFile:r,submitting:n}=this,{capabilities:a}=s,d=n||!r;let c,u,h,m;r?(c=r.type,u=r.name,h=r.size):e&&"file"in e?(c=e.file.type,u=e.file.name,h=e.file.size):e&&"contentType"in e&&(c=e.contentType,u=e.name,h=e.size,m=e.url);const f=a.editing&&((N=a.operations)!=null&&N.delete)&&t.deleteButton?p("button",{bind:this,class:this.classes(T.button,T.buttonSmall,T.buttonTertiary,F.deleteButton,{[T.buttonDisabled]:n}),disabled:n,key:"delete-button",onclick:Q=>this._submitDeleteAttachment(Q,e),type:"button"},this.messages.delete):void 0,g=a.editing&&((D=a.operations)!=null&&D.update)&&t.updateButton?p("button",{class:this.classes(T.button,T.buttonSmall,T.buttonThird,{[T.buttonDisabled]:d}),disabled:d,key:"update-button",type:"submit"},this.messages.update):void 0,y=this.visibleElements.cancelUpdateButton?p("button",{bind:this,class:this.classes(T.button,T.buttonSmall,T.buttonTertiary,T.buttonThird,{[T.buttonDisabled]:n}),disabled:n,key:"cancel-button",onclick:this._cancelForm,type:"button"},this.messages.cancel):void 0,v=a.editing&&((O=a.operations)!=null&&O.update)?p("fieldset",{class:F.fileFieldset,key:"file"},p("span",{class:F.fileName,key:"file-name"},u),p("label",{class:this.classes(F.fileLabel,T.button,T.buttonSecondary)},this.messages.changeFile,p("input",{bind:this,class:F.fileInput,name:"attachment",onchange:this._handleFileInputChange,type:"file"}))):void 0,b=p("fieldset",{class:F.metadataFieldset,key:"size"},p("label",null,rn(this.messagesUnits,h??0))),I=p("fieldset",{class:F.metadataFieldset,key:"content-type"},p("label",null,c)),M=m!=null?p("a",{class:F.itemLink,href:m,rel:"noreferrer",target:"_blank"},this._renderImageMask(e,400),p("div",{class:F.itemLinkOverlay},p("span",{class:F.itemLinkOverlayIcon},p("calcite-icon",{icon:"launch"})))):this._renderImageMask(e,400),E=p("form",{afterCreate:Li,afterRemoved:Vi,bind:this,"data-node-ref":"_updateAttachmentForm",onsubmit:Q=>this._submitUpdateAttachment(Q,e)},p("div",{class:F.metadata},b,I),v,p("div",{class:F.actions},f,y,g));return p("div",{class:F.formNode,key:"edit-form-container"},M,E)}_renderImageMask(e,t){return e?"file"in e?this._renderGenericImageMask(e.file.name,e.file.type):this._renderImageMaskForAttachment(e,t):null}_renderGenericImageMask(e,t){const{supportsResizeAttachments:s}=this.viewModel,r=Vn(t),n={[F.itemImageResizable]:s};return p("div",{class:this.classes(F.itemMaskIcon,F.itemMask),key:r},p("img",{alt:e,class:this.classes(n,F.itemImage),src:r,title:e}))}_renderImageMaskForAttachment(e,t){const{supportsResizeAttachments:s}=this.viewModel;if(!e)return null;const{contentType:r,name:n,url:a}=e;if(!s||!Ji(r))return this._renderGenericImageMask(n,r);const d=this._getCSSTransform(e),c=d?{transform:d,"image-orientation":"none"}:{},u=`${a}${a!=null&&a.includes("?")?"&":"?"}w=${t}`,h={[F.itemImageResizable]:s};return p("div",{class:this.classes(F.itemMask),key:u},p("img",{alt:n,class:this.classes(h,F.itemImage),src:u,styles:c,title:n}))}_renderFile(e){const{file:t}=e;return p("li",{class:F.item,key:t},p("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:F.itemButton,key:"details-button",onclick:()=>this._startEditFile(e),title:this.messages.attachmentDetails,type:"button"},this._renderImageMask(e),p("label",{class:F.itemLabel},p("span",{class:F.itemFilename},t.name||this.messages.noTitle),p("span",{"aria-hidden":"true",class:this.classes(F.itemChevronIcon,$e(this.container)?Te.left:Te.right)}))))}_renderAttachmentInfo({attachmentInfo:e,displayType:t}){const{viewModel:s,effectiveDisplayType:r}=this,{capabilities:n,supportsResizeAttachments:a}=s,{contentType:d,name:c,url:u}=e,h=this._renderImageMask(e,t==="list"?48:400),m=n.editing?p("span",{"aria-hidden":"true",class:this.classes(F.itemChevronIcon,$e(this.container)?Te.left:Te.right)}):null,f=[h,r==="preview"&&a&&Ji(d)?null:p("label",{class:F.itemLabel},p("span",{class:F.itemFilename},c||this.messages.noTitle),m)],g=n.editing?p("button",{"aria-label":this.messages.attachmentDetails,bind:this,class:F.itemButton,"data-attachment-info-id":e.id,key:"details-button",onclick:()=>this._startEditAttachment(e),title:this.messages.attachmentDetails,type:"button"},f):p("a",{class:F.itemButton,href:u??void 0,key:"details-link",rel:"noreferrer",target:"_blank"},f);return p("li",{class:F.item,key:e},g)}_renderAttachmentContainer(){var y;const{effectiveDisplayType:e,viewModel:t,visibleElements:s}=this,{attachmentInfos:r,capabilities:n,fileInfos:a}=t,d=!!(r!=null&&r.length),c=!!(a!=null&&a.length),u={[F.containerList]:e!=="preview",[F.containerPreview]:e==="preview"},h=n.editing&&((y=n.operations)!=null&&y.add)&&s.addButton?p("button",{bind:this,class:this.classes(T.button,T.buttonTertiary,F.addAttachmentButton),onclick:()=>this._startAddAttachment(),type:"button"},p("span",{"aria-hidden":"true",class:this.classes(F.itemAddIcon,Te.plus)}),this.messages.add):void 0,m=d?p("ul",{class:F.items,key:"attachments-list"},r.toArray().map(v=>this._renderAttachmentInfo({attachmentInfo:v,displayType:e}))):void 0,f=c?p("ul",{class:F.items,key:"file-list"},a.toArray().map(v=>this._renderFile(v))):void 0,g=c||d?void 0:p("div",{class:T.empty},this.messages.noAttachments);return p("div",{class:this.classes(F.container,u),key:"attachments-container"},m,f,g,h)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){var r;const t=e.target,s=(r=t.files)==null?void 0:r.item(0);this._set("selectedFile",s)}_submitDeleteAttachment(e,t){e.preventDefault(),t&&("file"in t?this.deleteFile(t.file):t&&this.deleteAttachment(t))}_submitAddAttachment(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(e,t){e.preventDefault(),t&&"file"in t?this.updateFile():this.updateAttachment()}_startEditAttachment(e){const{viewModel:t}=this;t.activeFileInfo=null,t.activeAttachmentInfo=e,t.mode="edit"}_startEditFile(e){const{viewModel:t}=this;t.activeAttachmentInfo=null,t.activeFileInfo=e,t.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e){const{orientationInfo:t}=e;return!this._supportsImageOrientation&&t?[t.rotation?`rotate(${t.rotation}deg)`:"",t.mirrored?"scaleX(-1)":""].join(" "):""}};o([l()],ee.prototype,"capabilities",null),o([l()],ee.prototype,"displayType",void 0),o([l({readOnly:!0})],ee.prototype,"effectiveDisplayType",null),o([l()],ee.prototype,"graphic",null),o([l()],ee.prototype,"icon",null),o([l()],ee.prototype,"label",null),o([l(),re("esri/widgets/Attachments/t9n/Attachments")],ee.prototype,"messages",void 0),o([l(),re("esri/core/t9n/Units")],ee.prototype,"messagesUnits",void 0),o([l({readOnly:!0})],ee.prototype,"selectedFile",void 0),o([l({readOnly:!0})],ee.prototype,"submitting",void 0),o([l({readOnly:!0})],ee.prototype,"error",void 0),o([l({type:Fi})],ee.prototype,"viewModel",void 0),o([l()],ee.prototype,"visibleElements",void 0),o([at("visibleElements")],ee.prototype,"castVisibleElements",null),ee=o([k("esri.widgets.Attachments")],ee);const Pn=ee;let ht=class extends Fi{constructor(e){super(e),this.description=null,this.title=null}};o([l()],ht.prototype,"description",void 0),o([l()],ht.prototype,"title",void 0),ht=o([k("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],ht);const Ci=ht,Kt="esri-feature-element-info",ei={base:Kt,title:`${Kt}__title`,description:`${Kt}__description`};let tt=class extends he{constructor(e,t){super(e,t),this.description=null,this.headingLevel=2,this.title=null}render(){return p("div",{class:ei.base},this._renderTitle(),this._renderDescription())}_renderTitle(){const{title:e}=this;return e?p(Ai,{class:ei.title,innerHTML:e,level:this.headingLevel}):null}_renderDescription(){const{description:e}=this;return e?p("div",{class:ei.description,innerHTML:e,key:"description"}):null}};o([l()],tt.prototype,"description",void 0),o([l()],tt.prototype,"headingLevel",void 0),o([l()],tt.prototype,"title",void 0),tt=o([k("esri.widgets.Feature.support.FeatureElementInfo")],tt);const It=tt,Sn={base:"esri-feature-attachments"};let Ie=class extends he{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attachmentsWidget=new Pn,this.headingLevel=2,this.viewModel=new Ci}initialize(){this._featureElementInfo=new It,this.addHandles([w(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.description,(t=this.viewModel)==null?void 0:t.title,this.headingLevel]},()=>this._setupFeatureElementInfo(),P),w(()=>this.viewModel,e=>this.attachmentsWidget.viewModel=e,P)])}destroy(){var e;this.attachmentsWidget.viewModel=null,this.attachmentsWidget.destroy(),(e=this._featureElementInfo)==null||e.destroy()}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get displayType(){return this.attachmentsWidget.displayType}set displayType(e){this.attachmentsWidget.displayType=e}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var t;const{attachmentsWidget:e}=this;return p("div",{class:Sn.base},(t=this._featureElementInfo)==null?void 0:t.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){var r;const{description:e,title:t,headingLevel:s}=this;(r=this._featureElementInfo)==null||r.set({description:e,title:t,headingLevel:s})}};o([l({readOnly:!0})],Ie.prototype,"attachmentsWidget",void 0),o([l()],Ie.prototype,"description",null),o([l()],Ie.prototype,"displayType",null),o([l()],Ie.prototype,"graphic",null),o([l()],Ie.prototype,"headingLevel",void 0),o([l()],Ie.prototype,"title",null),o([l({type:Ci})],Ie.prototype,"viewModel",void 0),Ie=o([k("esri.widgets.Feature.FeatureAttachments")],Ie);const Rn=Ie;let Pe=class extends ye{constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.addHandles(w(()=>this.creator,t=>{this._destroyContent(),this._createContent(t)},P))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:s}=this;e&&t&&(jt({type:"content",value:s,event:{graphic:t}}),this._set("created",null))}async _createContent(e){const t=this.graphic;if(!t||!e)return;const s=jt({type:"content",value:e,event:{graphic:t}});this._loadingPromise=s,this.notifyChange("state");const r=await s;s===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};o([l({readOnly:!0})],Pe.prototype,"created",void 0),o([l()],Pe.prototype,"creator",void 0),o([l()],Pe.prototype,"destroyer",void 0),o([l({type:Ye})],Pe.prototype,"graphic",void 0),o([l({readOnly:!0})],Pe.prototype,"state",null),Pe=o([k("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],Pe);const Wt=Pe,ti="esri-feature-content",ii={base:ti,loaderContainer:`${ti}__loader-container`,loader:`${ti}__loader`};let it=class extends he{constructor(e,t){super(e,t),this.viewModel=null,this._addTargetToAnchors=s=>{Array.from(s.querySelectorAll("a")).forEach(r=>{Ds(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}get creator(){var e;return(e=this.viewModel)==null?void 0:e.creator}set creator(e){this.viewModel&&(this.viewModel.creator=e)}get graphic(){var e;return(e=this.viewModel)==null?void 0:e.graphic}set graphic(e){this.viewModel&&(this.viewModel.graphic=e)}render(){var t;const e=(t=this.viewModel)==null?void 0:t.state;return p("div",{class:ii.base},e==="loading"?this._renderLoading():this._renderCreated())}_renderLoading(){return p("div",{class:ii.loaderContainer,key:"loader"},p("div",{class:ii.loader}))}_renderCreated(){var t;const e=(t=this.viewModel)==null?void 0:t.created;return e?e instanceof HTMLElement?p("div",{afterCreate:this._attachToNode,bind:e,key:e}):Fs(e)?p("div",{key:e},!e.destroyed&&e.render()):p("div",{afterCreate:this._addTargetToAnchors,innerHTML:e,key:e}):null}_attachToNode(e){const t=this;e.appendChild(t)}};o([l()],it.prototype,"creator",null),o([l()],it.prototype,"graphic",null),o([l({type:Wt})],it.prototype,"viewModel",void 0),it=o([k("esri.widgets.Feature.FeatureContent")],it);const St=it;let Ee=class extends ye{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,s=[];return t==null||t.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const n=r.clone();n.label=Bs(n,e),s.push(n)}),s}};o([l()],Ee.prototype,"attributes",void 0),o([l({type:[lr]})],Ee.prototype,"expressionInfos",void 0),o([l()],Ee.prototype,"description",void 0),o([l({type:[Cs]})],Ee.prototype,"fieldInfos",void 0),o([l({readOnly:!0})],Ee.prototype,"formattedFieldInfos",null),o([l()],Ee.prototype,"title",void 0),Ee=o([k("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],Ee);const Qt=Ee,On=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function Nn(i,e){if(typeof e!="string"||!e)return e;const t=On.find(c=>c.pattern.test(e));if(!t)return e;const s=e.match(t.pattern),r=s==null?void 0:s[2],n=Pi(Pi(t.label,{messages:i,hierPart:r}),{appName:t.appName}),a=t.target?` target="${t.target}"`:"",d=t.target==="_blank"?' rel="noreferrer"':"";return e.replace(t.pattern,`<a${a} href="$1"${d}>${n}</a>`)}const Ft="esri-feature-fields",Ct={base:Ft,fieldHeader:`${Ft}__field-header`,fieldData:`${Ft}__field-data`,fieldDataDate:`${Ft}__field-data--date`};let _e=class extends he{constructor(e,t){super(e,t),this._featureElementInfo=null,this.viewModel=new Qt,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new It,this.addHandles(w(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.description,(t=this.viewModel)==null?void 0:t.title]},()=>this._setupFeatureElementInfo(),P))}destroy(){var e;(e=this._featureElementInfo)==null||e.destroy()}get attributes(){return this.viewModel.attributes}set attributes(e){this.viewModel.attributes=e}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get expressionInfos(){return this.viewModel.expressionInfos}set expressionInfos(e){this.viewModel.expressionInfos=e}get fieldInfos(){return this.viewModel.fieldInfos}set fieldInfos(e){this.viewModel.fieldInfos=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var e;return p("div",{class:Ct.base},(e=this._featureElementInfo)==null?void 0:e.render(),this._renderFields())}_renderFieldInfo(e,t){var h;const{attributes:s}=this.viewModel,r=e.fieldName||"",n=e.label||r,a=s?s[r]==null?"":s[r]:"",d=!!((h=e.format)!=null&&h.dateFormat),c=typeof a=="number"&&!d?this._forceLTR(a):Nn(this.messagesURIUtils,a),u={[Ct.fieldDataDate]:d};return p("tr",{key:`fields-element-info-row-${r}-${t}`},p("th",{class:Ct.fieldHeader,innerHTML:n,key:`fields-element-info-row-header-${r}-${t}`}),p("td",{class:this.classes(Ct.fieldData,u),innerHTML:c,key:`fields-element-info-row-data-${r}-${t}`}))}_renderFields(){const{formattedFieldInfos:e}=this.viewModel;return e!=null&&e.length?p("table",{class:T.table,summary:this.messages.fieldsSummary},p("tbody",null,e.map((t,s)=>this._renderFieldInfo(t,s)))):null}_setupFeatureElementInfo(){var s;const{description:e,title:t}=this;(s=this._featureElementInfo)==null||s.set({description:e,title:t})}_forceLTR(e){return`&lrm;${e}`}};o([l()],_e.prototype,"attributes",null),o([l()],_e.prototype,"description",null),o([l()],_e.prototype,"expressionInfos",null),o([l()],_e.prototype,"fieldInfos",null),o([l()],_e.prototype,"title",null),o([l({type:Qt,nonNullable:!0})],_e.prototype,"viewModel",void 0),o([l(),re("esri/widgets/Feature/t9n/Feature")],_e.prototype,"messages",void 0),o([l(),re("esri/widgets/support/t9n/uriUtils")],_e.prototype,"messagesURIUtils",void 0),_e=o([k("esri.widgets.Feature.FeatureFields")],_e);const js=_e,Dn="esri.widgets.Feature.support.relatedFeatureUtils",Yi=()=>se.getLogger(Dn),Ki=new Map;function Rt(i){if(!Ge(i))return null;const[e,t]=i.split("/").slice(1);return{layerId:e,fieldName:t}}function Bn(i,e){if(!e.relationships)return null;let t=null;const{relationships:s}=e;return s.some(r=>r.id===parseInt(i,10)&&(t=r,!0)),t}function qn({originRelationship:i,relationships:e,layerId:t}){return e.find(({relatedTableId:s,id:r})=>`${s}`===t&&r===(i==null?void 0:i.id))??null}function Un(i,e){const t=e.toLowerCase();for(const s in i)if(s.toLowerCase()===t)return i[s];return null}function jn(i,e){const t=Bn(i,e);if(t)return{url:`${e.url}/${t.relatedTableId}`,sourceSpatialReference:e.spatialReference,relation:t,relatedFields:[],outStatistics:[]}}function Wn(i,e){if(!e||!i)return;const{features:t,statsFeatures:s}=i,r=t==null?void 0:t.value;e.relatedFeatures=r?r.features:[];const n=s==null?void 0:s.value;e.relatedStatsFeatures=n?n.features:[]}function Hn(i,e,t,s){var n;const r=new ci;return r.outFields=["*"],r.relationshipId=typeof e.id=="number"?e.id:parseInt(e.id,10),r.objectIds=[i.attributes[t.objectIdField]],r.gdbVersion=t.gdbVersion??null,r.historicMoment=t.historicMoment??null,((n=t.queryRelatedFeatures)==null?void 0:n.call(t,r,s))??Promise.resolve({})}function zn(i,e,t){let s=0;const r=[];for(;s<e.length;)r.push(`${i} IN (${e.slice(s,t+s)})`),s+=t;return r.join(" OR ")}function Gn(i){return i?Es(i):void 0}function Qn(i){return i?Es(i,(e,t)=>JSON.stringify(e.toJSON())===JSON.stringify(t.toJSON())):void 0}async function Zn(i,e,t,s){const r=t.layerId.toString(),{layerInfo:n,relation:a,relatedFields:d,outStatistics:c,url:u,sourceSpatialReference:h}=e,m=Gn(d),f=Qn(c);if(!n||!a)return null;const g=qn({originRelationship:a,relationships:n.relationships,layerId:r});if(g!=null&&g.relationshipTableId&&g.keyFieldInRelationshipTable){const v=(await Hn(i,g,t,s))[i.attributes[t.objectIdField]];if(!v)return null;const b=v.features.map(I=>I.attributes[n.objectIdField]);if(f!=null&&f.length&&n.supportsStatistics){const I=new Vt;I.where=zn(n.objectIdField,b,1e3),I.outFields=m,I.outStatistics=f,I.sourceSpatialReference=h;const M={features:Promise.resolve(v),statsFeatures:Xt(u,I)};return nt(M)}}const y=g==null?void 0:g.keyField;if(y){const v=ur(eo(n.fields,y)),b=Un(i.attributes,a.keyField),I=v?`${y}=${b}`:`${y}='${b}'`,M=t.historicMoment,E=t.gdbVersion,N=Xt(u,new Vt({where:I,outFields:m,sourceSpatialReference:h,historicMoment:M,gdbVersion:E}),s),D=f!=null&&f.length&&n.supportsStatistics?Xt(u,new Vt({where:I,outFields:m,outStatistics:f,sourceSpatialReference:h}),s):null,O={features:N};return D&&(O.statsFeatures=D),nt(O)}return null}function Jn(i,e){return He(i,{query:{f:"json"},signal:e==null?void 0:e.signal})}function Xn({relatedInfos:i,layer:e},t){const s={};return i.forEach((r,n)=>{const{relation:a}=r;if(!a){const m=new A("relation-required","A relation is required on a layer to retrieve related records.");throw Yi().error(m),m}const{relatedTableId:d}=a;if(typeof d!="number"){const m=new A("A related table ID is required on a layer to retrieve related records.");throw Yi().error(m),m}const c=`${e.url}/${d}`,u=Ki.get(c),h=u??Jn(c);u||Ki.set(c,h),s[n]=h}),dr(nt(s),t)}function Yn({graphic:i,relatedInfos:e,layer:t},s){const r={};return e.forEach((n,a)=>{n.layerInfo&&(r[a]=Zn(i,n,t,s))}),nt(r)}function Kn({relatedInfo:i,fieldName:e,fieldInfo:t}){var s,r;if((s=i.relatedFields)==null||s.push(e),t.statisticType){const n=new cr({statisticType:t.statisticType,onStatisticField:e,outStatisticFieldName:e});(r=i.outStatistics)==null||r.push(n)}}function eo(i,e){if(i!=null){e=e.toLowerCase();for(const t of i)if(t&&t.name.toLowerCase()===e)return t}return null}const es={chartAnimation:!0};let z=class extends ye{constructor(e){super(e),this.abilities={...es},this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.isAggregate=!1,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return{...es,...e}}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,s=(e+t)%t;this.activeMediaInfoIndex=s}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,s=t+e;this._setContentElementMedia(s)}_formatMediaInfos(){const{mediaInfos:e,layer:t}=this,s=this.attributes??{},r=this.formattedAttributes??{},n=this.expressionAttributes??{},a=this.fieldInfoMap??new Map;return(e==null?void 0:e.map(d=>{const c=d==null?void 0:d.clone();return c?(c.title=Qe({attributes:s,fieldInfoMap:a,globalAttributes:r,expressionAttributes:n,layer:t,text:c.title}),c.caption=Qe({attributes:s,fieldInfoMap:a,globalAttributes:r,expressionAttributes:n,layer:t,text:c.caption}),c.altText=Qe({attributes:s,fieldInfoMap:a,globalAttributes:r,expressionAttributes:n,layer:t,text:c.altText}),c.type==="image"?c.value?(this._setImageValue({value:c.value,formattedAttributes:r,layer:t}),c.value.sourceURL?c:void 0):void 0:c.type==="pie-chart"||c.type==="line-chart"||c.type==="column-chart"||c.type==="bar-chart"?c.value?(this._setChartValue({value:c.value,chartType:c.type,attributes:s,formattedAttributes:r,layer:t,expressionAttributes:n}),c):void 0:null):null}).filter(ot))??[]}_setImageValue(e){const t=this.fieldInfoMap??new Map,{value:s,formattedAttributes:r,layer:n}=e,{linkURL:a,sourceURL:d}=s;if(d){const c=Wi(d,n);s.sourceURL=Hi({formattedAttributes:r,template:c,fieldInfoMap:t})}if(a){const c=Wi(a,n);s.linkURL=Hi({formattedAttributes:r,template:c,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:s,formattedAttributes:r,chartType:n,layer:a,expressionAttributes:d}=e,{popupTemplate:c,relatedInfos:u}=this,{fields:h,normalizeField:m}=t,f=a;if(t.fields=on(h,f),m&&(t.normalizeField=ui(m,f)),!h.some(y=>!!(r[y]!=null||Ge(y)&&(u!=null&&u.size))))return;const g=(c==null?void 0:c.fieldInfos)??[];h.forEach((y,v)=>{var M;const b=(M=t.colors)==null?void 0:M[v];if(Ge(y))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:g,fieldName:y,formattedAttributes:r,chartType:n,value:t,color:b})]);const I=this._getChartOption({value:t,attributes:s,chartType:n,formattedAttributes:r,expressionAttributes:d,fieldName:y,fieldInfos:g,color:b});t.series.push(I)})}_getRelatedChartInfos(e){var y;const{fieldInfos:t,fieldName:s,formattedAttributes:r,chartType:n,value:a,color:d}=e,c=[],u=Rt(s),h=u&&((y=this.relatedInfos)==null?void 0:y.get(u.layerId.toString()));if(!h)return c;const{relatedFeatures:m,relation:f}=h;if(!f||!m)return c;const{cardinality:g}=f;return m.forEach(v=>{const{attributes:b}=v;b&&Object.keys(b).forEach(I=>{I===u.fieldName&&c.push(this._getChartOption({value:a,attributes:b,formattedAttributes:r,fieldName:s,chartType:n,relatedFieldName:I,hasMultipleRelatedFeatures:(m==null?void 0:m.length)>1,fieldInfos:t,color:d}))})}),g==="one-to-many"||g==="many-to-many"?c:[c[0]]}_getTooltip({label:e,value:t,chartType:s}){return s==="pie-chart"?`${e}`:`${e}: ${t}`}_getChartOption(e){var Q;const{value:t,attributes:s,formattedAttributes:r,expressionAttributes:n,fieldName:a,relatedFieldName:d,fieldInfos:c,chartType:u,hasMultipleRelatedFeatures:h,color:m}=e,f=this.layer,g=this.fieldInfoMap??new Map,{normalizeField:y,tooltipField:v}=t,b=y?Ge(y)?s[Rt(y).fieldName]:s[y]:null,I=qs(a)&&n&&n[a]!==void 0?n[a]:d&&s[d]!==void 0?s[d]:s[a]!==void 0?s[a]:r[a],M=new hr({fieldName:a,color:m,value:I===void 0?null:I&&b?I/b:I});if(Ge(a)){const Z=g.get(a.toLowerCase()),ve=v&&g.get(v.toLowerCase()),ne=(Z==null?void 0:Z.fieldName)??a,lt=h&&v?Rt(v).fieldName:(ve==null?void 0:ve.fieldName)??v,rr=h&&lt?s[lt]:r[lt]??(Z==null?void 0:Z.label)??(Z==null?void 0:Z.fieldName)??d,nr=h&&d?s[d]:r[ne];return M.tooltip=this._getTooltip({label:rr,value:nr,chartType:u}),M}const E=an(c,a),N=ui(a,f),D=v&&r[v]!==void 0?r[v]:Bs(E||new Cs({fieldName:N}),(Q=this.popupTemplate)==null?void 0:Q.expressionInfos),O=r[N];return M.tooltip=this._getTooltip({label:D,value:O,chartType:u}),M}};o([l()],z.prototype,"abilities",void 0),o([at("abilities")],z.prototype,"castAbilities",null),o([l()],z.prototype,"activeMediaInfoIndex",void 0),o([l({readOnly:!0})],z.prototype,"activeMediaInfo",null),o([l()],z.prototype,"attributes",void 0),o([l()],z.prototype,"description",void 0),o([l()],z.prototype,"fieldInfoMap",void 0),o([l()],z.prototype,"formattedAttributes",void 0),o([l()],z.prototype,"expressionAttributes",void 0),o([l({readOnly:!0})],z.prototype,"formattedMediaInfos",null),o([l()],z.prototype,"isAggregate",void 0),o([l()],z.prototype,"layer",void 0),o([l({readOnly:!0})],z.prototype,"formattedMediaInfoCount",null),o([l()],z.prototype,"mediaInfos",void 0),o([l()],z.prototype,"popupTemplate",void 0),o([l()],z.prototype,"relatedInfos",void 0),o([l()],z.prototype,"title",void 0),z=o([k("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],z);const Ze=z,H="esri-feature-media",oe={base:H,mediaContainer:`${H}__container`,mediaItemContainer:`${H}__item-container`,mediaItem:`${H}__item`,mediaItemText:`${H}__item-text`,mediaItemTitle:`${H}__item-title`,mediaItemCaption:`${H}__item-caption`,mediaNavigation:`${H}__item-navigation`,mediaPagination:`${H}__pagination`,mediaPaginationText:`${H}__pagination-text`,mediaPrevious:`${H}__previous`,mediaPreviousIconLTR:`${H}__previous-icon`,mediaPreviousIconRTL:`${H}__previous-icon--rtl`,mediaNext:`${H}__next`,mediaNextIconLTR:`${H}__next-icon`,mediaNextIconRTL:`${H}__next-icon--rtl`,mediaChart:`${H}__chart`,mediaPaginationButton:`${H}__pagination-button`,mediaPaginationIcon:`${H}__pagination-icon`,mediaChartRendered:`${H}__chart--rendered`},si=15,xe="category",dt="value",to="rgba(50, 50, 50, 1)",io=250,so=500,ro=200;let le=class extends he{constructor(i,e){super(i,e),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this._chartRootMap=new WeakMap,this.viewModel=new Ze,this.messages=null,this._disposeChart=t=>{var s;(s=this._chartRootMap.get(t))==null||s.dispose(),this._chartRootMap.delete(t)},this._createChart=async t=>{const{destroyed:s,viewModel:r}=this;if(s||!r||!t)return;const{createRoot:n}=await _(()=>import("./chartUtilsAm5-B8aRUWru.js"),__vite__mapDeps([2,0,1,3,4,5]),import.meta.url),a=await n(t);this._chartRootMap.set(t,a),this._renderChart({mediaInfo:r.activeMediaInfo,root:a})}}initialize(){this._featureElementInfo=new It,this.addHandles([w(()=>{var i,e;return[(i=this.viewModel)==null?void 0:i.activeMediaInfo,(e=this.viewModel)==null?void 0:e.activeMediaInfoIndex]},()=>this._setupMediaRefreshTimer(),P),w(()=>{var i,e;return[(i=this.viewModel)==null?void 0:i.description,(e=this.viewModel)==null?void 0:e.title]},()=>this._setupFeatureElementInfo(),P)])}loadDependencies(){return Fe({icon:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vV),__vite__mapDeps([0,1]),import.meta.url)})}destroy(){var i;this._clearMediaRefreshTimer(),(i=this._featureElementInfo)==null||i.destroy()}get attributes(){return this.viewModel.attributes}set attributes(i){this.viewModel.attributes=i}get activeMediaInfoIndex(){return this.viewModel.activeMediaInfoIndex}set activeMediaInfoIndex(i){this.viewModel.activeMediaInfoIndex=i}get description(){return this.viewModel.description}set description(i){this.viewModel.description=i}get fieldInfoMap(){return this.viewModel.fieldInfoMap}set fieldInfoMap(i){this.viewModel.fieldInfoMap=i}get layer(){return this.viewModel.layer}set layer(i){this.viewModel.layer=i}get mediaInfos(){return this.viewModel.mediaInfos}set mediaInfos(i){this.viewModel.mediaInfos=i}get popupTemplate(){return this.viewModel.popupTemplate}set popupTemplate(i){this.viewModel.popupTemplate=i}get relatedInfos(){return this.viewModel.relatedInfos}set relatedInfos(i){this.viewModel.relatedInfos=i}get title(){return this.viewModel.title}set title(i){this.viewModel.title=i}render(){var i;return p("div",{bind:this,class:oe.base,onkeyup:this._handleMediaKeyup},(i=this._featureElementInfo)==null?void 0:i.render(),this._renderMedia())}_renderMedia(){const{formattedMediaInfoCount:i,activeMediaInfoIndex:e}=this.viewModel,t=this._renderMediaText();return i?p("div",{class:oe.mediaContainer,key:"media-element-container"},this._renderMediaInfo(),p("div",{class:oe.mediaNavigation},t,i>1?p("div",{class:oe.mediaPagination},this._renderMediaPageButton("previous"),p("span",{class:oe.mediaPaginationText},me(this.messages.pageText,{index:e+1,total:i})),this._renderMediaPageButton("next")):null)):null}_renderMediaText(){const{activeMediaInfo:i}=this.viewModel;if(!i)return null;const e=i&&i.title?p("div",{class:oe.mediaItemTitle,innerHTML:i.title,key:"media-title"}):null,t=i&&i.caption?p("div",{class:oe.mediaItemCaption,innerHTML:i.caption,key:"media-caption"}):null;return e||t?p("div",{class:oe.mediaItemText,key:"media-text"},e,t):null}_renderImageMediaInfo(i){if(!i.value)return null;const{_refreshIntervalInfo:e}=this,{activeMediaInfoIndex:t,formattedMediaInfoCount:s}=this.viewModel,{value:r,refreshInterval:n,altText:a,title:d,type:c}=i,{sourceURL:u,linkURL:h}=r,m=Ds(h??void 0)?"_blank":"_self",f=m==="_blank"?"noreferrer":"",g=n?e:null,y=g?g.timestamp:0,v=g?g.sourceURL:u,b=p("img",{alt:a||d,key:`media-${c}-${t}-${s}-${y}`,src:v??void 0});return(h?p("a",{href:h,rel:f,target:m,title:d},b):null)??b}_renderChartMediaInfo(i){const{activeMediaInfoIndex:e,formattedMediaInfoCount:t}=this.viewModel;return p("div",{afterCreate:this._createChart,afterRemoved:this._disposeChart,bind:this,class:oe.mediaChart,key:`media-${i.type}-${e}-${t}`})}_renderMediaInfoType(){const{activeMediaInfo:i}=this.viewModel;return i?i.type==="image"?this._renderImageMediaInfo(i):i.type.includes("chart")?this._renderChartMediaInfo(i):null:null}_renderMediaInfo(){const{activeMediaInfo:i}=this.viewModel;return i?p("div",{class:oe.mediaItemContainer,key:"media-container"},p("div",{class:oe.mediaItem,key:"media-item-container"},this._renderMediaInfoType())):null}_renderMediaPageButton(i){if(this.viewModel.formattedMediaInfoCount<2)return null;const e=i==="previous",t=e?this.messages.previous:this.messages.next,s=e?"chevron-left":"chevron-right",r=e?"media-previous":"media-next",n=e?this._previous:this._next;return p("button",{"aria-label":t,bind:this,class:oe.mediaPaginationButton,key:r,onclick:n,tabIndex:0,title:t,type:"button"},p("calcite-icon",{class:oe.mediaPaginationIcon,icon:s,scale:"s"}))}_setupFeatureElementInfo(){var t;const{description:i,title:e}=this;(t=this._featureElementInfo)==null||t.set({description:i,title:e})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}_getRenderer(){if(!this.viewModel)return;const{isAggregate:i,layer:e}=this.viewModel;return i&&(e!=null&&e.featureReduction)&&"renderer"in e.featureReduction?e.featureReduction.renderer:e==null?void 0:e.renderer}async _getSeriesColors(i){const{colorAm5:e}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),t=new Map;return i.forEach(s=>{s.color&&t.set(s,e(s.color.toCss(!0)))}),t}async _getRendererColors(){const{colorAm5:i}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),e=new Map,t=this._getRenderer(),s="default";if(!t)return e;const r=await vn(t);return r.delete(s),Array.from(r.values()).every(n=>(n==null?void 0:n.length)===1)&&Array.from(r.keys()).forEach(n=>{var d,c;const a=(c=(d=r.get(n))==null?void 0:d[0])==null?void 0:c.toCss(!0);a&&e.set(n,i(a))}),e}_handleMediaKeyup(i){const{key:e}=i;e==="ArrowLeft"&&(i.stopPropagation(),this.viewModel.previous()),e==="ArrowRight"&&(i.stopPropagation(),this.viewModel.next())}_canAnimateChart(){return!!this.viewModel&&!!this.viewModel.abilities.chartAnimation&&!pr()}_getChartAnimationMS(){return this._canAnimateChart()?io:0}_getChartSeriesAnimationMS(){return this._canAnimateChart()?so:0}async _renderChart(i){const{root:e,mediaInfo:t}=i,{value:s,type:r}=t,{ResponsiveThemeAm5:n,DarkThemeAm5:a,AnimatedThemeAm5:d,ColorSetAm5:c,ThemeAm5:u,esriChartColorSet:h}=await _(async()=>{const{ResponsiveThemeAm5:E,DarkThemeAm5:N,AnimatedThemeAm5:D,ColorSetAm5:O,ThemeAm5:Q,esriChartColorSet:Z}=await import("./chartCommon-Bc-L_8SO.js");return{ResponsiveThemeAm5:E,DarkThemeAm5:N,AnimatedThemeAm5:D,ColorSetAm5:O,ThemeAm5:Q,esriChartColorSet:Z}},__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),m=u.new(e);m.rule("ColorSet").set("colors",h),m.rule("ColorSet").set("reuse",!0);const f=[n.new(e),m];mr()&&f.push(a.new(e)),this._canAnimateChart()&&f.push(d.new(e)),e.setThemes(f);const g=await this._getRendererColors(),y=await this._getSeriesColors(s.series),v=c.new(e,{}),b=y.get(s.series[0]),I=b?{lineSettings:{stroke:b}}:void 0,M=s.series.map((E,N)=>{const D=y.get(E)||g.get(E.fieldName)||v.getIndex(N);return{[xe]:E.tooltip,[dt]:E.value,columnSettings:{fill:D,stroke:D},...I}}).filter(E=>r!=="pie-chart"||E.value!=null&&E.value>0);r==="pie-chart"?this._createPieChart(i,M):this._createXYChart(i,M)}_getDirection(){return $e(this.container)?"rtl":"ltr"}async _customizeChartTooltip(i,e="horizontal"){var s;const{colorAm5:t}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url);i.setAll({pointerOrientation:e}),(s=i.get("background"))==null||s.setAll({stroke:t(to)}),i.label.setAll({direction:this._getDirection(),oversizedBehavior:"wrap",maxWidth:ro})}async _createPieChart(i,e){const{TooltipAm5:t}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),{PieChartAm5:s,PieSeriesAm5:r}=await _(async()=>{const{PieChartAm5:y,PieSeriesAm5:v}=await import("./pieChart-Dk8DFZ8L.js");return{PieChartAm5:y,PieSeriesAm5:v}},__vite__mapDeps([9,0,1,10,3,8,5]),import.meta.url),{mediaInfo:n,root:a}=i,{title:d}=n,c=5,u=(n==null?void 0:n.altText)||(n==null?void 0:n.title)||"",h=a.container.children.push(s.new(a,{ariaLabel:u,focusable:!0,paddingBottom:c,paddingTop:c,paddingLeft:c,paddingRight:c})),m=`{category}: {valuePercentTotal.formatNumber('0.00')}%
 ({value})`,f=t.new(a,{labelText:m}),g=h.series.push(r.new(a,{name:d,valueField:dt,categoryField:xe,tooltip:f}));g.ticks.template.set("forceHidden",!0),g.labels.template.set("forceHidden",!0),g.slices.template.states.create("active",{shiftRadius:c}),this._customizeChartTooltip(f),g.slices.template.setAll({ariaLabel:m,focusable:!0,templateField:"columnSettings"}),g.data.setAll(e),g.appear(this._getChartSeriesAnimationMS()),h.appear(this._getChartAnimationMS()),h.root.dom.classList.toggle(oe.mediaChartRendered,!0)}_getMinSeriesValue(i){let e=0;return i.forEach(t=>e=Math.min(t.value,e)),e}async _createColumnChart(i,e,t){const{TooltipAm5:s,ScrollbarAm5:r}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),{CategoryAxisAm5:n,AxisRendererXAm5:a,ValueAxisAm5:d,AxisRendererYAm5:c,ColumnSeriesAm5:u}=await _(async()=>{const{CategoryAxisAm5:E,AxisRendererXAm5:N,ValueAxisAm5:D,AxisRendererYAm5:O,ColumnSeriesAm5:Q}=await import("./xyChart-BJ8FDUCJ.js");return{CategoryAxisAm5:E,AxisRendererXAm5:N,ValueAxisAm5:D,AxisRendererYAm5:O,ColumnSeriesAm5:Q}},__vite__mapDeps([11,3,0,1,8,5,10,7]),import.meta.url),{mediaInfo:h,root:m}=e,{value:f,title:g}=h;i.setAll({wheelX:"panX",wheelY:"zoomX"});const y=i.xAxes.push(n.new(m,{renderer:a.new(m,{inversed:$e(this.container)}),categoryField:xe}));y.get("renderer").labels.template.setAll({forceHidden:!0});const v=i.yAxes.push(d.new(m,{renderer:c.new(m,{inside:!1}),min:this._getMinSeriesValue(f.series)}));v.get("renderer").labels.template.setAll({direction:this._getDirection()});const b="{categoryX}",I=s.new(m,{labelText:b}),M=i.series.push(u.new(m,{name:g,xAxis:y,yAxis:v,valueYField:dt,categoryXField:xe,tooltip:I}));this._customizeChartTooltip(I),M.columns.template.setAll({ariaLabel:b,focusable:!0,templateField:"columnSettings"}),f.series.length>si&&i.set("scrollbarX",r.new(m,{orientation:"horizontal"})),y.data.setAll(t),M.data.setAll(t),M.appear(this._getChartSeriesAnimationMS()),i.appear(this._getChartAnimationMS())}async _createBarChart(i,e,t){const{TooltipAm5:s,ScrollbarAm5:r}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),{CategoryAxisAm5:n,AxisRendererXAm5:a,ValueAxisAm5:d,AxisRendererYAm5:c,ColumnSeriesAm5:u}=await _(async()=>{const{CategoryAxisAm5:E,AxisRendererXAm5:N,ValueAxisAm5:D,AxisRendererYAm5:O,ColumnSeriesAm5:Q}=await import("./xyChart-BJ8FDUCJ.js");return{CategoryAxisAm5:E,AxisRendererXAm5:N,ValueAxisAm5:D,AxisRendererYAm5:O,ColumnSeriesAm5:Q}},__vite__mapDeps([11,3,0,1,8,5,10,7]),import.meta.url),{mediaInfo:h,root:m}=e,{value:f,title:g}=h;i.setAll({wheelX:"panY",wheelY:"zoomY"});const y=i.yAxes.push(n.new(m,{renderer:c.new(m,{inversed:!0}),categoryField:xe}));y.get("renderer").labels.template.setAll({forceHidden:!0});const v=i.xAxes.push(d.new(m,{renderer:a.new(m,{inside:!1,inversed:$e(this.container)}),min:this._getMinSeriesValue(f.series)}));v.get("renderer").labels.template.setAll({direction:this._getDirection()});const b="{categoryY}",I=s.new(m,{labelText:b}),M=i.series.push(u.new(m,{name:g,xAxis:v,yAxis:y,valueXField:dt,categoryYField:xe,tooltip:I}));this._customizeChartTooltip(I,"vertical"),M.columns.template.setAll({ariaLabel:b,focusable:!0,templateField:"columnSettings"}),f.series.length>si&&i.set("scrollbarY",r.new(m,{orientation:"vertical"})),y.data.setAll(t),M.data.setAll(t),M.appear(this._getChartSeriesAnimationMS()),i.appear(this._getChartAnimationMS())}async _createLineChart(i,e,t){var N,D,O;const{TooltipAm5:s,ScrollbarAm5:r}=await _(()=>import("./chartCommon-Bc-L_8SO.js"),__vite__mapDeps([6,3,0,1,7,4,8]),import.meta.url),{CategoryAxisAm5:n,AxisRendererXAm5:a,ValueAxisAm5:d,AxisRendererYAm5:c,LineSeriesAm5:u}=await _(async()=>{const{CategoryAxisAm5:Q,AxisRendererXAm5:Z,ValueAxisAm5:ve,AxisRendererYAm5:ne,LineSeriesAm5:lt}=await import("./xyChart-BJ8FDUCJ.js");return{CategoryAxisAm5:Q,AxisRendererXAm5:Z,ValueAxisAm5:ve,AxisRendererYAm5:ne,LineSeriesAm5:lt}},__vite__mapDeps([11,3,0,1,8,5,10,7]),import.meta.url),{root:h,mediaInfo:m}=e,{value:f,title:g}=m;i.setAll({wheelX:"panX",wheelY:"zoomX"});const y=i.xAxes.push(n.new(h,{renderer:a.new(h,{inversed:$e(this.container)}),categoryField:xe}));y.get("renderer").labels.template.setAll({forceHidden:!0});const v=i.yAxes.push(d.new(h,{renderer:c.new(h,{inside:!1}),min:this._getMinSeriesValue(f.series)}));v.get("renderer").labels.template.setAll({direction:this._getDirection()});const b="{categoryX}",I=(D=(N=t[0])==null?void 0:N.lineSettings)==null?void 0:D.stroke,M=s.new(h,{getFillFromSprite:!I,labelText:b});I&&((O=M.get("background"))==null||O.setAll({fill:I}));const E=i.series.push(u.new(h,{name:g,xAxis:y,yAxis:v,valueYField:dt,categoryXField:xe,tooltip:M}));E.strokes.template.setAll({templateField:"lineSettings"}),this._customizeChartTooltip(M,"vertical"),f.series.length>si&&i.set("scrollbarX",r.new(h,{orientation:"horizontal"})),y.data.setAll(t),E.data.setAll(t),E.appear(this._getChartSeriesAnimationMS()),i.appear(this._getChartAnimationMS())}async _createXYChart(i,e){const{XYChartAm5:t,XYCursorAm5:s}=await _(()=>import("./xyChart-BJ8FDUCJ.js"),__vite__mapDeps([11,3,0,1,8,5,10,7]),import.meta.url),{root:r,mediaInfo:n}=i,{type:a}=n,d=(n==null?void 0:n.altText)||(n==null?void 0:n.title)||"",c=r.container.children.push(t.new(r,{ariaLabel:d,focusable:!0,panX:!0,panY:!0}));c.set("cursor",s.new(r,{})),a==="column-chart"&&await this._createColumnChart(c,i,e),a==="bar-chart"&&await this._createBarChart(c,i,e),a==="line-chart"&&await this._createLineChart(c,i,e),c.root.dom.classList.toggle(oe.mediaChartRendered,!0)}_clearMediaRefreshTimer(){const{_refreshTimer:i}=this;i&&(clearTimeout(i),this._refreshTimer=null)}_updateMediaInfoTimestamp(i){const e=Date.now();this._refreshIntervalInfo={timestamp:e,sourceURL:i&&this._getImageSource(i,e)}}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:i}=this.viewModel;(i==null?void 0:i.type)==="image"&&(i==null?void 0:i.refreshInterval)>0&&this._setRefreshTimeout(i)}_setRefreshTimeout(i){const{refreshInterval:e,value:t}=i,s=6e4*e;this._updateMediaInfoTimestamp(t.sourceURL);const r=setInterval(()=>{this._updateMediaInfoTimestamp(t.sourceURL)},s);this._refreshTimer=r}_getImageSource(i,e){const t=i.includes("?")?"&":"?",[s,r=""]=i.split("#");return`${s}${t}timestamp=${e}${r?"#":""}${r}`}};o([l()],le.prototype,"_refreshIntervalInfo",void 0),o([l()],le.prototype,"attributes",null),o([l()],le.prototype,"activeMediaInfoIndex",null),o([l()],le.prototype,"description",null),o([l()],le.prototype,"fieldInfoMap",null),o([l()],le.prototype,"layer",null),o([l()],le.prototype,"mediaInfos",null),o([l()],le.prototype,"popupTemplate",null),o([l()],le.prototype,"relatedInfos",null),o([l()],le.prototype,"title",null),o([l({type:Ze})],le.prototype,"viewModel",void 0),o([l(),re("esri/widgets/Feature/t9n/Feature")],le.prototype,"messages",void 0),le=o([k("esri.widgets.Feature.FeatureMedia")],le);const Ws=le,no="esri.widgets.Feature.support.arcadeFeatureUtils",ri=()=>se.getLogger(no);function oo(i){return typeof i=="string"?Ii(Mi(i)):Array.isArray(i)?ao(i):(i==null?void 0:i.declaredClass)==="esri.arcade.Dictionary"?lo(i):i}function ao(i){return`<ul class="esri-widget__list">${i.map(e=>`<li>${typeof e=="string"?Ii(Mi(e)):e}</li>`).join("")}</ul>`}function lo(i){const e=i.keys().map(t=>{const s=i.field(t);return`<tr><th>${t}</th><td>${typeof s=="string"?Ii(Mi(s)):s}</td></tr>`}).join("");return`<table class="${T.table}">${e}</table>`}async function Hs(){const[i,e]=await Promise.all([_(()=>import("./arcade-BCRykBCV.js"),__vite__mapDeps([12,0,1,13,14,15,16]),import.meta.url),_(()=>import("./arcade-BdhEvfAc.js").then(t=>t.w),__vite__mapDeps([17,0,1,14,13,15,16,18,19]),import.meta.url)]);return{executor:i,syntaxUtils:e}}function co(i){return"createQuery"in i&&"queryFeatures"in i}async function uo({graphic:i,view:e,options:t}){const{isAggregate:s,layer:r}=i;if(!s||!r||(e==null?void 0:e.type)!=="2d")return[];const n=await e.whenLayerView(r);if(!co(n))return[];const a=n.createQuery(),d=i.getObjectId();a.aggregateIds=d!=null?[d]:[];const{features:c}=await n.queryFeatures(a,t);return c}function ho({layer:i,aggregatedFeatures:e,interceptor:t}){const{fields:s,objectIdField:r,geometryType:n,spatialReference:a,displayField:d}=i;return new gr({fields:s,objectIdField:r,geometryType:n,spatialReference:a,displayField:d,interceptor:t,...i.type==="feature"?{templates:i.templates,typeIdField:i.typeIdField,types:i.types}:null,source:e})}function po(i){const e=i.declaredClass==="esri.views.3d.layers.VoxelGraphic";return i.isAggregate?"popup-feature-reduction":e?"popup-voxel":"popup"}function zs(i){var e,t;return{scale:i==null?void 0:i.scale,timeProperties:{currentStart:(e=i==null?void 0:i.timeExtent)==null?void 0:e.start,currentEnd:(t=i==null?void 0:i.timeExtent)==null?void 0:t.end,startIncluded:!0,endIncluded:!0}}}function mo(i){return{$voxel:i}}async function go(i,e,t,s,r){let n=null;if(r.has("$aggregatedfeatures")){const a=await uo({graphic:i,view:e,options:t}),d=i.sourceLayer||i.layer;n=ho({layer:d,aggregatedFeatures:a,interceptor:s})}return{vars:{$feature:i,$aggregatedFeatures:n,$view:zs(e)},[Symbol.dispose]:()=>n==null?void 0:n[Symbol.dispose]()}}function fo(i,e,t,s){var n;const r=(i.sourceLayer||i.layer)??void 0;return{$feature:i,$layer:r!=null&&_n(r)?r:(r==null?void 0:r.type)==="scene"&&r.associatedLayer!=null?r.associatedLayer:void 0,$map:e,$datastore:r==null?void 0:r.url,$userInput:t,$graph:(r==null?void 0:r.type)==="knowledge-graph-sublayer"?(n=r==null?void 0:r.parentCompositeLayer)==null?void 0:n.knowledgeGraph:void 0,$view:zs(s)}}async function yo(i,{graphic:e,map:t,location:s,view:r,options:n,interceptor:a,arcadeExecutor:d}){switch(i){case"popup":return{vars:fo(e,t,s,r),[Symbol.dispose](){}};case"popup-feature-reduction":{const c=new Set(d.variablesUsed);return await go(e,r,n,a,c)}case"popup-voxel":return{vars:mo(e),[Symbol.dispose](){}};default:throw new Error(`Unexpected profile name ${i}`)}}async function Gs({expressionInfo:i,arcade:{executor:e,syntaxUtils:t},graphic:s}){const r=i==null?void 0:i.expression;if(!r)return null;const n=po(s),a=e.createArcadeProfile(n);let d;try{d=await e.createArcadeExecutor(r,a)}catch(u){return ri().error("arcade-executor-error",{error:u,expressionInfo:i}),null}const c=new Set;return d.variablesUsed.includes("$view")&&(t.scriptUsesViewProperties(d.syntaxTree,["scale"])&&c.add("view-scale"),t.scriptUsesViewProperties(d.syntaxTree,["timeProperties"])&&c.add("view-time-extent")),{dependencies:c,async evaluate({graphic:u,interceptor:h,location:m,map:f,options:g,spatialReference:y,view:v}){const b=await yo(n,{graphic:u,map:f,location:m,view:v,options:g,interceptor:h,arcadeExecutor:d}),I={abortSignal:(g==null?void 0:g.signal)??void 0,interceptor:h??void 0,rawOutput:!0,spatialReference:y??void 0,timeZone:v==null?void 0:v.timeZone,console(...M){ri().info(...M)}};try{return await d.executeAsync(b.vars,I)}catch(M){return void ri().error("arcade-execution-error",{error:M,graphic:u,expressionInfo:i})}finally{b[Symbol.dispose]()}}}}async function vo(i,e){if(!(i!=null&&i.length))return{dependencies:new Set,expressions:new Map};const t=await Hs(),s=new Set,r=new Map;for(const n of i){const a=await Gs({expressionInfo:n,arcade:t,graphic:e});r.set(`expression/${n.name}`,a),a==null||a.dependencies.forEach(d=>s.add(d))}return{dependencies:s,expressions:r}}const ts=1;let de=class extends ye{constructor(e){super(e),this._compileTask=null,this._evaluateTask=null,this.expressionInfo=null,this.graphic=null,this.contentElementViewModel=null,this.interceptor=null,this.location=null,this.view=null,this._createVM=()=>{var r,n;const t=(r=this.contentElement)==null?void 0:r.type;(n=this.contentElementViewModel)==null||n.destroy();const s=t==="fields"?new Qt:t==="media"?new Ze:t==="text"?new Wt:null;this._set("contentElementViewModel",s)},this._compileThrottled=_t(this._startCompile,()=>this.notifyChange("state"),ts,this),this._evaluateThrottled=_t(this._startEvaluate,()=>this.notifyChange("state"),ts,this),this.addHandles([w(()=>[this.expressionInfo,this.graphic],()=>this._compileThrottled(),P),w(()=>[this.contentElement],()=>this._createVM(),P),Je(()=>{var r,n,a,d,c,u;if(!((r=this._compileTask)!=null&&r.finished))return null;const t=this._compileTask.value,s=t==null?void 0:t.dependencies;return[t,this.spatialReference,this.map,this.view,s!=null&&s.has("view-scale")?(n=this.view)==null?void 0:n.scale:null,s!=null&&s.has("view-time-extent")?(d=(a=this.view)==null?void 0:a.timeExtent)==null?void 0:d.start:null,s!=null&&s.has("view-time-extent")?(u=(c=this.view)==null?void 0:c.timeExtent)==null?void 0:u.end:null]},([t])=>this._evaluateThrottled(t))])}initialize(){this.addHandles([this._compileThrottled,this._evaluateThrottled])}destroy(){var e;this._compileTask=Ae(this._compileTask),this._evaluateTask=Ae(this._evaluateTask),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null)}get contentElement(){var e;return(e=this._evaluateTask)==null?void 0:e.value}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){var s,r;const{contentElement:e,contentElementViewModel:t}=this;return this._compileThrottled.hasPendingUpdates()||this._evaluateThrottled.hasPendingUpdates()||!((s=this._compileTask)!=null&&s.finished)||!((r=this._evaluateTask)!=null&&r.finished)?"loading":e||t?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)??null}set map(e){this._override("map",e)}_startCompile(){this._evaluateTask=Ae(this._evaluateTask),this._compileTask=Ae(this._compileTask),this._compileTask=Bt(async e=>{const{expressionInfo:t,graphic:s}=this;if(!t||!s)return null;const r=await Hs();ze(e);const n=await Gs({expressionInfo:t,arcade:r,graphic:s});return ze(e),n})}_startEvaluate(e){this._evaluateTask=Ae(this._evaluateTask),this._evaluateTask=Bt(async t=>{const{graphic:s}=this;if(!e||!s)return null;const{interceptor:r,spatialReference:n,map:a,location:d,view:c}=this,u=await e.evaluate({graphic:s,interceptor:r,location:d,map:a,options:{signal:t},spatialReference:n,view:c});ze(t);const h=u;if(!h||h.declaredClass!=="esri.arcade.Dictionary")return null;const m=await h.castAsJsonAsync(t);ze(t);const f=m==null?void 0:m.type,g=f==="media"?yr.fromJSON(m):f==="text"?Ts.fromJSON(m):f==="fields"?vr.fromJSON(m):null;return g.type==="media"&&!g.mediaInfos||g.type==="fields"&&!g.fieldInfos||g.type==="text"&&!g.text?null:g})}};o([l()],de.prototype,"_compileTask",void 0),o([l()],de.prototype,"_evaluateTask",void 0),o([l({type:fr})],de.prototype,"expressionInfo",void 0),o([l({type:Ye})],de.prototype,"graphic",void 0),o([l({readOnly:!0})],de.prototype,"contentElement",null),o([l({readOnly:!0})],de.prototype,"contentElementViewModel",void 0),o([l()],de.prototype,"interceptor",void 0),o([l({type:yi})],de.prototype,"location",void 0),o([l()],de.prototype,"spatialReference",null),o([l({readOnly:!0})],de.prototype,"state",null),o([l()],de.prototype,"map",null),o([l()],de.prototype,"view",void 0),de=o([k("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],de);const Ei=de,is="esri-feature",ss={base:`${is}-expression`,loadingSpinnerContainer:`${is}__loading-container`};let Ot=class extends he{constructor(e,t){super(e,t),this._contentWidget=null,this.viewModel=new Ei}initialize(){this.addHandles(w(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentElementViewModel},()=>this._setupExpressionWidget(),P))}loadDependencies(){return Fe({loader:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vU),__vite__mapDeps([0,1]),import.meta.url)})}destroy(){this._destroyContentWidget()}render(){var t;const{state:e}=this.viewModel;return p("div",{class:ss.base},e==="loading"?this._renderLoading():e==="disabled"?null:(t=this._contentWidget)==null?void 0:t.render())}_renderLoading(){return p("div",{class:ss.loadingSpinnerContainer,key:"loading-container"},p("calcite-loader",{inline:!0,label:""}))}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:t}=this.viewModel,s=t==null?void 0:t.type;this._destroyContentWidget();const r=e?s==="fields"?new js({viewModel:e}):s==="media"?new Ws({viewModel:e}):s==="text"?new St({viewModel:e}):null:null;this._contentWidget=r,this.scheduleRender()}};o([l({type:Ei})],Ot.prototype,"viewModel",void 0),Ot=o([k("esri.widgets.Feature.FeatureExpression")],Ot);const _o=Ot;var rs,ns;(function(i){i.Text="text",i.Number="number",i.Date="date",i.Unsupported="unsupported"})(rs||(rs={})),function(i){i.CANNOT_BE_EMPTY="input-validation-error::cannot-be-empty",i.TOO_SHORT="length-validation-error::too-short",i.TOO_LONG="length-validation-error::too-long"}(ns||(ns={}));const wo=new _r({"{acd53634-cbc7-44d5-bde9-692fa8d45850}":"autocomplete-freehand-polygons","{6f5fc612-d1ef-4d32-a2e1-18a1cb22331c}":"autocomplete-polygons","{09c6f589-a3ce-48ab-81bc-46965c58f264}":"circle","{bccf295a-9c64-4adc-903e-62d827c10ef7}":"create-points-along-line","{756cadf6-91e6-04b1-2938-e172a97af51c}":"create-structures","{ddbe4c0c-063f-8b60-b2da-b349a1e42e84}":"difference-polygon","{a5f4db5f-4a6b-29bd-1f32-9d81bf262c76}":"elevation-point-from-contour","{285ec4bb-60a8-7184-2088-5bee2149f2a4}":"elevation-point-from-dem","{28c04532-3daf-4d3d-b7be-a589c9c9a03e}":"ellipse","{0a7c16b9-1cfd-467f-8ece-6ba376192431}":"freehand","{af2dbf8f-280e-44db-8860-e399d0b30cf1}":"line","{bc485127-2ea2-4c8b-85ef-e8237959eb64}":"multipoint","{d304243a-5c3a-4ccc-b98b-93684b15fd83}":"parcel-seed","{2a8b3331-5238-4025-972e-452a69535b06}":"point","{d376f8e5-69e0-4273-9478-724e9e0d81ac}":"point-and-rotation","{93ce7077-f09e-455e-ade7-b7413cddc393}":"point-at-end-of-line","{8f79967b-66a0-4a1c-b884-f44bc7e26921}":"polygon","{a947ba80-1c29-4bcd-8672-1963b7b9dde0}":"radial-line","{6f0ed2cc-c099-4895-bd7e-beec2f78adbf}":"rectangle","{a281e635-0f22-47d4-a438-e4d29b920e22}":"regular-polygon","{5664cae4-c7de-432a-9933-9586bc15ed39}":"regular-polyline","{c5c42e29-44da-4a1c-8688-e02c07535bc3}":"right-angle-line","{ee16991b-6303-4a8a-9143-1914b2010c1a}":"right-angle-polygon","{7d3e17cf-30dd-4593-9bd8-0b2b8770f52a}":"split","{e00209dd-05c5-4424-be62-51581f9f811d}":"stream-line","{6c6970a7-5ca9-448c-9c7d-0d716cd2ac64}":"stream-polygon","{e22f7d98-007d-427c-8282-13704f7c84c3}":"trace","{6cf59352-8e14-402c-8f4c-ed72647f5e42}":"two-point-line"});let q=class extends vi{constructor(e){super(e),this.type="feature",this.templateId=null,this.defaultTool=null,this.description=null,this.globalId="",this.hash="",this.layerIds=[],this.name="",this.subtypeCode=null,this.status=null,this.userIdentity=null,this.tags=[],this.visible=!0}readThumbnail(e){return e==null||e===""?null:{contentType:"png",imageData:e,height:64,width:64}}readDefaultTool(e){return e==null?null:wo.fromJSON(e.toLowerCase())}readLayerIds(e,t){return t.layerIds!=null?t.layerIds.split(",").map(s=>parseInt(s.trim(),10)):t.layerId!=null?[t.layerId]:[]}readTags(e,t){const s=t.tag;return s==null?[]:s.split(";").map(r=>r.trim())}};o([l()],q.prototype,"type",void 0),o([l({json:{read:!1,write:!1}})],q.prototype,"featureService",void 0),o([l()],q.prototype,"thumbnail",void 0),o([Re("thumbnail")],q.prototype,"readThumbnail",null),o([l()],q.prototype,"templateId",void 0),o([l()],q.prototype,"defaultTool",void 0),o([Re("defaultTool")],q.prototype,"readDefaultTool",null),o([l()],q.prototype,"description",void 0),o([l()],q.prototype,"globalId",void 0),o([l()],q.prototype,"hash",void 0),o([l()],q.prototype,"layerIds",void 0),o([Re("layerIds",["layerIds","layerId"])],q.prototype,"readLayerIds",null),o([l()],q.prototype,"name",void 0),o([l({json:{name:"subtype"}})],q.prototype,"subtypeCode",void 0),o([l()],q.prototype,"status",void 0),o([l()],q.prototype,"userIdentity",void 0),o([l()],q.prototype,"tags",void 0),o([Re("tags",["tag"])],q.prototype,"readTags",null),o([l()],q.prototype,"visible",void 0),q=o([k("esri.editing.sharedTemplates.SharedTemplateMetadata")],q);const bo=q;async function Io({serviceUrl:i,query:e,requestOptions:t={}}){if(e.layers==null&&e.templateIds==null)throw new A("query-shared-templates:invalid-parameters","Must supply a value for either the 'layers' or the 'templateIds' parameters");const s=wr(i,"sharedTemplates","query"),r={f:"json",...t.query,...e};r.layers&&(r.layers=ni(r.layers)),r.templateIds&&(r.templateIds=ni(r.templateIds)),r.tags&&(r.tags=ni(r.tags));const n={...t,responseType:"json",query:r};return(await He(s,n)).data.templates}function ni(i){return Array.isArray(i)?i.join(","):""}function Et(i,e){const t=e.id;return{id:t,name:e.name,url:`${i}/${t}`,type:e.type||"Table"}}function Mo(i){return{data:Ao(i),sync:To(i),operations:Fo(i.capabilities,i),query:Co(i),editing:Eo(i)}}function Ao(i){return{isDataVersioned:be(i,"hasVersionedData",!1),isDataBranchVersioned:be(i,"hasBranchVersionedData",!1)}}function Fo(i,e){const t=i?i.toLowerCase().split(",").map(c=>c.trim()):[],s=t.includes("query"),r=t.includes("editing")&&!e.datesInUnknownTimezone;let n=r&&t.includes("create"),a=r&&t.includes("delete"),d=r&&t.includes("update");return r&&!(n||a||d)&&(n=a=d=!0),{supportsAdd:n,supportsDelete:a,supportsEditing:r,supportsChangeTracking:t.includes("changetracking"),supportsQuery:s,supportsQueryDataElements:be(e,"supportsQueryDataElements",!1),supportsQueryDomains:be(e,"supportsQueryDomains",!1),supportsQueryContingentValues:be(e,"supportsQueryContingentValues",!1),supportsSync:t.includes("sync"),supportsUpdate:d}}function Co(i){return{maxRecordCountFactor:Oi(i,"maxRecordCountFactor",void 0),maxRecordCount:Oi(i,"maxRecordCount",void 0)}}function Eo(i){const e=i==null?void 0:i.advancedEditingCapabilities;return{supportsAsyncApplyEdits:be(e,"supportsAsyncApplyEdits",!1),supportsGlobalId:be(i,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:be(e,"supportsReturnServiceEditsInSourceSR",!1),supportsSharedTemplates:be(i,"hasSharedTemplates",!1),supportsSplit:be(e,"supportsSplit",!1)}}function To(i){const e=i==null?void 0:i.syncCapabilities,t=e==null?void 0:e.supportedSyncDataOptions;return{supportsAsync:be(e,"supportsAsync",!1),supportedSyncDataOptions:{annotations:!(1&~t),dimensions:!(2&~t),contingentValues:!(4&~t),attributeRules:!(8&~t),utilityNetworkSystem:!(16&~t),annotationFullModel:!(32&~t),include3DObjects:!(64&~t),utilityNetworkMissingLayers:!(128&~t),preserveTrueCurves:!(256&~t)}}}let te=class extends vi.JSONSupportMixin(zt.IdentifiableMixin(_i)){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1,this.userTypeExtensions=[],this.layerInfos=null,this.tableInfos=null,this.capabilities=null}read(e,t){this.sourceJSON=e,super.read(e,t)}get utilityNetworkUrl(){if(this.sourceJSON){for(const e of this.sourceJSON.layers)if(e.type==="Utility Network Layer")return`${this.url}/${e.id}`}return null}get versionManagementServiceUrl(){var e;return(e=this.sourceJSON)!=null&&e.hasBranchVersionedData&&!br(this.url)?this.url.replace(/\/FeatureServer/i,"/VersionManagementServer"):null}readLayerInfos(e,t){return(t.layers||[]).map(s=>{const{type:r,geometryType:n}=s;return{...Et(this.url,s),type:r||"Feature Layer",geometryType:n}})}readTableInfos(e,t){return(t.tables||[]).map(s=>Et(this.url,s))}readCapabilities(e,t){return Mo(t)}get effectiveCapabilities(){const e=this.capabilities;if(!e)return null;const t=Si(e),{operations:s}=t;return this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=!0,t):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=!0),t)}load(e){return this.addResolvingPromise(this._fetchService(this.url,e).then(()=>this._setUserPrivileges(e))),Promise.resolve(this)}async fetchAllLayersAndTables(e){return await this.load(e),this._fetchLayersAndTablesPromise||(this._fetchLayersAndTablesPromise=this._fetchLayersAndTables(this.url)),ze(e),this._fetchLayersAndTablesPromise}async applyEdits(e,t){let s=null;try{const{results:r,edits:n,editedFeatures:a}=await this._internalApplyEdits(e,t),d=u=>u.filter(h=>!h.error).map(Si);let c=0;return r.map(u=>{s=Ir(this.url,u.id,t==null?void 0:t.gdbVersion,!0);const h={edits:n[c],addedFeatures:d(u.addFeatureResults),updatedFeatures:d(u.updateFeatureResults),deletedFeatures:d(u.deleteFeatureResults),addedAttachments:d(u.addAttachmentResults),updatedAttachments:d(u.updateAttachmentResults),deletedAttachments:d(u.deleteAttachmentResults),exceededTransferLimit:!1,historicMoment:u.editMoment?new Date(u.editMoment):null};c+=1,a.length>0&&(h.editedFeatures=a),s.resolve(h),s=null}),r}catch(r){throw s&&s.reject(r),r}}async querySharedTemplates(e){const t={...e==null?void 0:e.query};return t.layers==null&&t.templateIds==null&&(t.layers=this.layerInfos.map(s=>s.id)),(await Io({serviceUrl:this.url,query:t,requestOptions:e==null?void 0:e.requestOptions})).map(s=>{const r=bo.fromJSON(s);return r.featureService=this,r})}async _setUserPrivileges(e){if(Mr.userPrivilegesApplied)try{const{features:{fullEdit:t},content:{updateItem:s}}=await this._fetchUserPrivileges(this.sourceJSON.serviceItemId,e);this._set("userHasFullEditingPrivileges",t),this._set("userHasUpdateItemPrivileges",s)}catch(t){Mt(t)}}async _fetchUserPrivileges(e,t){var u;if(!e)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};let a,d,c;try{a=await Ar(this.url,t)}catch(h){Mt(h)}try{const h=t!=null?t.signal:null;d=await((u=$s)==null?void 0:u.getCredential(`${a}/sharing`,{prompt:!1,signal:h}))}catch(h){Mt(h)}if(!d)return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}};try{if(c=new Fr({id:e,portal:{url:a}}),await c.load(t),c.portal.user)return Cr(c)}catch(h){Mt(h)}return{features:{edit:!0,fullEdit:!1},content:{updateItem:!1}}}async _internalApplyEdits(e,t){await Er(this.url);const s=(t==null?void 0:t.globalIdUsed)??!1,r=Gt.fromJSON(this.sourceJSON.spatialReference),{edits:n,options:a}=await this._processApplyEditsParams(e,t),d=await Promise.all(n.map(async g=>{var Z,ve;const y=((Z=g.addFeatures)==null?void 0:Z.map(ne=>Qi({spatialReference:r},ne,null)))??[],v=(await Promise.all(y)).filter(ot),b=v.length>0?v:null,I=((ve=g.updateFeatures)==null?void 0:ve.map(ne=>Qi({spatialReference:r},ne,null)))??[],M=(await Promise.all(I)).filter(ot),E=M.length>0?M:null,N=bn(g.identifierFields,g.deleteFeatures,s),D=N.length>0?N:null;Tr(b,E,r);const O=await In(g.identifierFields,g);let Q=null;return O&&(Q={adds:O.adds.length>0?O.adds:void 0,updates:O.updates.length>0?O.updates:void 0,deletes:O.deletes.length>0?O.deletes:void 0}),{id:g.id,adds:b,updates:E,deletes:D,attachments:Q}})),c={gdbVersion:a==null?void 0:a.gdbVersion,rollbackOnFailure:!0,useGlobalIds:s,returnEditMoment:!0,honorSequenceOfEdits:a==null?void 0:a.honorSequenceOfEdits,usePreviousEditMoment:a==null?void 0:a.usePreviousEditMoment,returnServiceEditsInSourceSR:!1,returnServiceEditsOption:"originalAndCurrentFeatures",async:!1};await $r(this.url,t==null?void 0:t.gdbVersion,!0);const u=xr(this.url,(t==null?void 0:t.gdbVersion)||null);c.edits=JSON.stringify(d);const h=Pt(this.url),m=kr(h.query,{query:Lr({...c,f:"json"}),method:"post"});let f;u&&(m.authMode="immediate",m.query.sessionId=Ce);try{f=await He(this.url+"/applyEdits",m)}catch(g){if(!Mn(g))throw g;m.authMode="immediate",f=await He(this.url+"/applyEdits",m)}return{...$o(f),edits:n}}async _processApplyEditsParams(e,t){const s={...t};return{edits:await Promise.all(e.map(async r=>{const n=this.effectiveCapabilities,a=r&&(r.addFeatures||r.updateFeatures||r.deleteFeatures),d=r&&(r.addAttachments||r.updateAttachments||r.deleteAttachments);if(Cn(r,n,t,!!a,!!d,"feature-service"),!n.data.isDataVersioned&&(t==null?void 0:t.gdbVersion))throw new A("feature-service:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isDataVersioned'");const c=En(r,n,"feature-service");return{...await Tn(c),id:r.id,identifierFields:r.identifierFields}})),options:s}}async _fetchService(e,t){if(this.sourceJSON)return void this.read(this.sourceJSON,{url:Pt(e)});const s=await He(e,{responseType:"json",query:{f:"json"},...t});this.read(s.data,{url:Pt(e)})}async _fetchLayersAndTables(e){const t=`${e}/layers`,s=await He(t,{responseType:"json",query:{f:"json"}});return{layers:s.data.layers.map(r=>{const{type:n,geometryType:a}=r,d=Et(this.url,r),c=Ri(r,d.url);return{...d,type:n||"Feature Layer",geometryType:a,capabilities:c}}),tables:s.data.tables.map(r=>{const n=Et(this.url,r),a=Ri(r,n.url);return{...n,capabilities:a}})}}};function $o(i){const e=i.data,t=[];return{results:e.map(s=>{const r={addResults:s.addResults??[],updateResults:s.updateResults??[],deleteResults:s.deleteResults??[],attachments:s.attachments,editMoment:s.editMoment},n=An(r),a=s.editedFeatures,d=a!=null&&a.spatialReference?new Gt({wkid:a==null?void 0:a.spatialReference.wkid,wkt:a==null?void 0:a.spatialReference.wkt,latestWkid:a==null?void 0:a.spatialReference.latestWkid,latestVcsWkid:a==null?void 0:a.spatialReference.latestVcsWkid,vcsWkid:a==null?void 0:a.spatialReference.vcsWkid}):null,c=a?Fn(a,d):null;return c&&t.push({layerId:s.id,editedFeatures:c}),{id:s.id,editedFeatures:c,...n}}),editedFeatures:t}}o([l()],te.prototype,"url",void 0),o([l()],te.prototype,"sourceJSON",void 0),o([l()],te.prototype,"userHasFullEditingPrivileges",void 0),o([l()],te.prototype,"userHasUpdateItemPrivileges",void 0),o([l({readOnly:!0})],te.prototype,"utilityNetworkUrl",null),o([l({readOnly:!0})],te.prototype,"versionManagementServiceUrl",null),o([l()],te.prototype,"userTypeExtensions",void 0),o([l({json:{read:{source:["layers"]}}})],te.prototype,"layerInfos",void 0),o([Re("layerInfos",["layers"])],te.prototype,"readLayerInfos",null),o([l({json:{read:{source:["tables"]}}})],te.prototype,"tableInfos",void 0),o([Re("tableInfos",["tables"])],te.prototype,"readTableInfos",null),o([l({readOnly:!0,json:{read:{source:["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"]}}})],te.prototype,"capabilities",void 0),o([Re("capabilities",["hasVersionedData","hasSharedTemplates","hasBranchVersionedData","capabilities","supportsQueryDataElements","supportsQueryDomains","supportsQueryContingentValues","maxRecordCountFactor","maxRecordCount","advancedEditingCapabilities","supportsApplyEditsWithGlobalIds","syncCapabilities","datesInUnknownTimezone"])],te.prototype,"readCapabilities",null),o([l({readOnly:!0})],te.prototype,"effectiveCapabilities",null),te=o([k("esri.rest.featureService.FeatureService")],te);const xo=te;let ce=class extends ye{constructor(e){super(e),this.layers=new G,this.lockType="none",this.tables=new G,this.versionInfo=null,this.versionService=null}get layersAndTables(){return new G([...this.layers.toArray(),...this.tables.toArray()])}updateLockType(){this.lockType=this.versionInfo?this.versionService.getLockType(this.versionInfo.versionIdentifier)??"none":"none"}get featureServiceVersion(){var e;return((e=this.featureService.sourceJSON)==null?void 0:e.currentVersion)??0}};o([l({constructOnly:!0})],ce.prototype,"canCreateVersion",void 0),o([l({constructOnly:!0})],ce.prototype,"canEditVersionedData",void 0),o([l({constructOnly:!0})],ce.prototype,"featureService",void 0),o([l({constructOnly:!0})],ce.prototype,"layers",void 0),o([l()],ce.prototype,"layersAndTables",null),o([l()],ce.prototype,"lockType",void 0),o([l({constructOnly:!0})],ce.prototype,"tables",void 0),o([l()],ce.prototype,"versionInfo",void 0),o([l({constructOnly:!0})],ce.prototype,"versionService",void 0),o([l()],ce.prototype,"hasAdvancedEditingUserTypeExtension",void 0),o([l()],ce.prototype,"loggedInServiceUser",void 0),o([l()],ce.prototype,"featureServiceVersion",null),ce=o([k("esri.undoredo.support.ServiceVersionInfo")],ce);let ko=class{constructor(e){this.moments=[],this.forwardMoments=[],this.moments.push(e)}push(e){return this.forwardMoments.length,this.moments.push(e)}pop(){if(!(this.forwardMoments.length>0))return this.moments.pop()}undo(){if(!this.canUndo())return;const e=this.moments.pop();return this.forwardMoments.push(e),e}peek(){return this.moments.at(-1)}canUndo(){return this.moments.length>1}canRedo(){return this.hasForwardEdits()}redo(){if(!this.canRedo())return;const e=this.forwardMoments.pop();return this.moments.push(e),e}size(){return this.moments.length+this.forwardMoments.length}hasForwardEdits(){return this.forwardMoments.length>0}clearForwardEdits(){this.forwardMoments=[]}},pt=class{constructor(e){this.versionableItem=e,this.type="feature-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}};o([l({readOnly:!0})],pt.prototype,"type",void 0),o([l()],pt.prototype,"gdbVersion",null),o([l({type:Date})],pt.prototype,"historicMoment",null),o([l({readOnly:!0})],pt.prototype,"featureServiceUrl",null);let mt=class{constructor(e){this.versionableItem=e,this.type="network"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){return this.versionableItem.featureServiceUrl}};o([l({readOnly:!0})],mt.prototype,"type",void 0),o([l()],mt.prototype,"gdbVersion",null),o([l({type:Date})],mt.prototype,"historicMoment",null),o([l({readOnly:!0})],mt.prototype,"featureServiceUrl",null);let gt=class{constructor(e){this.versionableItem=e,this.type="subtype-group-layer"}get gdbVersion(){return this.versionableItem.gdbVersion}set gdbVersion(e){this.versionableItem.gdbVersion=e}get historicMoment(){return this.versionableItem.historicMoment}set historicMoment(e){this.versionableItem.historicMoment=e}get featureServiceUrl(){const e=/^(.*\/FeatureServer)\/\d+$/;return this.versionableItem.url.replace(e,"$1")}};o([l({readOnly:!0})],gt.prototype,"type",void 0),o([l()],gt.prototype,"gdbVersion",null),o([l({type:Date})],gt.prototype,"historicMoment",null),o([l({readOnly:!0})],gt.prototype,"featureServiceUrl",null);function os(i){return"networkServiceUrl"in i?new mt(i):i.type!=="feature"||Ni(i)?i.type!=="subtype-group"||Ni(i)?null:new gt(i):new pt(i)}function as(i){const e=[];for(const t of i)if(t.type==="group"){const s=t,r=s.allTables.concat(s.allLayers);for(const n of r)if(n.type==="feature"||n.type==="subtype-group"){const a=os(n);a&&e.push(a)}}else{const s=os(t);s&&e.push(s)}return e}let Me=class extends vi.JSONSupportMixin(_i){constructor(e){super(e),this.url=null,this.sourceJSON=null,this.name=null,this.defaultVersionIdentifier=null,this.capabilities=null,this._isDefault=t=>!t||t===this.defaultVersionIdentifier.name,this._dateEquals=(t,s)=>!t&&!s||!(!t||!s)&&t.toISOString()===s.toISOString(),this._applyEditsHandler=t=>{const{serviceUrl:s,gdbVersion:r,result:n}=t;s===this._featureServiceUrl&&n.then(a=>{const d=a.historicMoment;d&&this._addMomentToVersionItem(r,d)})}}initialize(){this.url=Vr(this.url),this._featureServiceUrl=this.url.replace(/\/VersionManagementServer/i,"/FeatureServer"),Y.has(this.url)||Y.set(this.url,new Map);const e=(At.get(this.url)??0)+1;At.set(this.url,e),this.when().then(()=>this.addHandles(Pr(this._applyEditsHandler)),()=>{})}destroy(){const e=(At.get(this.url)??1)-1;At.set(this.url,e),e===0&&Y.delete(this.url),Di.delete(this._featureServiceUrl)}read(e,t){this.sourceJSON=e,super.read(e,t)}readDefaultVersionIdentifier(e,t){return{name:t.defaultVersionName,guid:t.defaultVersionGuid}}writeDefaultVersionIdentifier(e,t){t.defaultVersionName=e.name,t.defaultVersionGuid=e.guid}load(e){return this.addResolvingPromise(this._fetchService(this.url,e)),Promise.resolve(this)}async createVersion(e){const[{createVersion:t},{default:s}]=await Promise.all([_(()=>import("./createVersion-DzYo6d9X.js"),__vite__mapDeps([20,0,1]),import.meta.url),_(()=>import("./CreateVersionParameters-CL9WiHki.js"),__vite__mapDeps([21,0,1]),import.meta.url)]),r=s.from(e);return t(this.url,r)}async deleteVersion(e){var a;const[{deleteVersion:t},{default:s}]=await Promise.all([_(()=>import("./deleteVersion-CuxjrBcf.js"),__vite__mapDeps([22,0,1,23]),import.meta.url),_(()=>import("./DeleteVersionParameters-CXXJnStG.js"),__vite__mapDeps([24,0,1]),import.meta.url)]);let r;e.guid&&((a=Y.get(this.url))!=null&&a.has(e.guid))&&(r=Ce??void 0);const n=new s({versionName:e.name,sessionId:r});return t(this.url,n)}async getVersionInfoExtended(e){const{getVersion:t}=await _(()=>import("./getVersion-CwgCDC8Z.js"),__vite__mapDeps([25,0,1]),import.meta.url);return t(this.url,e.guid)}async getVersionInfos(e={}){const[{getVersionInfos:t},{default:s}]=await Promise.all([_(()=>import("./getVersionInfos-CsfSp_tD.js"),__vite__mapDeps([26,0,1]),import.meta.url),_(()=>import("./GetVersionInfosParameters-BHbkgP3L.js"),__vite__mapDeps([27,0,1]),import.meta.url)]),r=s.from(e);return t(this.url,r)}async reconcile(e,t={}){const[{reconcile:s},{default:r}]=await Promise.all([_(()=>import("./reconcile-Ub7_bLFA.js"),__vite__mapDeps([28,0,1,23]),import.meta.url),_(()=>import("./ReconcileParameters-C4x4MCxh.js"),__vite__mapDeps([29,0,1]),import.meta.url)]),n=r.from(t);return n.sessionId=Ce,s(this.url,e.guid,n)}async post(e){const[{post:t},{default:s}]=await Promise.all([_(()=>import("./post-C8Q4nij1.js"),__vite__mapDeps([30,0,1,23]),import.meta.url),_(()=>import("./PostParameters-DvUmuEEq.js"),__vite__mapDeps([31,0,1]),import.meta.url)]),r=s.from({sessionId:Ce});return t(this.url,e.guid,r)}async alterVersion(e,t){const[{alterVersion:s},{default:r}]=await Promise.all([_(()=>import("./alterVersion-BvhTcGKj.js"),__vite__mapDeps([32,0,1,23]),import.meta.url),_(()=>import("./AlterVersionParameters-6IcJhB3g.js"),__vite__mapDeps([33,0,1]),import.meta.url)]),n=r.from(t);return s(this.url,e.guid,n)}async startReading(e){return(await this.startReadingWithResult(e)).success}async startReadingWithResult(e){const{startReading:t}=await _(()=>import("./startReading-Df3IqoCf.js"),__vite__mapDeps([34,0,1]),import.meta.url),s=await t(this.url,e.guid,Ce);if(s.success){const r=await this.getVersionInfoExtended(e),n=new Date(r.modifiedDate),a={name:r.versionIdentifier.name,moment:n,lockType:"read"};this._addOrUpdateItem(e.guid,a),et(this._featureServiceUrl,null,e.name,n)}return s}async stopReading(e){return(await this.stopReadingWithResult(e)).success}async stopReadingWithResult(e){var r;const{stopReading:t}=await _(()=>import("./stopReading-DaJlKb-G.js"),__vite__mapDeps([35,0,1]),import.meta.url),s=await t(this.url,e.guid,Ce);return s.success&&((r=Y.get(this.url))==null||r.delete(e.guid),et(this._featureServiceUrl,null,e.name,null)),s}async startEditing(e){return(await this.startEditingWithResult(e)).success}async startEditingWithResult(e){const{startEditing:t}=await _(()=>import("./startEditing-BNdUwi6B.js"),__vite__mapDeps([36,0,1]),import.meta.url),s=await t(this.url,e.guid,Ce);if(s.success){const r=await this.getVersionInfoExtended(e),n=new Date(r.modifiedDate),a=new ko(n),d={name:e.name,moment:n,lockType:"edit",stack:a};this._addOrUpdateItem(e.guid,d),et(this._featureServiceUrl,null,e.name,n)}return s}async stopEditing(e,t){return(await this.stopEditingWithResult(e,t)).success}async stopEditingWithResult(e,t){var n,a;if(t){const d=(n=Y.get(this.url))==null?void 0:n.get(e.guid);if((a=d==null?void 0:d.stack)!=null&&a.canRedo()){const[{deleteForwardEdits:c},{default:u}]=await Promise.all([_(()=>import("./deleteForwardEdits-CB_fP6Nb.js"),__vite__mapDeps([37,0,1]),import.meta.url),_(()=>import("./DeleteForwardEditsParameters-D1ecKMax.js"),__vite__mapDeps([38,0,1]),import.meta.url)]),h=await c(this.url,e.guid,new u({sessionId:Ce,moment:d.moment}));if(!h.success)return h}}const{stopEditing:s}=await _(()=>import("./stopEditing-B5dF_OLe.js"),__vite__mapDeps([39,0,1]),import.meta.url),r=await s(this.url,e.guid,Ce,t);if(r.success){const d=await this.getVersionInfoExtended(e),c=new Date(d.modifiedDate);this._addOrUpdateItem(e.guid,{name:e.name,moment:c,lockType:"read",editMomentStack:void 0}),et(this._featureServiceUrl,null,e.name,c)}return r}getLockType(e){var s,r;return((r=(s=Y.get(this.url))==null?void 0:s.get(e.guid))==null?void 0:r.lockType)??"none"}async changeVersion(e,t,s){if(s&&"name"in s&&!await this.getVersionInfoExtended(s))throw new A("version-management-service:invalid-version","version does not exist");if("networkServiceUrl"in e){if(this._featureServiceUrl.toLowerCase()===e.featureServiceUrl.toLowerCase())return this._changeVersionInternal(e,t,s)}else{let r;"layers"in e?(r=e.allTables.concat(e.allLayers),e.utilityNetworks&&e.utilityNetworks.forEach(n=>{this._featureServiceUrl.toLowerCase()===n.featureServiceUrl.toLowerCase()&&this._changeVersionInternal(n,t,s)})):r=e;for(const n of r)if(n.type==="feature"||n.type==="subtype-group"){const a=/^(.*\/FeatureServer)\/\d+$/,d=n.url.replace(a,"$1");if(this._featureServiceUrl.toLowerCase()===d.toLowerCase()&&!this._changeVersionInternal(n,t,s))return!1}else if(n.type==="group"){const a=n.allTables.concat(n.allLayers);for(const d of a)if(d.type==="feature"||d.type==="subtype-group"){const c=/^(.*\/FeatureServer)\/\d+$/,u=d.url.replace(c,"$1");if(this._featureServiceUrl.toLowerCase()===u.toLowerCase()&&!this._changeVersionInternal(d,t,s))return!1}}}return!0}async changeVersionWithResult(e,t,s){let r;if("layers"in e){const a=as(e.allTables.concat(e.allLayers).filter(d=>d.type!=="group").toArray());e.utilityNetworks&&e.utilityNetworks.forEach(d=>{const c=as([d]);a.push(...c)}),r=a}else r=e;if(s&&"name"in s&&!await this.getVersionInfoExtended(s)){const a=new Map;for(const d of r)a.set(d,{success:!1});return a}if(t&&"name"in t&&this.getLockType(t)!=="none"){const a=new Map;for(const d of r)a.set(d,{success:!1});return a}const n=new Map;for(const a of r)if(a)if(a.featureServiceUrl.toLowerCase()===this._featureServiceUrl.toLowerCase()){const d=this._changeVersionInternalWithResult(a,t,s);n.set(a,d)}else n.set(a,{success:!1});return n}async getVersionIdentifierFromName(e){var t;try{return((t=(await this.getVersionInfos({includeHidden:!0})).find(r=>r.versionIdentifier.name.toUpperCase()===e.toUpperCase()))==null?void 0:t.versionIdentifier)||null}catch{return null}}async getVersionIdentifierFromGuid(e){const{getVersion:t}=await _(()=>import("./getVersion-CwgCDC8Z.js"),__vite__mapDeps([25,0,1]),import.meta.url);try{return(await t(this.url,e)).versionIdentifier}catch{return null}}canUndo(e){var s,r;const t=(s=Y.get(this.url))==null?void 0:s.get(e.guid);return!!((r=t==null?void 0:t.stack)!=null&&r.canUndo())}canRedo(e){var s,r;const t=(s=Y.get(this.url))==null?void 0:s.get(e.guid);return!!((r=t==null?void 0:t.stack)!=null&&r.canRedo())}undo(e){var r,n,a;const t=(r=Y.get(this.url))==null?void 0:r.get(e.guid),s=((n=t==null?void 0:t.stack)==null?void 0:n.undo())||void 0;if(t&&s){const d=t.stack.peek();et(this._featureServiceUrl,null,e.name,d),(a=Y.get(this.url))==null||a.set(e.guid,{...t,moment:d})}}redo(e){var r,n,a;const t=(r=Y.get(this.url))==null?void 0:r.get(e.guid),s=((n=t==null?void 0:t.stack)==null?void 0:n.redo())||void 0;t&&s&&(et(this._featureServiceUrl,null,e.name,s),(a=Y.get(this.url))==null||a.set(e.guid,{...t,moment:s}))}_setUpData(e,t){let s=null,r=null,n=null,a=null;const d=c=>{var h,m;const u=(m=(h=Y)==null?void 0:h.get(this.url))==null?void 0:m.get(c.guid);n=c.name,a=(u==null?void 0:u.moment)??null};if(e&&"name"in e){if(this.getLockType(e)!=="none")throw new A("version-management-service:version-locked","version is locked");s=e.name,r=null,t&&"name"in t?d(t):(n=this.defaultVersionIdentifier.name,a=t)}else s=this.defaultVersionIdentifier.name,r=e,t&&"name"in t?d(t):(n=this.defaultVersionIdentifier.name,a=t);return{fromVersionName:s,fromMoment:r,toVersionName:n,toMoment:a}}_changeVersionInternal(e,t,s){try{const{fromVersionName:r,fromMoment:n,toVersionName:a,toMoment:d}=this._setUpData(t,s);(this._isDefault(r)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||r===e.gdbVersion&&this._dateEquals(e.historicMoment,n))&&(e.gdbVersion=a,e.historicMoment=d)}catch{return!1}return!0}_changeVersionInternalWithResult(e,t,s){try{const{fromVersionName:r,fromMoment:n,toVersionName:a,toMoment:d}=this._setUpData(t,s);return this._isDefault(r)&&this._isDefault(e.gdbVersion)&&this._dateEquals(e.historicMoment,n)||r===e.gdbVersion&&this._dateEquals(e.historicMoment,n)?(e.gdbVersion=a,e.historicMoment=d,{success:!0}):{success:!1}}catch{return{success:!1}}}_addMomentToVersionItem(e,t){const s=Y.get(this.url);if(s)for(const[r,n]of s)n.name===e&&this._addToStack(r,t)}_addToStack(e,t){const s=Y.get(this.url),r=s==null?void 0:s.get(e);return!!(r!=null&&r.stack)&&(Lo(r.stack.peek(),t)&&r.stack.push(t),s.set(e,{...r,moment:t}),!0)}_addOrUpdateItem(e,t){const s=Y.get(this.url),r=s==null?void 0:s.get(e);return r?(s.set(e,{...r,...t}),!0):!(!t.name||!t.lockType)&&(s==null||s.set(e,{...t,lockType:t.lockType}),!0)}async _fetchService(e,t){if(this.sourceJSON){this.read(this.sourceJSON,{origin:"service",url:Pt(e)});const r=new Sr(this.url).host;return void Di.set(r,this.defaultVersionIdentifier.name)}const s=await He(e,{responseType:"json",query:{f:"json"},...t});this.read(s.data)}};function Lo(i,e){return i?i.getTime()<e.getTime():!0}o([l()],Me.prototype,"url",void 0),o([l()],Me.prototype,"sourceJSON",void 0),o([l({type:String,json:{write:!0}})],Me.prototype,"name",void 0),o([l({json:{write:{target:{defaultVersionName:{type:String},defaultVersionGuid:{type:String}}},read:{source:["defaultVersionName","defaultVersionGuid"]}}})],Me.prototype,"defaultVersionIdentifier",void 0),o([Re("defaultVersionIdentifier",["defaultVersionName","defaultVersionGuid"])],Me.prototype,"readDefaultVersionIdentifier",null),o([Rr("defaultVersionIdentifier",{defaultVersionName:{type:String},defaultVersionGuid:{type:String}})],Me.prototype,"writeDefaultVersionIdentifier",null),o([l({json:{write:!0}})],Me.prototype,"capabilities",void 0),Me=o([k("esri.versionManagement.VersionManagementService")],Me);const Vo=Me;function Po(i){return!i||i.trim().length===0}let ke=class extends _i.LoadableMixin(Or.EsriPromiseMixin(xs.EventedAccessor)){constructor(e){super(e),this._updatingHandles=new Nr,this.items=new G,this.tablesAndLayersLookup=new wi,this.additionalLayers=new G,this._debouncedCheckAndUpdateServiceInfos=Ne(async()=>{var s;const t=[];for(const r of this.items){if(r.layersAndTables.length===0)continue;const n=r.layersAndTables.getItemAt(0);(n==null?void 0:n.gdbVersion)!==((s=r.versionInfo)==null?void 0:s.versionIdentifier.name)&&t.push(r)}t.length!==0&&(await qt(()=>!this.updating),await this._updateVersionInfos(t))}),this._debouncedLayersChanged=Ne(async()=>{const t=this._detectNewLayersAndTables();t.length!==0&&(await qt(()=>!this._updatingHandles.updating),await this._updatingHandles.addPromise((async()=>{const s=new Set;for(const r of t)if(r.type==="feature"||r.type==="subtype-group"){if(!r.url)continue;const n=Dr(r.url).url.path,a=this._findServiceInfo(n);if(a)this.tablesAndLayersLookup.set(r,a),r.isTable?a.tables.push(r):a.layers.push(r);else if(!s.has(n))try{await this._addServiceInfo(n,r)}catch(d){se.getLogger(this).error(`Failed to load feature service: ${n}`,d)}finally{s.add(n)}}})()))}),this._processed=new Set}destroy(){this._set("view",null),this.items.removeAll(),this.tablesAndLayersLookup.clear()}async load(e){return ze(e),this.addHandles([w(()=>this._allLayersAndTables,()=>{this._debouncedLayersChanged().catch(t=>{se.getLogger(this).warn("Failed to update service info",t)})}),w(()=>this.items.map(t=>t.layersAndTables.map(s=>s.gdbVersion??"").join(",")),()=>{this.checkAndUpdateServiceInfos().catch(t=>{se.getLogger(this).warn("Failed to update service info",t)})})]),this.addResolvingPromise(this._debouncedLayersChanged()),this}get updating(){return this.loadStatus==="loading"||this._updatingHandles.updating}checkAndUpdateServiceInfos(){return this._debouncedCheckAndUpdateServiceInfos()}changeVersion(e,t,s){return this._updatingHandles.addPromise((async()=>{await this._changeVersionInternal(e,t,s)})())}createVersion(e){return this._updatingHandles.addPromise((async()=>{var c;const t=e.featureServerUrl,s=this._findServiceInfo(t);if(!(s!=null&&s.versionService))throw new A("services:no-version-management-service");const r=s.hasAdvancedEditingUserTypeExtension,n=s.loggedInServiceUser.toUpperCase(),a=Po(e.ownerName)?n:(c=e.ownerName)==null?void 0:c.trim().toUpperCase();if(a!==n){if(s.featureServiceVersion<=11.1)throw new A("services:versioning-api-error");if(!r)throw new A("services:no-advanced-editing-user-type-extension")}if((a==null?void 0:a.toUpperCase())==="SDE"&&e.versionName.toUpperCase()==="DEFAULT")throw new A("services:no-valid-version-name");{const u=await s.versionService.getVersionInfos();if(u!=null&&u.find(h=>h.versionIdentifier.name.toUpperCase()===(a+"."+e.versionName).toUpperCase()||h.versionIdentifier.name.toUpperCase()===(n+"."+e.versionName).toUpperCase()))throw new A("services:no-valid-version-name")}const d=await s.versionService.createVersion({versionName:e.versionName,access:a!==n?"public":e.access,description:e.description});if(a!==n){const{guid:u,name:h}=d.versionIdentifier;await s.versionService.alterVersion({guid:u,name:h},{ownerName:a,access:e.access})}e.switchToVersion&&await this._changeVersionInternal(t,d.versionIdentifier.name,d.versionIdentifier.guid),this.emit("version-created",{versionIdentifier:d.versionIdentifier,versionManagementService:s.versionService})})())}deleteVersion(e,t,s){return this._updatingHandles.addPromise((async()=>{const r=this._findServiceInfo(e);if(!(r!=null&&r.versionService))throw new A("services:no-version-management-service");if(r.featureServiceVersion<=11.1)throw new A("services:versioning-api-error");if(!r.hasAdvancedEditingUserTypeExtension)throw new A("services:no-advanced-editing-user-type-extension");const n={name:t,guid:s};await r.versionService.deleteVersion(n)&&(await this._updateVersionInfo(r),this.emit("version-deleted",{versionIdentifier:n,versionManagementService:r.versionService}))})())}startEditing(e){return this._updatingHandles.addPromise((async()=>{var n;const t=this._findServiceInfo(e);if(!(t!=null&&t.versionService))throw new A("services:no-version-management-service");if(!t.hasAdvancedEditingUserTypeExtension)throw new A("services:no-advanced-editing-user-type-extension");const s=((n=t.versionInfo)==null?void 0:n.versionIdentifier)??{name:t.versionService.defaultVersionIdentifier.name,guid:t.versionService.defaultVersionIdentifier.guid};let r=!0;(t.versionService.getLockType(s)!=="none"||(r=await t.versionService.startReading(s),r))&&(r=await t.versionService.startEditing(s),t.updateLockType())})())}finishEditing(e,t){return this._updatingHandles.addPromise((async()=>{var a;const s=this._findServiceInfo(e);if(!(s!=null&&s.versionService))throw new A("services:no-version-management-service");if(!s.hasAdvancedEditingUserTypeExtension)throw new A("services:no-advanced-editing-user-type-extension");const r=((a=s.versionInfo)==null?void 0:a.versionIdentifier)??{name:s.versionService.defaultVersionIdentifier.name,guid:s.versionService.defaultVersionIdentifier.guid},n=s.versionService.getLockType(r);if(n!=="none")return n==="read"?(await s.versionService.stopReading(r),void s.updateLockType()):n==="edit"?(await s.versionService.stopEditing(r,t),await s.versionService.stopReading(r),void s.updateLockType()):void 0})())}async _changeVersionInternal(e,t,s){var d,c;const r=this._findServiceInfo(e);if(!(r!=null&&r.versionService))throw new A("services:no-version-management-service");const n=((d=r.versionInfo)==null?void 0:d.versionIdentifier)??{name:r.versionService.defaultVersionIdentifier.name,guid:r.versionService.defaultVersionIdentifier.guid},a={name:t,guid:s};await r.versionService.changeVersion((c=this.view)==null?void 0:c.map,n,a)&&await this._updateVersionInfo(r)}async _updateVersionInfo(e){var n;const t=e.versionService;if(!t||e.layersAndTables.length===0)return;const s=(n=e.layersAndTables.getItemAt(0))==null?void 0:n.gdbVersion,r=s?await t.getVersionIdentifierFromName(s):t.defaultVersionIdentifier;e.versionInfo=await t.getVersionInfoExtended(r)}_findServiceInfo(e){return this.items.find(t=>t.featureService.url===e)??null}_removeFeatureService(e){this.items.remove(e)}async _findPortal(e){var n;const t=(n=$s)==null?void 0:n.findServerInfo(e??"");if(!(t!=null&&t.owningSystemUrl))return null;const s=`${t.owningSystemUrl}/sharing/rest`,r=Bi.getDefault();return r!=null&&r.loaded&&qi(r.restUrl)===qi(s)?r:new Bi({authMode:"immediate",url:t.owningSystemUrl}).load()}_updateVersionInfos(e){return this._updatingHandles.addPromise((async()=>{for(const t of e)await this._updateVersionInfo(t).catch(s=>{se.getLogger(this).error("Failed to update version details",s)})})())}async _addServiceInfo(e,t){var m;const s=new xo({url:e});await s.load();const r=await this._findPortal(e),n=(m=r==null?void 0:r.user)==null?void 0:m.username;let a=!1;n&&(a=await wn(r,n,"advediting"));let d=null;s.versionManagementServiceUrl&&(d=new Vo({url:s.versionManagementServiceUrl}),await d.load());const c=t.isTable?[]:[t],u=t.isTable?[t]:[],h=new ce({loggedInServiceUser:n??"",hasAdvancedEditingUserTypeExtension:a,versionInfo:null,lockType:"none",canEditVersionedData:!0,canCreateVersion:!0,featureService:s,versionService:d,layers:new G(c),tables:new G(u)});return d&&await this._updateVersionInfo(h),this.items.push(h),this.tablesAndLayersLookup.set(t,h),t.isTable?h.tables.push(t):h.layers.push(t),h}get _allLayersAndTables(){return[...this.view.map.allLayers,...this.view.map.allTables,...this.additionalLayers]}_detectNewLayersAndTables(){const e=new Set(this._allLayersAndTables),t=[];for(const s of e)s.type!=="feature"&&s.type!=="subtype-group"||this._processed.has(s)||t.push(s);for(const s of this._processed)if(!e.has(s)&&(Br(s)||qr(s))){const r=this.tablesAndLayersLookup.get(s);if(!r)continue;this.tablesAndLayersLookup.delete(s),s.isTable?r.tables.remove(s):r.layers.remove(s),r.layersAndTables.length===0&&this._removeFeatureService(r)}return this._processed=e,t}};o([l({constructOnly:!0})],ke.prototype,"view",void 0),o([l()],ke.prototype,"items",void 0),o([l()],ke.prototype,"tablesAndLayersLookup",void 0),o([l()],ke.prototype,"additionalLayers",void 0),o([l()],ke.prototype,"updating",null),o([l()],ke.prototype,"_allLayersAndTables",null),ke=o([k("esri.undoredo.support.Services")],ke);function ls(i){const{percentAlong:e}=i;return e==null?"":ut(e,{style:"percent",maximumFractionDigits:2})}function ds(i){const{associationType:e}=i;return e==="connectivity"||e==="junction-junction-connectivity"||e==="junction-edge-from-connectivity"||e==="junction-edge-midspan-connectivity"||e==="junction-edge-to-connectivity"}function So(i){return i.associationType==="junction-edge-midspan-connectivity"}const Ro=i=>{var t;const e=[];if(i.formTemplate){const{description:s,title:r}=i.formTemplate;(t=i.fields)==null||t.forEach(n=>{const a=r&&Ui(r,n.name),d=s&&Ui(s,n.name);(a||d)&&e.push(n.name)})}return e},oi=100;let S=class extends ks.ClonableMixin(zt.IdentifiableMixin(ye)){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:t}=this;t&&t.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const t=new AbortController;this._queryAbortController=t,await De(this._query()),this._queryAbortController===t&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await De(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const t=new AbortController;this._queryPageAbortController=t,await De(this._queryPage()),this._queryPageAbortController===t&&(this._queryPageAbortController=null)},this._queryDebounced=Ne(this._queryController,oi),this._queryFeatureCountDebounced=Ne(this._queryFeatureCountController,oi),this._queryPageDebounced=Ne(this._queryPageController,oi),this._query=async()=>{const{_queryAbortController:t,relatedFeatures:s}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,s.destroyAll(),this.destroyed||s.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:t==null?void 0:t.signal}))))},this.addHandles([w(()=>{var t;return[this.displayCount,this.graphic,this.layer,(t=this.layer)==null?void 0:t.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount]},()=>this._queryDebounced(),P),w(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),w(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.destroyAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:t,featureCount:s}=this,r=1,n=Math.ceil(s/t)||1;this._set("featurePage",Math.min(Math.max(e,r),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:t}=this;return e&&(t!=null&&t.loaded)?e.map(s=>{const r=s.clone();return r.field=ui(s.field,t),r}):e??[]}get supportsCacheHint(){var e,t,s;return!!((s=(t=(e=this.layer)==null?void 0:e.capabilities)==null?void 0:t.queryRelated)!=null&&s.supportsCacheHint)}get canLoad(){return!!this.map&&this.relationshipId!=null&&typeof this.objectId=="number"}get canQuery(){var t,s;const e=(s=(t=this.layer)==null?void 0:t.capabilities)==null?void 0:s.queryRelated;return!!(this.relatedLayer&&this.relationship&&this.relationshipId!=null&&this.objectId!=null&&(e!=null&&e.supportsCount)&&(e!=null&&e.supportsPagination))}get itemDescriptionFieldName(){var e;return((e=this.orderByFieldsFixedCasing[0])==null?void 0:e.field)||null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e??3,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){var e,t;return(this.objectIdField&&((t=(e=this.graphic)==null?void 0:e.attributes)==null?void 0:t[this.objectIdField]))??null}get objectIdField(){var e;return((e=this.layer)==null?void 0:e.objectIdField)||null}get relatedFeatures(){return this._get("relatedFeatures")||new G}get relatedLayer(){const{layer:e,map:t,relationship:s}=this;return e!=null&&e.loaded&&t&&s?ln(t,e,s)??null:null}get relationship(){var s;const{relationshipId:e,layer:t}=this;return e!=null?((s=t==null?void 0:t.relationships)==null?void 0:s.find(({id:r})=>r===e))??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new G}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:s,canQuery:r,_loaded:n,canLoad:a}=this;return t||a&&!n?"loading":e||s?"querying":r?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find(t=>t.getObjectId()===e)}refresh(){this._queryFeatureCountDebounced()}_destroyRelatedFeatureViewModels(){var e;(e=this.relatedFeatureViewModels)==null||e.destroyAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:t,relationshipId:s,objectId:r,_queryFeatureCountAbortController:n,canQuery:a,supportsCacheHint:d}=this;if(await(e==null?void 0:e.load()),await(t==null?void 0:t.load()),!a||!e||!t||r==null)return void this._set("featureCount",0);const c=t.createQuery(),{historicMoment:u,gdbVersion:h}=e,m=new ci({cacheHint:d,gdbVersion:h,historicMoment:u,relationshipId:s,returnGeometry:!1,objectIds:[r],where:c.where??void 0}),f=await e.queryRelatedFeaturesCount(m,{signal:n==null?void 0:n.signal});this._set("featureCount",f[r]||0)}_sliceFeatures(e){const{showAllEnabled:t,displayCount:s}=this;return t?e:s?e.slice(0,s):[]}async _queryPage(){const{relatedFeatures:e,featurePage:t,showAllEnabled:s,_queryPageAbortController:r,featureCount:n}=this;!s||t<2||!n||e.addMany(await this._queryRelatedFeatures({signal:r==null?void 0:r.signal}))}async _queryRelatedFeatures(e){var ve;const{orderByFieldsFixedCasing:t,showAllEnabled:s,featuresPerPage:r,displayCount:n,layer:a,relationshipId:d,featurePage:c,featureCount:u,relatedLayer:h,supportsCacheHint:m}=this,{canQuery:f,objectId:g}=this;if(!f||!a||!h||g==null)return[];const y=s?((c-1)*r+u)%u:0,v=s?r:n,b=h.objectIdField,I=[...t.map(ne=>ne.field),...Ro(h),b].filter(ot),M=t.map(ne=>`${ne.field} ${ne.order}`),E=h.createQuery(),{historicMoment:N,gdbVersion:D}=a,O=new ci({orderByFields:M,start:y,num:v,outFields:I,cacheHint:m,historicMoment:N,gdbVersion:D,relationshipId:d,returnGeometry:!1,objectIds:[g],where:E.where??void 0}),Q=await a.queryRelatedFeatures(O,{signal:e==null?void 0:e.signal}),Z=((ve=Q[g])==null?void 0:ve.features)||[];return Z.forEach(ne=>{ne.sourceLayer=h,ne.layer=h}),Z}};o([l()],S.prototype,"_loaded",void 0),o([l()],S.prototype,"_queryAbortController",void 0),o([l()],S.prototype,"_queryPageAbortController",void 0),o([l()],S.prototype,"_queryFeatureCountAbortController",void 0),o([l({value:1})],S.prototype,"featurePage",null),o([l()],S.prototype,"featuresPerPage",void 0),o([l({readOnly:!0})],S.prototype,"orderByFieldsFixedCasing",null),o([l({readOnly:!0})],S.prototype,"supportsCacheHint",null),o([l({readOnly:!0})],S.prototype,"canLoad",null),o([l({readOnly:!0})],S.prototype,"canQuery",null),o([l()],S.prototype,"description",void 0),o([l({readOnly:!0})],S.prototype,"itemDescriptionFieldName",null),o([l({value:3})],S.prototype,"displayCount",null),o([l({type:Ye})],S.prototype,"graphic",void 0),o([l()],S.prototype,"layer",void 0),o([l()],S.prototype,"map",void 0),o([l({readOnly:!0})],S.prototype,"objectId",null),o([l({readOnly:!0})],S.prototype,"objectIdField",null),o([l()],S.prototype,"orderByFields",void 0),o([l({readOnly:!0})],S.prototype,"relatedFeatures",null),o([l({readOnly:!0})],S.prototype,"relatedLayer",null),o([l({readOnly:!0})],S.prototype,"relationship",null),o([l()],S.prototype,"featureCount",void 0),o([l({readOnly:!0})],S.prototype,"relatedFeatureViewModels",null),o([l()],S.prototype,"relationshipId",void 0),o([l()],S.prototype,"showAllEnabled",void 0),o([l()],S.prototype,"state",null),o([l()],S.prototype,"title",void 0),S=o([k("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],S);const Ti=S;var pi;const Nt="esri-feature",ct=`${Nt}-relationship`,Le={base:ct,listContainer:`${ct}__list`,listItem:`${ct}__list-item`,listItemHidden:`${ct}__list-item--hidden`,listContainerQuerying:`${ct}__list--querying`,featureObserver:`${Nt}__feature-observer`,stickySpinnerContainer:`${Nt}__sticky-loading-container`,loadingSpinnerContainer:`${Nt}__loading-container`},cs={title:!0,description:!0};let X=pi=class extends he{constructor(i,e){super(i,e),this._featureElementInfo=null,this._relatedFeatureIntersectionObserverNode=null,this._relatedFeatureIntersectionObserver=new IntersectionObserver(([t])=>{t!=null&&t.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this.flowItems=null,this.flowType="feature-relationship",this.headingLevel=2,this.viewModel=new Ti,this.messages=null,this.messagesCommon=null,this.visibleElements={...cs},this._increaseFeaturePage=()=>{const{state:t,showAllEnabled:s,relatedFeatures:r,featuresPerPage:n,featurePage:a}=this.viewModel;t==="ready"&&s&&r.length>=n*a&&this.viewModel.featurePage++}}initialize(){this._featureElementInfo=new It,this.addHandles([w(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),P),w(()=>[this.viewModel.state,this.viewModel.showAllEnabled,this._relatedFeatureIntersectionObserverNode],()=>this._handleRelatedFeatureObserverChange()),yt(()=>this.viewModel.relatedFeatureViewModels,"change",()=>this._setupRelatedFeatureViewModels())])}loadDependencies(){return Fe({icon:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vV),__vite__mapDeps([0,1]),import.meta.url),list:()=>_(()=>import("./index-BoOF33T4.js"),__vite__mapDeps([40,0,1,41,42,43]),import.meta.url),"list-item":()=>_(()=>import("./index-D9YxSY9e.js"),__vite__mapDeps([44,0,1,45,46,47,48,43,49]),import.meta.url),loader:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vU),__vite__mapDeps([0,1]),import.meta.url),notice:()=>_(()=>import("./index-CpwZb1xc.js"),__vite__mapDeps([50,0,1]),import.meta.url)})}destroy(){this._unobserveRelatedFeatureObserver(),this._featureElementInfo=Ls(this._featureElementInfo)}get displayShowAllButton(){const{showAllEnabled:i,featureCount:e,displayCount:t,state:s}=this.viewModel;return!i&&!!e&&s==="ready"&&(e>t||t===0)}get displayListItems(){return this.displayShowAllButton||this.viewModel.relatedFeatureViewModels.length>0}get description(){return this.viewModel.description}set description(i){this.viewModel.description=i}get featureCountDescription(){const{messages:i}=this,{featureCount:e}=this.viewModel;return me(i==null?void 0:i.numberRecords,{number:e})}get title(){return this.viewModel.title}set title(i){this.viewModel.title=i}castVisibleElements(i){return{...cs,...i}}render(){var e;const{state:i}=this.viewModel;return p("div",{class:this.classes(Le.base,T.widget)},(e=this._featureElementInfo)==null?void 0:e.render(),i==="loading"?this._renderLoading():i==="disabled"?this._renderRelationshipNotFound():this._renderRelatedFeatures())}async _selectRecord(i){const{flowItems:e,featureVisibleElements:t}=this;if(!e)return;i.abilities={relationshipContent:!0};const{default:s}=await _(()=>Promise.resolve().then(()=>Js),void 0,import.meta.url);e.push(new s({flowItems:e,flowType:this.flowType,viewModel:i,visibleElements:t}))}_showAllRecords(){const{flowItems:i}=this;if(!i)return;const{viewModel:e,featureVisibleElements:t}=this;e.showAllEnabled=!0;const s=new pi({flowItems:i,featureVisibleElements:t,visibleElements:{title:!1,description:!1},viewModel:e});i.push(s)}_renderStickyLoading(){return this.viewModel.state==="querying"?p("div",{class:Le.stickySpinnerContainer,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return p("calcite-loader",{inline:!0,label:""})}_renderLoading(){return p("div",{class:Le.loadingSpinnerContainer,key:"loading-container"},this._renderLoadingIcon())}_renderShowAllIconNode(){return p("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})}_renderChevronIconNode(){const i=$e(this.container)?"chevron-left":"chevron-right";return p("calcite-icon",{icon:i,scale:"s",slot:"content-end"})}_renderRelatedFeature(i){var r;const{itemDescriptionFieldName:e}=this.viewModel,t=i.title;i.description=e&&((r=i.formattedAttributes)==null?void 0:r.global[e]);const s=i.state==="loading";return p("calcite-list-item",{class:this.classes(Le.listItem,{[Le.listItemHidden]:s}),description:i.description??"",key:i.uid,label:t,onCalciteListItemSelect:()=>this._selectRecord(i)},this._renderChevronIconNode())}_renderShowAllListItem(){var i;return this.displayShowAllButton?p("calcite-list-item",{description:this.featureCountDescription,key:"show-all-item",label:(i=this.messages)==null?void 0:i.showAll,onCalciteListItemSelect:()=>this._showAllRecords()},this._renderShowAllIconNode()):null}_renderNoRelatedFeaturesMessage(){var i;return p("calcite-notice",{icon:"information",key:"no-related-features-message",kind:"brand",open:!0,scale:"s",width:"full"},p("div",{slot:"message"},(i=this.messages)==null?void 0:i.noRelatedFeatures))}_renderFeatureObserver(){return p("div",{afterCreate:this._relatedFeatureIntersectionObserverCreated,bind:this,class:Le.featureObserver,key:"feature-observer"})}_renderList(){var e;const{relatedFeatureViewModels:i}=this.viewModel;return p("calcite-list",{displayMode:"flat",label:(e=this.messages)==null?void 0:e.relatedFeaturesList},i.toArray().map(t=>this._renderRelatedFeature(t)),this._renderShowAllListItem())}_renderRelatedFeatures(){const{displayListItems:i}=this,{state:e}=this.viewModel;return p("div",{class:this.classes(Le.listContainer,{[Le.listContainerQuerying]:e==="querying"}),key:"list-container"},i?this._renderList():e==="ready"?this._renderNoRelatedFeaturesMessage():null,this._renderStickyLoading(),this._renderFeatureObserver())}_renderRelationshipNotFound(){var i;return p("calcite-notice",{icon:"exclamation-mark-triangle",key:"relationship-not-found",kind:"danger",open:!0,scale:"s",width:"full"},p("div",{slot:"message"},(i=this.messages)==null?void 0:i.relationshipNotFound))}_setupRelatedFeatureViewModels(){const{relatedFeatureViewModels:i}=this.viewModel,e="related-feature-viewmodels";this.removeHandles(e),i==null||i.forEach(t=>{this.addHandles(w(()=>[t.title,t.state],()=>this.scheduleRender(),P),e)}),this.scheduleRender()}_setupFeatureElementInfo(){var r;const{headingLevel:i,visibleElements:e}=this,t=e.description&&this.description,s=e.title&&this.title;(r=this._featureElementInfo)==null||r.set({description:t,title:s,headingLevel:i})}async _handleRelatedFeatureObserverChange(){this._unobserveRelatedFeatureObserver();const{state:i,showAllEnabled:e}=this.viewModel;await bi(0),this._relatedFeatureIntersectionObserverNode&&i==="ready"&&e&&this._relatedFeatureIntersectionObserver.observe(this._relatedFeatureIntersectionObserverNode)}_relatedFeatureIntersectionObserverCreated(i){this._relatedFeatureIntersectionObserverNode=i}_unobserveRelatedFeatureObserver(){this._relatedFeatureIntersectionObserverNode&&this._relatedFeatureIntersectionObserver.unobserve(this._relatedFeatureIntersectionObserverNode)}};o([l()],X.prototype,"_relatedFeatureIntersectionObserverNode",void 0),o([l({readOnly:!0})],X.prototype,"displayShowAllButton",null),o([l({readOnly:!0})],X.prototype,"displayListItems",null),o([l()],X.prototype,"description",null),o([l({readOnly:!0})],X.prototype,"featureCountDescription",null),o([l()],X.prototype,"featureVisibleElements",void 0),o([l()],X.prototype,"flowItems",void 0),o([l()],X.prototype,"flowType",void 0),o([l()],X.prototype,"headingLevel",void 0),o([l()],X.prototype,"title",null),o([l({type:Ti})],X.prototype,"viewModel",void 0),o([l(),re("esri/widgets/Feature/t9n/Feature")],X.prototype,"messages",void 0),o([l(),re("esri/t9n/common")],X.prototype,"messagesCommon",void 0),o([l()],X.prototype,"visibleElements",void 0),o([at("visibleElements")],X.prototype,"castVisibleElements",null),X=pi=o([k("esri.widgets.Feature.FeatureRelationship")],X);const Oo=X;let ft=class extends ye{constructor(e){super(e),this.title=!0,this.description=!0}};o([l({type:Boolean,nonNullable:!0})],ft.prototype,"title",void 0),o([l({type:Boolean,nonNullable:!0})],ft.prototype,"description",void 0),ft=o([k("esri.widgets.Feature.FeatureUtilityNetworkAssociations.VisibleElements")],ft);const wt=ft,Tt={fromGlobalId:"fromglobalid",fromNetworkSourceId:"fromnetworksourceid",fromTerminalId:"fromterminalid",toGlobalId:"toglobalid",toNetworkSourceId:"tonetworksourceid",toTerminalId:"toterminalid",associationType:"associationtype",globalId:"globalid",status:"status",isContentVisible:"iscontentvisible",percentAlong:"percentalong",assetGroup:"assetgroup",assetType:"assettype"},us=100;let $=class extends ks.ClonableMixin(zt.IdentifiableMixin(ye)){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.networkSourceIdsInUse=new Set,this.source="popup",this.description=null,this.graphic=null,this.layer=null,this.map=null,this.featureCount=0,this.associationTypes=null,this.showAllEnabled=!1,this.title=null,this.attachmentsFeatureCount=0,this.structureFeatureCount=0,this.contentFeatureCount=0,this.containerFeatureCount=0,this.connectivityFeatureCount=0,this._queryOpenAssociationType=async()=>{this.activeAssociationType&&await this._queryDebounced(this.activeAssociationType)},this._cancelQuery=()=>{const{_queryAbortController:t}=this;t&&t.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:t}=this;t&&t.abort(),this._queryFeatureCountAbortController=null},this._queryController=async t=>{this._cancelQuery();const s=new AbortController;this._queryAbortController=s,await De(this._query(t)),this._queryAbortController===s&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const t=new AbortController;this._queryFeatureCountAbortController=t,await De(this._queryFeatureCount()),this._queryFeatureCountAbortController===t&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryDebounced=Ne(this._queryController,us),this._queryFeatureCountDebounced=Ne(this._queryFeatureCountController,us)}initialize(){this.addHandles([w(()=>[this.graphic,this.layer,this.map,this.associationTypes,this.objectId,this.globalId,this.canQuery],()=>this.refresh(),P),w(()=>this.activeAssociationType,e=>this._queryDebounced(e),P)])}destroy(){this._cancelQuery(),this._cancelQueryFeatureCount(),this._destroyAssociatedFeatureViewModels()}get supportsCacheHint(){var e,t,s;return!!((s=(t=(e=this.layer)==null?void 0:e.capabilities)==null?void 0:t.query)!=null&&s.supportsCacheHint)}get canLoad(){return!!this.map&&!!this.associationTypes&&typeof this.globalId=="string"}get canQuery(){var t,s;const e=(s=(t=this.layer)==null?void 0:t.capabilities)==null?void 0:s.query;return!!this.associationTypes&&typeof this.globalId=="string"&&!!(e!=null&&e.supportsPagination)}set displayCount(e){this._set("displayCount",Math.max(e??3,0))}get displayCount(){return this._get("displayCount")}get objectId(){var e,t;return(this.objectIdField&&((t=(e=this.graphic)==null?void 0:e.attributes)==null?void 0:t[this.objectIdField]))??null}get objectIdField(){var e;return((e=this.layer)==null?void 0:e.objectIdField)||null}get globalId(){var e,t;return(this.globalIdField&&((t=(e=this.graphic)==null?void 0:e.attributes)==null?void 0:t[this.globalIdField]))??null}get globalIdField(){const{layer:e}=this;return e==null?void 0:e.globalIdField}get activeAssociationType(){return this._get("activeAssociationType")}set activeAssociationType(e){e&&!this.associationTypes.includes(e)||this._set("activeAssociationType",e)}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:t,_queryPageAbortController:s,canQuery:r,_loaded:n,canLoad:a,source:d}=this;return t||a&&!n?"loading":e||s?"querying":!r||d==="popup"&&this.featureCount===0?"disabled":"ready"}get utilityNetwork(){const{layer:e,map:t}=this;if(!(e!=null&&e.loaded)||!t)return null;const s=ji(e)?e.parent:e;return dn(t,s)}get attachmentsAssociations(){return this._get("attachmentsAssociations")||new G}get structureAssociations(){return this._get("structureAssociations")||new G}get contentAssociations(){return this._get("contentAssociations")||new G}get containerAssociations(){return this._get("containerAssociations")||new G}get connectivityAssociations(){return this._get("connectivityAssociations")||new G}get associationFeatures(){return this._get("associationFeatures")||new wi}get associationViewModels(){return this._get("associationViewModels")||new Map}async refresh(){await this._queryFeatureCountDebounced(),await this._queryOpenAssociationType()}getFeatureCountForAssociationType(e){switch(e){case"attachment":return this.attachmentsFeatureCount;case"structure":return this.structureFeatureCount;case"content":return this.contentFeatureCount;case"container":return this.containerFeatureCount;case"connectivity":return this.connectivityFeatureCount}}_destroyAssociatedFeatureViewModels(){this.associationViewModels.forEach(e=>e.destroyAll())}async _loadUtiltyNetworks(){var s;const e=this.map;if(!e)return;await Promise.allSettled(((s=e.utilityNetworks)==null?void 0:s.map(async r=>{await r.load()}))??[]);const t=this.utilityNetwork;if(t){const r=n=>{if("layerId"in n&&t.isUtilityLayer(n)){const a=t.getSourceIdByLayerId(n.layerId);a!==null&&this.networkSourceIdsInUse.add(a)}};this._set("networkSourceIdsInUse",new Set),e.allLayers.forEach(r),e.allTables.forEach(r)}}async _findLayersBySourceId(e){const{utilityNetwork:t,map:s}=this,r=u=>{const h=u;return u.url&&h.layerId===n?u.url.replace(/\/\d+$/,"")===(t==null?void 0:t.featureServiceUrl):!1};await(t==null?void 0:t.load());const n=t.getLayerIdBySourceId(e),a=s.allLayers.filter(r),d=s.allTables.filter(r),c=a.concat(d).toArray();return await Promise.allSettled(c.map(u=>u.load())),c}_clearAssociations(){this.attachmentsAssociations.removeAll(),this.structureAssociations.removeAll(),this.contentAssociations.removeAll(),this.containerAssociations.removeAll(),this.connectivityAssociations.removeAll()}_clearFeatures(){this.associationFeatures.forEach(e=>e.removeAll()),this.associationFeatures.clear()}_getAssociationsByType(e){switch(e){case"attachment":return this.attachmentsAssociations;case"structure":return this.structureAssociations;case"connectivity":return this.connectivityAssociations;case"container":return this.containerAssociations;case"content":return this.contentAssociations}}async _queryLayer(e,t,s,r,n){const a=e.fieldsIndex.get(Tt.assetGroup),d=e.fieldsIndex.get(Tt.assetType),c=s!=null,u=r!=null,h="("+t.map(v=>`'${v}'`).join(", ")+")",m=c?` AND ${a==null?void 0:a.name} = ${s}`:"",f=c&&u?` AND ${d==null?void 0:d.name} = ${r}`:"",g=`${e.globalIdField} IN ${h}`+m+f,y=new Vt({outFields:["*"],cacheHint:this.supportsCacheHint,where:g});return await this._queryAll(y,e,{signal:n==null?void 0:n.signal})}async _createAssociationFeatureObjects(e,t,s,r,n,a){if(e.length===0)return[];const d=new Map;for(const[u,h]of t){const m=await this._findLayersBySourceId(u);for(const f of m)(await this._queryLayer(f,h,r,n,a)).forEach(g=>{if(this.source==="popup"?g.layer&&g.getEffectivePopupTemplate():g.layer){const y=d.get(g.attributes[f.globalIdField])??[];y.push(g),d.set(g.attributes[f.globalIdField],y)}})}const c=[];return await Promise.all(e.toArray().map(async u=>{const{fromNetworkElement:h,toNetworkElement:m}=u,f=h.globalId===s?m:h,g=d.get(f.globalId)??[];await Promise.all(g.map(async y=>{var b,I;const v=(I=(b=this.utilityNetwork)==null?void 0:b.getTerminalById(f==null?void 0:f.terminalId))==null?void 0:I.name;if(y.layer&&"getFeatureTitle"in y.layer){const M=await y.layer.getFeatureTitle(y);c.push({title:M,association:u,feature:y,terminalName:v})}else c.push({association:u,feature:y,terminalName:v})}))})),c}_parseFeatureObjects(e,t){e.forEach(s=>{const r=s==null?void 0:s.feature,n=r.layer,a=t.get(n)??new G;a.add(s),t.set(n,a)})}async _queryAll(e,t,s){var d;const r=[];let n=0,a=!1;e.num=((d=t.sourceJSON)==null?void 0:d.maxRecordCount)??2e3;do{e.start=n;const c=await t.queryFeatures(e,s);r.push(...c.features),a=c.exceededTransferLimit,a&&(n+=c.features.length)}while(a);return r}async _queryAssociations(e){const{layer:t,globalId:s,associationTypes:r,utilityNetwork:n,canQuery:a}=this;if(await Promise.allSettled([t==null?void 0:t.load(),n==null?void 0:n.load()]),this._clearAssociations(),!(a&&t&&r&&n&&s))return;const d=ji(t)?t.parent:t,c=new $n({globalId:s,networkSourceId:n.getSourceIdByLayerId(d.layerId)}),u=new Set;r.forEach(y=>{switch(y.type){case"attachment":case"structure":u.add("attachment");break;case"container":case"content":u.add("containment");break;case"connectivity":u.add("connectivity"),u.add("junction-junction-connectivity"),u.add("junction-edge-from-connectivity"),u.add("junction-edge-midspan-connectivity"),u.add("junction-edge-to-connectivity")}});const h=await(n==null?void 0:n.queryAssociations({elements:[c],types:Array.from(u)},{signal:e==null?void 0:e.signal})),m=new Map,f=new Map;r.forEach(y=>{f.set(y.type,y),m.set(y.type,[])}),h.forEach(y=>{var I,M,E,N,D,O;const{toNetworkElement:v,fromNetworkElement:b}=y;switch(y.associationType){case"connectivity":case"junction-junction-connectivity":case"junction-edge-from-connectivity":case"junction-edge-midspan-connectivity":case"junction-edge-to-connectivity":if((b==null?void 0:b.globalId)===s){if(this._shouldDiscardNetworkElement(v,"connectivity",f))break;(I=m.get("connectivity"))==null||I.push(v.globalId)}else{if(this._shouldDiscardNetworkElement(b,"connectivity",f))break;(M=m.get("connectivity"))==null||M.push(b.globalId)}this.connectivityAssociations.add(y);break;case"containment":if((b==null?void 0:b.globalId)===s){if(this._shouldDiscardNetworkElement(v,"content",f))break;(E=m.get("content"))==null||E.push(v.globalId),this.contentAssociations.add(y)}else{if(this._shouldDiscardNetworkElement(b,"container",f))break;(N=m.get("container"))==null||N.push(b.globalId),this.containerAssociations.add(y)}break;case"attachment":if((b==null?void 0:b.globalId)===s){if(this._shouldDiscardNetworkElement(v,"attachment",f))break;(D=m.get("attachment"))==null||D.push(v.globalId),this.attachmentsAssociations.add(y)}else{if(this._shouldDiscardNetworkElement(b,"structure",f))break;(O=m.get("structure"))==null||O.push(b.globalId),this.structureAssociations.add(y)}}});const g=r.map(async y=>{const{associatedNetworkSourceId:v,associatedAssetGroup:b,associatedAssetType:I}=y,M=m.get(y.type),E=b!=null?await this._countAssociatedFeatures(v,M,b,I,e):M.length;switch(y.type){case"attachment":this._set("attachmentsFeatureCount",E);break;case"structure":this._set("structureFeatureCount",E);break;case"content":this._set("contentFeatureCount",E);break;case"container":this._set("containerFeatureCount",E);break;case"connectivity":this._set("connectivityFeatureCount",E)}});await Promise.allSettled(g)}async _countAssociatedFeatureCount(e,t,s,r,n){const a=e.fieldsIndex.get(Tt.assetGroup),d=e.fieldsIndex.get(Tt.assetType),c=r!=null,u="("+t.map(g=>`'${g}'`).join(", ")+")",h=` AND ${a==null?void 0:a.name} = ${s}`,m=c?` AND ${d==null?void 0:d.name} = ${r}`:"",f=`${e.globalIdField} IN ${u}`+h+m;return e.queryFeatureCount({where:f,outFields:["*"],returnGeometry:!1},{signal:n==null?void 0:n.signal})}async _countAssociatedFeatures(e,t,s,r,n){if(t.length===0)return 0;const a=(await this._findLayersBySourceId(e)).map(async d=>this._countAssociatedFeatureCount(d,t,s,r,n));return(await Promise.all(a)).reduce((d,c)=>d+c,0)}async _queryAssociatedFeatures(e,t){const{layer:s,globalId:r,associationTypes:n,utilityNetwork:a,canQuery:d,associationFeatures:c}=this;if(await Promise.allSettled([s==null?void 0:s.load(),a==null?void 0:a.load()]),!(d&&s&&n&&a))return;const u=this._getAssociationsByType(e.type),{associatedAssetGroup:h,associatedAssetType:m}=e,f=new Map;u.forEach(y=>{const{fromNetworkElement:v,toNetworkElement:b}=y,{networkSourceId:I,elementGlobalId:M}=v.globalId===r?{networkSourceId:b.networkSourceId,elementGlobalId:b.globalId}:{networkSourceId:v.networkSourceId,elementGlobalId:v.globalId},E=f.get(I)||[];E.push(M),f.set(I,E)});const g=await this._createAssociationFeatureObjects(u,f,r,h,m,t);this._parseFeatureObjects(g,c)}async _queryFeatureCount(){await this._loadUtiltyNetworks();const{_queryFeatureCountAbortController:e,canQuery:t}=this;t?(await this._queryAssociations(e),this._set("featureCount",this.attachmentsFeatureCount+this.structureFeatureCount+this.contentFeatureCount+this.containerFeatureCount+this.connectivityFeatureCount)):this._set("featureCount",0)}async _query(e){if(!e)return;await this._loadUtiltyNetworks();const{_queryAbortController:t}=this;this._destroyAssociatedFeatureViewModels(),this._clearFeatures(),this.featureCount!==0&&(this.destroyed||await this._queryAssociatedFeatures(e,{signal:t==null?void 0:t.signal}))}_shouldDiscardNetworkElement(e,t,s){var c;if(!e)return!1;const{networkSourceIdsInUse:r}=this,{networkSourceId:n}=e,a=(c=s.get(t))==null?void 0:c.associatedNetworkSourceId,d=r.has(n);return a!=null&&a!==n||!d}};o([l()],$.prototype,"_loaded",void 0),o([l()],$.prototype,"_queryAbortController",void 0),o([l()],$.prototype,"_queryPageAbortController",void 0),o([l()],$.prototype,"_queryFeatureCountAbortController",void 0),o([l({readOnly:!0})],$.prototype,"supportsCacheHint",null),o([l({readOnly:!0})],$.prototype,"canLoad",null),o([l({readOnly:!0})],$.prototype,"canQuery",null),o([l()],$.prototype,"networkSourceIdsInUse",void 0),o([l({constructOnly:!0})],$.prototype,"source",void 0),o([l()],$.prototype,"description",void 0),o([l({value:3})],$.prototype,"displayCount",null),o([l({type:Ye})],$.prototype,"graphic",void 0),o([l()],$.prototype,"layer",void 0),o([l()],$.prototype,"map",void 0),o([l({readOnly:!0})],$.prototype,"objectId",null),o([l({readOnly:!0})],$.prototype,"objectIdField",null),o([l({readOnly:!0})],$.prototype,"globalId",null),o([l({readOnly:!0})],$.prototype,"globalIdField",null),o([l()],$.prototype,"featureCount",void 0),o([l()],$.prototype,"associationTypes",void 0),o([l()],$.prototype,"activeAssociationType",null),o([l()],$.prototype,"showAllEnabled",void 0),o([l()],$.prototype,"state",null),o([l()],$.prototype,"title",void 0),o([l({readOnly:!0})],$.prototype,"utilityNetwork",null),o([l({readOnly:!0})],$.prototype,"attachmentsFeatureCount",void 0),o([l({readOnly:!0})],$.prototype,"structureFeatureCount",void 0),o([l({readOnly:!0})],$.prototype,"attachmentsAssociations",null),o([l({readOnly:!0})],$.prototype,"structureAssociations",null),o([l({readOnly:!0})],$.prototype,"contentFeatureCount",void 0),o([l({readOnly:!0})],$.prototype,"containerFeatureCount",void 0),o([l({readOnly:!0})],$.prototype,"contentAssociations",null),o([l({readOnly:!0})],$.prototype,"containerAssociations",null),o([l({readOnly:!0})],$.prototype,"connectivityFeatureCount",void 0),o([l({readOnly:!0})],$.prototype,"connectivityAssociations",null),o([l({readOnly:!0})],$.prototype,"associationFeatures",null),o([l({readOnly:!0})],$.prototype,"associationViewModels",null),$=o([k("esri.widgets.support.UtilityNetworkAssociations.FeatureUtilityNetworkAssociationsViewModel")],$);const Ke=$,$t="esri-utility-network-association-list",xt={featureObserver:`${$t}__feature-observer`,filterContainer:`${$t}__filter-container`,limitNoticeContainer:`${$t}__limit-notice-container`,loadingContainer:`${$t}__loading-container`};let ie=class extends he{constructor(e,t){super(e,t),this._isFeatureCountNoticeOpen=!0,this._observer=new IntersectionObserver(([s])=>{s!=null&&s.isIntersecting&&this._increaseFeaturePage()},{root:window.document}),this._observerNode=null,this.featuresPerPage=50,this.filterText="",this.headingLevel=5,this.maxFeatureCount=1e3,this.messagesFeature=null,this.messagesCommon=null,this.selectedLayer=null,this.tooltipReferenceMap=new wi,this.viewModel=new Ke}initialize(){this.setUpObserver()}loadDependencies(){return Fe({icon:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vV),__vite__mapDeps([0,1]),import.meta.url),input:()=>_(()=>import("./index-CYq2AVbR.js"),__vite__mapDeps([42,0,1,41]),import.meta.url),loader:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vU),__vite__mapDeps([0,1]),import.meta.url),notice:()=>_(()=>import("./index-CpwZb1xc.js"),__vite__mapDeps([50,0,1]),import.meta.url)})}destroy(){this.tooltipReferenceMap.clear()}get associatedFeatureCount(){const e=this.viewModel.associationViewModels,t=this.selectedLayer?e.get(this.selectedLayer):null;return t?t.length:0}set currentFeaturePage(e){const{featuresPerPage:t,associatedFeatureCount:s}=this,r=Math.ceil(s/t)||1,n=Math.max(Math.min(e,r),1);this._set("currentFeaturePage",n)}get currentFeaturePage(){return this._get("currentFeaturePage")??1}get endIndex(){const{currentFeaturePage:e,featuresPerPage:t,maxFeatureCount:s}=this;return Math.min(e*t,s)}renderConnectivityIcon(e,t){const{tooltipReferenceMap:s}=this;let r;switch(e){case"junction-edge-from-connectivity":r="connection-end-left";break;case"junction-edge-to-connectivity":r="connection-end-right";break;case"junction-edge-midspan-connectivity":r="connection-middle";break;default:r="connection-to-connection"}return p("calcite-icon",{afterCreate:n=>s.set(t,n),afterRemoved:()=>s.delete(t),icon:r,scale:"s",slot:"content-start"})}renderFeatureCountWarning(){const{associatedFeatureCount:e,maxFeatureCount:t,messagesFeature:s}=this;return e>t?p("calcite-notice",{class:this._isFeatureCountNoticeOpen?xt.limitNoticeContainer:void 0,closable:!0,icon:"information",kind:"info",open:!0,scale:"s",width:"full",onCalciteNoticeBeforeOpen:()=>this._isFeatureCountNoticeOpen=!0,onCalciteNoticeClose:()=>this._isFeatureCountNoticeOpen=!1},p("div",{slot:"title"},s.associationsLimitNoticeTitle),p("div",{slot:"message"},me(s.associationsLimitNoticeMessage,{number:t}))):null}renderFeatureObserver(){return p("div",{afterCreate:this._onObserverCreate,bind:this,class:xt.featureObserver,key:"feature-observer"})}renderFilter(){return p("div",{class:xt.filterContainer,key:"filter"},p("calcite-input",{icon:"search",placeholder:this.messagesFeature.associationFilterPlaceholder,type:"search",onCalciteInputInput:e=>{this.filterText=e.currentTarget.value.trim().toLowerCase(),this.currentFeaturePage=1}}))}renderLoading(){return p("div",{class:xt.loadingContainer,key:"loading-container"},this.renderLoadingIcon())}renderLoadingIcon(){return p("calcite-loader",{inline:!0,label:this.messagesCommon.loading})}getConnectivityTooltip(e){const{messagesFeature:t}=this;switch(e){case"connectivity":case"junction-junction-connectivity":return t.associationsJunctionJunction;case"junction-edge-from-connectivity":return t.associationsJunctionEdgeFrom;case"junction-edge-midspan-connectivity":return t.associationsJunctionEdgeMidspan;case"junction-edge-to-connectivity":return t.associationsJunctionEdgeTo;default:return""}}setUpObserver(){this.addHandles(w(()=>this._observerNode,()=>this._onObserverChange()))}_increaseFeaturePage(){this.currentFeaturePage++}async _onObserverChange(){this._observerNode&&this._observer.unobserve(this._observerNode);const{state:e,showAllEnabled:t}=this.viewModel;this._observerNode&&e==="ready"&&t&&this._observer.observe(this._observerNode)}_onObserverCreate(e){this._observerNode=e}};o([l()],ie.prototype,"_observer",void 0),o([l()],ie.prototype,"_observerNode",void 0),o([l()],ie.prototype,"associatedFeatureCount",null),o([l()],ie.prototype,"currentFeaturePage",null),o([l()],ie.prototype,"endIndex",null),o([l()],ie.prototype,"featuresPerPage",void 0),o([l()],ie.prototype,"filterText",void 0),o([l()],ie.prototype,"headingLevel",void 0),o([l()],ie.prototype,"maxFeatureCount",void 0),o([l(),re("esri/widgets/Feature/t9n/Feature")],ie.prototype,"messagesFeature",void 0),o([l(),re("esri/t9n/common")],ie.prototype,"messagesCommon",void 0),o([l()],ie.prototype,"selectedLayer",void 0),o([l()],ie.prototype,"tooltipReferenceMap",void 0),o([l({type:Ke})],ie.prototype,"viewModel",void 0),ie=o([k("esri.widgets.support.UtilityNetworkAssociations.UtilityNetworkAssociationList")],ie);const No=ie;var mi;const hs="esri-feature-utility-network-associations",ps={base:hs,listItemHidden:`${hs}__list-item--hidden`},Do="nested";let ge=mi=class extends No{constructor(i,e){super(i,e),this.description=null,this.flowItems=null,this.flowType="feature-utility-network-association-type",this.listType=null,this.parentFeatureViewModel=null,this.title=null,this.viewModel=new Ke,this.visibleElements=new wt}initialize(){this.setUpObserver()}loadDependencies(){return Fe({chip:()=>_(()=>import("./index-Diog0XOc.js"),__vite__mapDeps([51,0,1]),import.meta.url),icon:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vV),__vite__mapDeps([0,1]),import.meta.url),list:()=>_(()=>import("./index-BoOF33T4.js"),__vite__mapDeps([40,0,1,41,42,43]),import.meta.url),"list-item":()=>_(()=>import("./index-D9YxSY9e.js"),__vite__mapDeps([44,0,1,45,46,47,48,43,49]),import.meta.url),tooltip:()=>_(()=>import("./index-Bjr6sB9h.js"),__vite__mapDeps([52,0,1]),import.meta.url)})}destroy(){this.tooltipReferenceMap.clear()}render(){var r;const i=this.viewModel.associationViewModels,{state:e,showAllEnabled:t}=this.viewModel,{state:s}=this.parentFeatureViewModel??{};return p("div",{class:this.classes(ps.base,T.widget)},e==="loading"||e==="querying"||s==="loading"?this.renderLoading():p("calcite-list",{displayMode:Do,label:((r=this.selectedLayer)==null?void 0:r.title)??this.messagesCommon.untitled},t&&this.selectedLayer?p(Vs,null,this.renderFilter(),this.renderFeatureCountWarning(),this._renderAssociatedFeatureListPage(),this.renderFeatureObserver()):Array.from(i.keys(),n=>this._renderTypeList(n,i.get(n)))))}_showAllAssociations(i){const{flowItems:e,viewModel:t,description:s}=this;if(!e||!i)return;t.showAllEnabled=!0;const r=new mi({selectedLayer:i,title:i==null?void 0:i.title,flowItems:e,parentFeatureViewModel:this.parentFeatureViewModel,featureVisibleElements:this.featureVisibleElements,description:s,visibleElements:new wt({title:!1,description:!1}),viewModel:t});e.push(r)}_renderAssociatedFeatureListPage(){const i=this.viewModel.associationViewModels.get(this.selectedLayer).filter(e=>Ut(e.featureViewModel).toLowerCase().includes(this.filterText)).slice(0,this.endIndex);return[...this._renderTooltips(i),...this._renderAssociatedFeatureList(i)]}_renderItemTooltip(i){const{tooltipReferenceMap:e}=this;return ds(i.association)?p("calcite-tooltip",{key:`tooltip-${i.featureViewModel.uid}`,overlayPositioning:"fixed",referenceElement:e.get(i.featureViewModel.uid)},this.getConnectivityTooltip(i.association.associationType)):null}_renderAssociatedFeature(i){const{featureViewModel:e}=i,t=Ut(e),s=e.state==="loading",r=this._findFlowItem(e),n=r<0&&this._isParentFeature(e),a=n||r>=0;return p("calcite-list-item",{class:s?ps.listItemHidden:void 0,description:i.terminalName??"",key:`associated-feature-type-${e.uid}`,label:t,onCalciteListItemSelect:()=>this._handleFeatureClick(n,r,e)},ds(i.association)?this.renderConnectivityIcon(i.association.associationType,i.featureViewModel.uid):null,So(i.association)?p("calcite-chip",{label:ls(i.association),scale:"s",slot:"content-end"},ls(i.association)):null,this._renderChevronIconNode(a))}async _selectAssociation(i){const{flowItems:e,featureVisibleElements:t}=this;if(!e)return;i.abilities={utilityNetworkAssociationsContent:!0};const{default:s}=await _(()=>Promise.resolve().then(()=>Js),void 0,import.meta.url);e.push(new s({flowItems:e,flowType:"feature-association",viewModel:i,visibleElements:t}))}_handleFeatureClick(i,e,t){if(i)this.flowItems.drain(s=>{"showAllEnabled"in s.viewModel&&(s.viewModel.showAllEnabled=!1),s.viewModel=null,s.destroy()});else if(e<0||!this.flowItems)this._selectAssociation(t);else for(;this.flowItems.length>e+1;){const s=this.flowItems.pop();s&&("showAllEnabled"in s.viewModel&&(s.viewModel.showAllEnabled=!1),s.viewModel=null,s.destroy())}}_featureViewModelMatch(i,e){const t=i.graphic,s=t==null?void 0:t.layer;let r=null;(s==null?void 0:s.type)==="subtype-sublayer"&&s.parent?r=s.parent.globalIdField??null:s&&"globalIdField"in s&&(r=s.globalIdField);const n=r?t==null?void 0:t.attributes[r]:null,a=e.graphic,d=a==null?void 0:a.layer;let c=null;(d==null?void 0:d.type)==="subtype-sublayer"&&d.parent?c=d.parent.globalIdField??null:d&&"globalIdField"in d&&(c=d.globalIdField);const u=c?a==null?void 0:a.attributes[c]:null;return n&&u&&n===u}_isParentFeature(i){var s;const e=(s=this.flowItems)==null?void 0:s.getItemAt(0);if(!e)return!1;const t=e.parentFeatureViewModel;return this._featureViewModelMatch(t,i)}_findFlowItem(i){var e;return((e=this.flowItems)==null?void 0:e.findIndex(t=>{if(t.flowType!=="feature-association")return!1;const s=t.viewModel;return this._featureViewModelMatch(s,i)}))??-1}_renderTooltips(i){return i.toArray().map(e=>this._renderItemTooltip(e))}_renderAssociatedFeatureList(i){return i.toArray().map(e=>this._renderAssociatedFeature(e))}_renderChevronIconNode(i){return p("calcite-icon",{flipRtl:!0,icon:i?"move-up":"chevron-right",scale:"s",slot:"content-end"})}_renderTypeList(i,e){const{messagesFeature:t}=this,{displayCount:s}=this.viewModel,r=e.slice(0,s),n=r.length<e.length;return p("calcite-list-item",{key:"show-all",label:i.title,open:!0,value:i.id},p("calcite-chip",{label:String(e.length),scale:"s",slot:"actions-end"},e.length),p("calcite-list",{group:i.id,label:i.title??""},[this._renderTooltips(r),this._renderAssociatedFeatureList(r)],n?p("calcite-list-item",{description:me(t==null?void 0:t.numberRecords,{number:e.length.toString()}),key:"show-all-item",label:t.showAll,onCalciteListItemSelect:()=>this._showAllAssociations(i)},p("calcite-icon",{icon:"list",scale:"s",slot:"content-end"})):null))}};o([l()],ge.prototype,"description",void 0),o([l()],ge.prototype,"featureVisibleElements",void 0),o([l()],ge.prototype,"flowItems",void 0),o([l()],ge.prototype,"flowType",void 0),o([l()],ge.prototype,"listType",void 0),o([l()],ge.prototype,"parentFeatureViewModel",void 0),o([l()],ge.prototype,"title",void 0),o([l({type:Ke})],ge.prototype,"viewModel",void 0),o([l({type:wt,nonNullable:!0})],ge.prototype,"visibleElements",void 0),ge=mi=o([k("esri.widgets.Feature.FeatureUtilityNetworkAssociationList")],ge);const Bo=ge,gi="esri-feature-utility-network-associations",ms=`${gi}__loading-container`,kt={base:gi,listContainer:`${gi}__list`,loadingContainer:ms,loadingContainerSticky:`${ms}--sticky`};let ue=class extends he{constructor(e,t){super(e,t),this._featureElementInfo=null,this.onSelectAssociationType=()=>{},this.flowType="feature-utility-network-associations",this.flowItems=null,this.parentFeatureViewModel=null,this.headingLevel=5,this.viewModel=new Ke,this.messages=null,this.messagesCommon=null,this.visibleElements=new wt}initialize(){this._featureElementInfo=new It,this.addHandles([w(()=>[this.viewModel.description,this.viewModel.title,this.headingLevel],()=>this._setupFeatureElementInfo(),P)])}loadDependencies(){return Fe({icon:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vV),__vite__mapDeps([0,1]),import.meta.url),list:()=>_(()=>import("./index-BoOF33T4.js"),__vite__mapDeps([40,0,1,41,42,43]),import.meta.url),"list-item":()=>_(()=>import("./index-D9YxSY9e.js"),__vite__mapDeps([44,0,1,45,46,47,48,43,49]),import.meta.url),loader:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vU),__vite__mapDeps([0,1]),import.meta.url),notice:()=>_(()=>import("./index-CpwZb1xc.js"),__vite__mapDeps([50,0,1]),import.meta.url)})}destroy(){this._featureElementInfo=Ls(this._featureElementInfo)}get description(){return this.viewModel.description}set description(e){this.viewModel.description=e}get title(){return this.viewModel.title}set title(e){this.viewModel.title=e}render(){var t;const{state:e}=this.viewModel;return p("div",{class:this.classes(kt.base,T.widget)},(t=this._featureElementInfo)==null?void 0:t.render(),e==="loading"?this._renderLoading():e==="disabled"?this._renderAssociationNotFound():this._renderContent())}_renderStickyLoading(){return this.viewModel.state==="querying"?p("div",{class:kt.loadingContainerSticky,key:"sticky-loader"},this._renderLoadingIcon()):null}_renderLoadingIcon(){return p("calcite-loader",{inline:!0,label:this.messagesCommon.loading})}_renderLoading(){return p("div",{class:kt.loadingContainer,key:"loading-container"},this._renderLoadingIcon())}_renderAssociationNotFound(){var e;return p("calcite-notice",{icon:"exclamation-mark-triangle",key:"association-not-found",kind:"danger",open:!0,scale:"s",width:"full"},p("div",{slot:"message"},(e=this.messages)==null?void 0:e.noAssociations))}_renderAssociationType(e){const{viewModel:t}=this,s=this._getAssociationTypeTitle(e);return p("calcite-list-item",{description:e.description,key:`association-type-${e.type}`,label:s,value:e.type,onCalciteListItemSelect:()=>this.onSelectAssociationType({viewModel:t,listType:e,title:s})},p("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s",slot:"content-end"}))}_renderAssociations(e){const{viewModel:t}=this;return t.source==="featureForm"||t.getFeatureCountForAssociationType(e.type)>0?this._renderAssociationType(e):void 0}_renderContent(){const{messages:e,viewModel:t}=this,{state:s,associationTypes:r}=t;return p("div",{class:kt.listContainer,key:"list-container"},s==="ready"?p("div",null,p("calcite-list",{displayMode:"flat",label:e==null?void 0:e.associationsList},r.map(n=>this._renderAssociations(n)))):null,this._renderStickyLoading())}_getAssociationTypeTitle(e){const{messages:t}=this;if(e.title)return e.title;switch(e.type){case"attachment":return t.associationsAttachments;case"connectivity":return t.associationsConnectivity;case"structure":return t.associationsStructure;case"content":return t.associationsContents;case"container":return t.associationsContainer}}_setupFeatureElementInfo(){var n;const{headingLevel:e,visibleElements:t}=this,s=t.description&&this.description,r=t.title&&this.title;(n=this._featureElementInfo)==null||n.set({description:s,title:r,headingLevel:e})}};o([l({constructOnly:!0})],ue.prototype,"onSelectAssociationType",void 0),o([l()],ue.prototype,"flowType",void 0),o([l()],ue.prototype,"flowItems",void 0),o([l()],ue.prototype,"parentFeatureViewModel",void 0),o([l()],ue.prototype,"featureVisibleElements",void 0),o([l()],ue.prototype,"description",null),o([l()],ue.prototype,"headingLevel",void 0),o([l()],ue.prototype,"title",null),o([l({type:Ke})],ue.prototype,"viewModel",void 0),o([l(),re("esri/widgets/Feature/t9n/Feature")],ue.prototype,"messages",void 0),o([l(),re("esri/t9n/common")],ue.prototype,"messagesCommon",void 0),o([l({type:wt,nonNullable:!0})],ue.prototype,"visibleElements",void 0),ue=o([k("esri.widgets.Feature.FeatureUtilityNetworkAssociations")],ue);const qo=ue;let Uo=class{constructor(e,t){this.preLayerQueryCallback=e,this.preRequestCallback=t,this.preLayerQueryCallback||(this.preLayerQueryCallback=s=>{}),this.preRequestCallback||(this.preLayerQueryCallback=s=>{})}};var st;const gs=1,fs="content-view-models",ys="relationship-view-models",jo="association-view-models",vs={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0,relationshipContent:!0,utilityNetworkAssociationsContent:!0};let R=st=class extends zt.IdentifiableMixin(ye){constructor(i){super(i),this._error=null,this._graphicChangedTask=null,this._evaluateExpressionAttributesTask=null,this._associationVMAbortController=null,this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities={...vs},this.content=null,this.contentViewModels=[],this.description=null,this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.location=null,this.relatedInfos=new Map,this.title="",this.view=null,this._graphicChangedThrottled=_t(this._graphicChanged,()=>this.notifyChange("waitingForContent"),gs,this),this._isAllowedContentType=e=>{const{abilities:t}=this;return e.type==="attachments"&&!!t.attachmentsContent||e.type==="custom"&&!!t.customContent||e.type==="fields"&&!!t.fieldsContent||e.type==="media"&&!!t.mediaContent||e.type==="text"&&!!t.textContent||e.type==="expression"&&!!t.expressionContent||e.type==="relationship"&&!!t.relationshipContent||e.type==="utility-network-associations"&&!!t.utilityNetworkAssociationsContent},this._evaluateExpressionAttributesThrottled=_t(this._evaluateExpressionAttributes,()=>this.notifyChange("waitingForContent"),gs,this),this.addHandles([w(()=>[this.graphic,this._effectivePopupTemplate,this.abilities,this.timeZone],()=>this._graphicChangedThrottled(),P),Je(()=>{var s,r,n,a,d,c,u;if(!((s=this._graphicChangedTask)!=null&&s.finished)||this._graphicChangedTask.value==null)return null;const e=this._graphicChangedTask.value,t=(r=e==null?void 0:e.expressionInfos)==null?void 0:r.dependencies;return[e,t!=null&&t.has("view-scale")?(n=this.view)==null?void 0:n.scale:null,t!=null&&t.has("view-time-extent")?(d=(a=this.view)==null?void 0:a.timeExtent)==null?void 0:d.start:null,t!=null&&t.has("view-time-extent")?(u=(c=this.view)==null?void 0:c.timeExtent)==null?void 0:u.end:null]},([e])=>this._evaluateExpressionAttributesThrottled(e))])}initialize(){this.addHandles([this._graphicChangedThrottled,this._evaluateExpressionAttributesThrottled])}destroy(){this._clear(),this._graphicChangedTask=Ae(this._graphicChangedTask),this._evaluateExpressionAttributesTask=Ae(this._evaluateExpressionAttributesTask),this._error=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return this.graphic!=null?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return cn(zi(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return Ns(this.graphic)}castAbilities(i){return{...vs,...i}}get isTable(){var i;return((i=this._sourceLayer)==null?void 0:i.isTable)||!1}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(i){this._set("graphic",(i==null?void 0:i.clone())??null)}get spatialReference(){var i;return((i=this.view)==null?void 0:i.spatialReference)??null}set spatialReference(i){this._override("spatialReference",i)}get timeZone(){var i;return((i=this.view)==null?void 0:i.timeZone)??Ps}set timeZone(i){this._overrideIfSome("timeZone",i)}get map(){var i;return((i=this.view)==null?void 0:i.map)||null}set map(i){this._override("map",i)}get waitingForContent(){const{_graphicChangedThrottled:i,_evaluateExpressionAttributesThrottled:e,_graphicChangedTask:t,_evaluateExpressionAttributesTask:s,_associationVMAbortController:r}=this;return i.hasPendingUpdates()||e.hasPendingUpdates()||t!=null&&!t.finished||s!=null&&!s.finished||!!r}setActiveMedia(i,e){const t=this.contentViewModels[i];t instanceof Ze&&t.setActiveMedia(e)}nextMedia(i){const e=this.contentViewModels[i];e instanceof Ze&&e.next()}previousMedia(i){const e=this.contentViewModels[i];e instanceof Ze&&e.previous()}async updateGeometry(){var a;const{graphic:i,spatialReference:e,_sourceLayer:t}=this;await(t==null?void 0:t.load());const s=t==null?void 0:t.objectIdField;if(!s||!i||!t)return;const r=(a=i==null?void 0:i.attributes)==null?void 0:a[s];if(r==null)return;const n=[r];if(!i.geometry){const d=await un({layer:t,graphic:i,outFields:[],objectIds:n,returnGeometry:!0,spatialReference:e}),c=d==null?void 0:d.geometry;c&&(i.geometry=c)}}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}_graphicChanged(){this._evaluateExpressionAttributesTask=Ae(this._evaluateExpressionAttributesTask),this._graphicChangedTask=Ae(this._graphicChangedTask),this._graphicChangedTask=Bt(async i=>{this._error=null,this._clear();const{graphic:e}=this;try{if(!e)return null;const{_sourceLayer:t,_effectivePopupTemplate:s}=this,r=this.spatialReference;await hn({graphic:e,popupTemplate:s,layer:t,spatialReference:r},{signal:i});const[{value:n},{value:a}]=await nt([this._getContent(),this._getTitle()]),[,{value:d}]=await nt([this._checkForRelatedFeatures({signal:i}),vo(s==null?void 0:s.expressionInfos,e)]);return{expressionInfos:d,content:n,title:a}}catch(t){throw vt(t)||(this._error=t,se.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:t,graphic:e,popupTemplate:this._effectivePopupTemplate})),t}})}_compileContentElement(i,e){return i.type==="attachments"?this._compileAttachments(i,e):i.type==="custom"?this._compileCustom(i,e):i.type==="fields"?this._compileFields(i,e):i.type==="media"?this._compileMedia(i,e):i.type==="text"?this._compileText(i,e):i.type==="expression"?this._compileExpression(i,e):i.type==="relationship"?this._compileRelationship(i,e):i.type==="utility-network-associations"?this._compileUtilityNetworkAssociation(i,e):void 0}_compileContent(i){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(i)?i.filter(this._isAllowedContentType).map((e,t)=>this._compileContentElement(e,t)).filter(ot):typeof i=="string"?this._compileText(new Ts({text:i}),0).text:i}_destroyContentViewModels(){this.removeHandles(ys),this.removeHandles(fs),this.contentViewModels.forEach(i=>i&&!i.destroyed&&i.destroy()),this._set("contentViewModels",[])}_matchesFeature(i,e){var r;const t=(r=i==null?void 0:i.graphic)==null?void 0:r.getObjectId(),s=e==null?void 0:e.getObjectId();return t!=null&&s!=null&&t===s}_setRelatedFeaturesViewModels({relatedFeatureViewModels:i,relatedFeatures:e,map:t}){const{view:s,spatialReference:r,timeZone:n}=this;e==null||e.filter(Boolean).forEach(a=>{i.some(d=>this._matchesFeature(d,a))||i.add(new st({abilities:{relationshipContent:!1},map:t,view:s,spatialReference:r,timeZone:n,graphic:a}))}),i.forEach(a=>{(e==null?void 0:e.find(c=>this._matchesFeature(a,c)))||i.remove(a)})}_setExpressionContentVM(i,e){const t=this.formattedAttributes,{contentElement:s,contentElementViewModel:r}=i,n=s==null?void 0:s.type;r&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:t}),r.set(this._createFieldsVMParams(s,e))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:s,contentElementIndex:e,formattedAttributes:t}),r.set(this._createMediaVMParams(s,e))),n==="text"&&r.set(this._createTextVMParams(s)))}_compileRelationship(i,e){const{displayCount:t,orderByFields:s,relationshipId:r,title:n,description:a}=i,{_sourceLayer:d,graphic:c,map:u}=this;if(!pn(d))return;const h=new Ti({displayCount:t,graphic:c,orderByFields:s,relationshipId:r,layer:d,map:u,...this._compileTitleAndDesc({title:n,description:a})});return this.contentViewModels[e]=h,this.addHandles(yt(()=>h.relatedFeatures,"change",()=>this._setRelatedFeaturesViewModels(h)),ys),i}_matchesGlobalFeature(i,e){const t=i==null?void 0:i.association.globalId,s=e==null?void 0:e.association.globalId;return t!=null&&s!=null&&t===s}async _setUpUtilityNetworkAssociationsViewModels(i,e,t){const{view:s,spatialReference:r,timeZone:n}=this;i.forEach((d,c)=>{const u=e.get(c);u?d.forEach(h=>{u.find(m=>this._matchesGlobalFeature(h,m))||(d.remove(h),d.length===0&&i.delete(c))}):(d.removeAll(),i.delete(c))}),e.forEach((d,c)=>{const u=i.get(c)||new G;d==null||d.filter(Boolean).forEach(h=>{u.some(m=>this._matchesGlobalFeature(m,h))||u.add({association:h.association,featureViewModel:new st({abilities:{utilityNetworkAssociationsContent:!1},map:t,view:s,spatialReference:r,timeZone:n,graphic:h.feature}),terminalName:h.terminalName})}),i.set(c,u)});const a=new AbortController;this._associationVMAbortController=a,await this._sortListObjectsByTitle(i,{signal:a.signal}),this._associationVMAbortController===a&&(this._associationVMAbortController=null)}async _sortListObjectsByTitle(i,e){for(const t of i.values()){const s=t.map(r=>qt(()=>r.featureViewModel.state==="ready",e==null?void 0:e.signal));await Promise.all(s),t.sort(this._compareByFeatureTitle)}}_compareByFeatureTitle(i,e){const t=Ut(i.featureViewModel),s=Ut(e.featureViewModel);return t.localeCompare(s,void 0,{numeric:!0})}_compileUtilityNetworkAssociation(i,e){const{displayCount:t,title:s,description:r,associationTypes:n}=i,{_sourceLayer:a,graphic:d,map:c}=this;if(!mn(a))return;const u=new Ke({graphic:d,displayCount:t,associationTypes:n,layer:a,map:c,...this._compileTitleAndDesc({title:s,description:r})});return this.contentViewModels[e]=u,this.addHandles([w(()=>u.associationFeatures.values(),()=>this._setUpUtilityNetworkAssociationsViewModels(u.associationViewModels,u.associationFeatures,u.map))],jo),i}_compileExpression(i,e){const{expressionInfo:t}=i,{graphic:s,map:r,spatialReference:n,view:a,location:d}=this,c=new Ei({expressionInfo:t,graphic:s,interceptor:st.interceptor,map:r,spatialReference:n,view:a,location:d});return this.contentViewModels[e]=c,this.addHandles(w(()=>c.contentElementViewModel,()=>this._setExpressionContentVM(c,e),P),fs),i}_compileAttachments(i,e){const{graphic:t}=this,{description:s,title:r,orderByFields:n}=i;return this.contentViewModels[e]=new Ci({graphic:t,orderByFields:n,...this._compileTitleAndDesc({title:r,description:s})}),i}_compileCustom(i,e){const{graphic:t}=this,{creator:s,destroyer:r}=i;return this.contentViewModels[e]=new Wt({graphic:t,creator:s,destroyer:r}),i}_compileTitleAndDesc({title:i,description:e}){const{_fieldInfoMap:t,_sourceLayer:s,graphic:r,formattedAttributes:n}=this,a=r==null?void 0:r.attributes,d=this._expressionAttributes,c=n.global;return{title:Qe({attributes:a,fieldInfoMap:t,globalAttributes:c,expressionAttributes:d,layer:s,text:i}),description:Qe({attributes:a,fieldInfoMap:t,globalAttributes:c,expressionAttributes:d,layer:s,text:e})}}_createFieldsVMParams(i,e){const t=this._effectivePopupTemplate,s=this.formattedAttributes,r={...s==null?void 0:s.global,...s==null?void 0:s.content[e]},n=(i==null?void 0:i.fieldInfos)||(t==null?void 0:t.fieldInfos),a=n==null?void 0:n.filter(({fieldName:h})=>!!h&&(qs(h)||Ge(h)||r.hasOwnProperty(h))),d=t==null?void 0:t.expressionInfos,{description:c,title:u}=i;return{attributes:r,expressionInfos:d,fieldInfos:a,...this._compileTitleAndDesc({title:u,description:c})}}_compileFields(i,e){const t=i.clone(),s=new Qt(this._createFieldsVMParams(i,e));return this.contentViewModels[e]=s,t.fieldInfos=s.formattedFieldInfos.slice(),t}_createMediaVMParams(i,e){const{abilities:t,graphic:s,_fieldInfoMap:r,_effectivePopupTemplate:n,relatedInfos:a,_sourceLayer:d,_expressionAttributes:c}=this,u=this.formattedAttributes,h=(s==null?void 0:s.attributes)??{},{description:m,mediaInfos:f,title:g}=i;return{abilities:{chartAnimation:t.chartAnimation},activeMediaInfoIndex:i.activeMediaInfoIndex||0,attributes:h,isAggregate:s==null?void 0:s.isAggregate,layer:d,fieldInfoMap:r,formattedAttributes:{...u==null?void 0:u.global,...u==null?void 0:u.content[e]},expressionAttributes:c,mediaInfos:f,popupTemplate:n,relatedInfos:a,...this._compileTitleAndDesc({title:g,description:m})}}_compileMedia(i,e){const t=i.clone(),s=new Ze(this._createMediaVMParams(i,e));return t.mediaInfos=s.formattedMediaInfos.slice(),this.contentViewModels[e]=s,t}_createTextVMParams(i){var n;const{graphic:e,_fieldInfoMap:t,_sourceLayer:s,_expressionAttributes:r}=this;if(i&&i.text){const a=(e==null?void 0:e.attributes)??{},d=((n=this.formattedAttributes)==null?void 0:n.global)??{};i.text=Qe({attributes:a,fieldInfoMap:t,globalAttributes:d,expressionAttributes:r,layer:s,text:i.text})}return{graphic:e,creator:i.text}}_compileText(i,e){const t=i.clone();return this.contentViewModels[e]=new Wt(this._createTextVMParams(t)),t}_compileLastEditInfo(){const{_effectivePopupTemplate:i,_sourceLayer:e,graphic:t,timeZone:s}=this;if(!i)return;const{lastEditInfoEnabled:r}=i,n=e==null?void 0:e.editFieldsInfo;return r&&n?gn(n,t==null?void 0:t.attributes,s,e):void 0}_compileTitle(i){var d;const{_fieldInfoMap:e,_sourceLayer:t,graphic:s,_expressionAttributes:r}=this,n=(s==null?void 0:s.attributes)??{},a=((d=this.formattedAttributes)==null?void 0:d.global)??{};return Qe({attributes:n,fieldInfoMap:e,globalAttributes:a,expressionAttributes:r,layer:t,text:i})}async _getTitle(){const{_effectivePopupTemplate:i,graphic:e}=this;return e?jt({type:"title",value:i==null?void 0:i.title,event:{graphic:e}}):null}async _getContent(){const{_effectivePopupTemplate:i,graphic:e}=this;return e?jt({type:"content",value:i==null?void 0:i.content,event:{graphic:e}}):null}_evaluateExpressionAttributes({title:i,content:e,expressionInfos:t}){this._evaluateExpressionAttributesTask=Ae(this._evaluateExpressionAttributesTask),this._evaluateExpressionAttributesTask=Bt(async s=>{const{graphic:r,map:n,view:a,spatialReference:d,location:c}=this;try{if(!r)return;let u;if(t!=null){const h=[];for(const[m,f]of t.expressions.entries())f!=null?h.push(f.evaluate({graphic:r,interceptor:st.interceptor,location:c,map:n,options:{signal:s},spatialReference:d,view:a}).then(g=>[m,oo(g)]).catch(()=>[m,void 0])):h.push(Promise.resolve([m,void 0]));u=Object.fromEntries(await Promise.all(h)),ze(s)}this._expressionAttributes=u,this._graphicExpressionAttributes={...r.attributes,...u},this._set("formattedAttributes",this._createFormattedAttributes(e)),this._set("title",this._compileTitle(i)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(e)||null)}catch(u){vt(u)||(this._error=u,se.getLogger(this).error("error","The popupTemplate could not be displayed for this feature.",{error:u,graphic:r,popupTemplate:this._effectivePopupTemplate}))}})}_createMediaFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:t}){const{_effectivePopupTemplate:s,graphic:r,relatedInfos:n,_sourceLayer:a,_fieldInfoMap:d,_graphicExpressionAttributes:c,timeZone:u}=this;t.content[e]=Jt({fieldInfos:s==null?void 0:s.fieldInfos,graphic:r,attributes:{...c,...i.attributes},layer:a,fieldInfoMap:d,relatedInfos:n,timeZone:u})}_createFieldsFormattedAttributes({contentElement:i,contentElementIndex:e,formattedAttributes:t}){if(i.fieldInfos){const{graphic:s,relatedInfos:r,_sourceLayer:n,_fieldInfoMap:a,_graphicExpressionAttributes:d,timeZone:c}=this;t.content[e]=Jt({fieldInfos:i.fieldInfos,graphic:s,attributes:{...d,...i.attributes},layer:n,fieldInfoMap:a,relatedInfos:r,timeZone:c})}}_createFormattedAttributes(i){const{_effectivePopupTemplate:e,graphic:t,relatedInfos:s,_sourceLayer:r,_fieldInfoMap:n,_graphicExpressionAttributes:a,timeZone:d}=this,c=e==null?void 0:e.fieldInfos,u={global:Jt({fieldInfos:c,graphic:t,attributes:a,layer:r,fieldInfoMap:n,relatedInfos:s,timeZone:d}),content:[]};return Array.isArray(i)&&i.forEach((h,m)=>{h.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:h,contentElementIndex:m,formattedAttributes:u}),h.type==="media"&&this._createMediaFormattedAttributes({contentElement:h,contentElementIndex:m,formattedAttributes:u})}),u}_checkForRelatedFeatures(i){const{graphic:e,_effectivePopupTemplate:t}=this;return this._queryRelatedInfos(e,zi(t),i)}async _queryRelatedInfos(i,e,t){const{relatedInfos:s,_sourceLayer:r}=this;s.clear();const n=(r==null?void 0:r.associatedLayer)!=null?await(r==null?void 0:r.associatedLayer.load(t)):r;if(!n||!i)return;const a=e.filter(u=>!!u.fieldName&&Ge(u.fieldName));if(!(a!=null&&a.length))return;e.forEach(u=>this._configureRelatedInfo(u,n));const d=await Xn({relatedInfos:s,layer:n},t);Object.keys(d).forEach(u=>{var f;const h=s.get(u.toString()),m=(f=d[u])==null?void 0:f.value;h&&m&&(h.layerInfo=m.data)});const c=await Yn({graphic:i,relatedInfos:s,layer:n},t);Object.keys(c).forEach(u=>{var h;Wn((h=c[u])==null?void 0:h.value,s.get(u.toString()))})}_configureRelatedInfo(i,e){const{relatedInfos:t}=this,s=Rt(i.fieldName||"");if(!s)return;const{layerId:r,fieldName:n}=s;if(!r)return;const a=t.get(r.toString())||jn(r,e);a&&(Kn({relatedInfo:a,fieldName:n,fieldInfo:i}),this.relatedInfos.set(r,a))}};R.interceptor=new Uo(fn,yn),o([l()],R.prototype,"_error",void 0),o([l()],R.prototype,"_graphicChangedTask",void 0),o([l()],R.prototype,"_evaluateExpressionAttributesTask",void 0),o([l()],R.prototype,"_associationVMAbortController",void 0),o([l({readOnly:!0})],R.prototype,"_effectivePopupTemplate",null),o([l({readOnly:!0})],R.prototype,"_fieldInfoMap",null),o([l({readOnly:!0})],R.prototype,"_sourceLayer",null),o([l()],R.prototype,"abilities",void 0),o([at("abilities")],R.prototype,"castAbilities",null),o([l({readOnly:!0})],R.prototype,"content",void 0),o([l({readOnly:!0})],R.prototype,"contentViewModels",void 0),o([l()],R.prototype,"description",void 0),o([l({type:Boolean})],R.prototype,"defaultPopupTemplateEnabled",void 0),o([l({readOnly:!0})],R.prototype,"isTable",null),o([l({readOnly:!0})],R.prototype,"state",null),o([l({readOnly:!0})],R.prototype,"formattedAttributes",void 0),o([l({type:Ye,value:null})],R.prototype,"graphic",null),o([l({readOnly:!0})],R.prototype,"lastEditInfo",void 0),o([l({type:yi})],R.prototype,"location",void 0),o([l({readOnly:!0})],R.prototype,"relatedInfos",void 0),o([l({type:Gt})],R.prototype,"spatialReference",null),o([l()],R.prototype,"timeZone",null),o([l({readOnly:!0})],R.prototype,"title",void 0),o([l()],R.prototype,"map",null),o([l({readOnly:!0})],R.prototype,"waitingForContent",null),o([l()],R.prototype,"view",void 0),R=st=o([k("esri.widgets.Feature.FeatureViewModel")],R);const $i=R,K="esri-feature",B={base:K,container:`${K}__size-container`,title:`${K}__title`,main:`${K}__main-container`,btn:`${K}__button`,icon:`${K}__icon`,content:`${K}__content`,contentNode:`${K}__content-node`,contentNodeText:`${K}__content-node--text`,contentElement:`${K}__content-element`,text:`${K}__text`,lastEditedInfo:`${K}__last-edited-info`,fields:`${K}__fields`,fieldHeader:`${K}__field-header`,fieldData:`${K}__field-data`,fieldDataDate:`${K}__field-data--date`,loadingSpinnerContainer:`${K}__loading-container`},Qs=i=>{let e=class extends i{constructor(){super(...arguments),this.renderNodeContent=t=>Fs(t)&&!t.destroyed?p("div",{class:B.contentNode,key:t},t.render()):t instanceof HTMLElement?p("div",{afterCreate:this._attachToNode,bind:t,class:B.contentNode,key:t}):Ur(t)?p("div",{afterCreate:this._attachToNode,bind:t.domNode,class:B.contentNode,key:t}):null}_attachToNode(t){const s=this;t.appendChild(s)}};return e=o([k("esri.widgets.Feature.support.FeatureContentMixin")],e),e},_s={title:!0,content:!0,lastEditedInfo:!0};let U=class extends Qs(he){constructor(e,t){super(e,t),this._contentWidgets=[],this.flowType="feature",this.flowItems=null,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.visibleElements={..._s},this.viewModel=new $i}initialize(){this.addHandles(w(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentViewModels},()=>this._setupContentWidgets(),P))}loadDependencies(){return Fe({notice:()=>_(()=>import("./index-CpwZb1xc.js"),__vite__mapDeps([50,0,1]),import.meta.url),loader:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vU),__vite__mapDeps([0,1]),import.meta.url)})}destroy(){this._destroyContentWidgets()}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(e){this.viewModel.defaultPopupTemplateEnabled=e}get isTable(){return this.viewModel.isTable}get icon(){return"polygon"}set icon(e){this._overrideIfSome("icon",e)}get label(){var e;return((e=this.messages)==null?void 0:e.widgetLabel)??""}set label(e){this._overrideIfSome("label",e)}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get timeZone(){return this.viewModel.timeZone}set timeZone(e){this.viewModel.timeZone=e}get title(){return this.viewModel.title}castVisibleElements(e){return{..._s,...e}}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}setActiveMedia(e,t){return this.viewModel.setActiveMedia(e,t)}nextMedia(e){return this.viewModel.nextMedia(e)}previousMedia(e){return this.viewModel.previousMedia(e)}render(){const{state:e}=this.viewModel,t=p("div",{class:B.container,key:"container"},this._renderTitle(),e==="error"?this._renderError():e==="loading"?this._renderLoading():this._renderContentContainer());return p("div",{class:this.classes(B.base,T.widget)},t)}_renderError(){const{messagesCommon:e,messages:t,visibleElements:s}=this;return p("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,scale:"s"},s.title?p("div",{key:"error-title",slot:"title"},e.errorMessage):null,p("div",{key:"error-message",slot:"message"},t.loadingError))}_renderLoading(){return p("div",{class:B.loadingSpinnerContainer,key:"loading-container"},p("calcite-loader",{inline:!0,label:""}))}_renderContentContainer(){const{visibleElements:e}=this;return e.content?p("div",{class:B.main},[this._renderContent(),this._renderLastEditInfo()]):null}_renderTitle(){const{visibleElements:e,title:t}=this;return e.title?p(Ai,{class:B.title,innerHTML:t,level:this.headingLevel}):null}_renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?p("div",{class:B.contentNode,key:`${t}-content-elements`},e.map(this._renderContentElement,this)):null;if(typeof e=="string"){const s=this._contentWidgets[0];return!s||s.destroyed?null:p("div",{class:this.classes(B.contentNode,B.contentNodeText),key:`${t}-content`},s.render())}return this.renderNodeContent(e)}_renderContentElement(e,t){var r;const{visibleElements:s}=this;if(typeof s.content!="boolean"&&!((r=s.content)!=null&&r[e.type]))return null;switch(e.type){case"attachments":return this._renderAttachments(t);case"custom":return this._renderCustom(e,t);case"fields":return this._renderFields(t);case"media":return this._renderMedia(t);case"text":return this._renderText(e,t);case"expression":return this._renderExpression(t);case"relationship":return this._renderRelationship(t);case"utility-network-associations":return this._renderAssociation(t);default:return null}}_renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:s,attachmentInfos:r}=t.viewModel;return s==="loading"||r.length>0?p("div",{class:this.classes(B.contentElement),key:this._buildKey("attachments-element",e)},t.render()):null}_renderRelationship(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&this.flowItems?p("div",{class:B.contentElement,key:this._buildKey("relationship-element",e)},t.render()):null}_renderAssociation(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&this.flowItems?p("div",{class:B.contentElement,key:this._buildKey("utility-network-association-element",e)},t.render()):null}_renderExpression(e){const t=this._contentWidgets[e];return t&&!t.destroyed&&t.viewModel.contentElement?p("div",{class:B.contentElement,key:this._buildKey("expression-element",e)},t.render()):null}_renderCustom(e,t){const{creator:s}=e,r=this._contentWidgets[t];return!r||r.destroyed?null:s?p("div",{class:B.contentElement,key:this._buildKey("custom-element",t)},r.render()):null}_renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:p("div",{class:B.contentElement,key:this._buildKey("fields-element",e)},t.render())}_renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:p("div",{class:B.contentElement,key:this._buildKey("media-element",e)},t.render())}_renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:s}=this.viewModel;if(!s||!e.lastEditedInfo)return null;const{date:r,user:n}=s,a=s.type==="edit"?n?t.lastEditedByUser:t.lastEdited:n?t.lastCreatedByUser:t.lastCreated,d=me(a,{date:r,user:n});return p("div",{class:this.classes(B.lastEditedInfo,B.contentElement),key:"edit-info-element"},d)}_renderText(e,t){const s=e.text,r=this._contentWidgets[t];return!r||r.destroyed?null:s?p("div",{class:this.classes(B.contentElement,B.text),key:this._buildKey("text-element",t)},r.render()):null}_buildKey(e,...t){var s,r;return`${e}__${((r=(s=this.viewModel)==null?void 0:s.graphic)==null?void 0:r.uid)||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach(e=>this._destroyContentWidget(e)),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t,flowItems:s,viewModel:r}=this,n=r==null?void 0:r.content,{contentViewModels:a}=r;if(Array.isArray(n))n.forEach((d,c)=>{if(d.type==="attachments"&&(this._contentWidgets[c]=new Rn({displayType:d.displayType,headingLevel:t.title&&e<6?e+1:e,viewModel:a[c]})),d.type==="fields"&&(this._contentWidgets[c]=new js({viewModel:a[c]})),d.type==="media"&&(this._contentWidgets[c]=new Ws({viewModel:a[c]})),d.type==="text"&&(this._contentWidgets[c]=new St({viewModel:a[c]})),d.type==="custom"&&(this._contentWidgets[c]=new St({viewModel:a[c]})),d.type==="expression"&&(this._contentWidgets[c]=new _o({viewModel:a[c]})),d.type==="relationship"){const u=new Oo({flowItems:s,featureVisibleElements:t,viewModel:a[c]});this._contentWidgets[c]=u}if(d.type==="utility-network-associations"){const u=m=>{const{viewModel:f,listType:g,title:y}=m;if(!s)return;f.activeAssociationType=g;const v=new Bo({viewModel:f,parentFeatureViewModel:r,listType:g,title:y,featureVisibleElements:t,description:r.title,flowItems:s});s.push(v)},h=new qo({flowItems:s,onSelectAssociationType:u,parentFeatureViewModel:r,featureVisibleElements:t,viewModel:a[c]});this._contentWidgets[c]=h}},this);else{const d=a[0];d&&!d.destroyed&&(this._contentWidgets[0]=new St({viewModel:d}))}this.scheduleRender()}};o([l()],U.prototype,"flowType",void 0),o([l()],U.prototype,"graphic",null),o([l()],U.prototype,"defaultPopupTemplateEnabled",null),o([l()],U.prototype,"flowItems",void 0),o([l()],U.prototype,"headingLevel",void 0),o([l({readOnly:!0})],U.prototype,"isTable",null),o([l()],U.prototype,"icon",null),o([l()],U.prototype,"label",null),o([l()],U.prototype,"location",null),o([l(),re("esri/widgets/Feature/t9n/Feature")],U.prototype,"messages",void 0),o([l(),re("esri/t9n/common")],U.prototype,"messagesCommon",void 0),o([l()],U.prototype,"spatialReference",null),o([l()],U.prototype,"timeZone",null),o([l({readOnly:!0})],U.prototype,"title",null),o([l()],U.prototype,"visibleElements",void 0),o([at("visibleElements")],U.prototype,"castVisibleElements",null),o([l()],U.prototype,"map",null),o([l()],U.prototype,"view",null),o([l({type:$i})],U.prototype,"viewModel",void 0),U=o([k("esri.widgets.Feature")],U);const Zs=U,Js=Object.freeze(Object.defineProperty({__proto__:null,default:Zs},Symbol.toStringTag,{value:"Module"}));let qe=class extends xs.EventedAccessor{constructor(e){super(e),this.location=null,this.screenLocationEnabled=!1,this.view=null,this.addHandles([Je(()=>{const t=this.screenLocationEnabled?this.view:null;return t?[t.size,t.type==="3d"?t.camera:t.viewpoint]:null},()=>this.notifyChange("screenLocation")),w(()=>this.screenLocation,(t,s)=>{t!=null&&s!=null&&this.emit("view-change")})])}destroy(){this.view=null}get screenLocation(){const{location:e,view:t,screenLocationEnabled:s}=this,r=t==null?void 0:t.spatialReference,n=r?jr(e,r).geometry:null;return s&&n&&(t!=null&&t.ready)?t.toScreen(n):null}};o([l()],qe.prototype,"location",void 0),o([l()],qe.prototype,"screenLocation",null),o([l()],qe.prototype,"screenLocationEnabled",void 0),o([l()],qe.prototype,"view",void 0),qe=o([k("esri.widgets.support.AnchorElementViewModel")],qe);const Xs=qe;let Dt=class extends Xs{constructor(e){super(e),this.visible=!1}};o([l()],Dt.prototype,"visible",void 0),Dt=o([k("esri.widgets.Spinner.SpinnerViewModel")],Dt);const Ys=Dt,ai="esri-spinner",li={base:ai,spinnerStart:`${ai}--start`,spinnerFinish:`${ai}--finish`};let Ue=class extends he{constructor(e,t){super(e,t),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Ys}initialize(){this.addHandles(w(()=>this.visible,e=>this._visibleChange(e)))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}show(e){const{location:t,promise:s}=e??{};t&&(this.viewModel.location=t),this.visible=!0;const r=()=>this.hide();s&&s.catch(()=>{}).then(r)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:t}=this.viewModel,s=!!t,r=e&&s,n=!e&&s,a={[li.spinnerStart]:r,[li.spinnerFinish]:n},d=this._getPositionStyles();return p("div",{class:this.classes(li.base,a),styles:d})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const t=bi(this._animationDelay);this._animationPromise=t,t.catch(()=>{}).then(()=>{this._animationPromise===t&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:t}=this.viewModel;if(t==null||e==null)return{};const{padding:s}=t;return{left:e.x-s.left+"px",top:e.y-s.top+"px"}}};o([l()],Ue.prototype,"location",null),o([l()],Ue.prototype,"view",null),o([l({type:Ys})],Ue.prototype,"viewModel",void 0),o([l()],Ue.prototype,"visible",null),Ue=o([k("esri.widgets.Spinner")],Ue);const Wo=Ue,J="esri-features",W={icon:`${J}__icon`,actionImage:`${J}__action-image`,base:J,container:`${J}__container`,contentContainer:`${J}__content-container`,contentFeature:`${J}__content-feature`,flowItemCollapsed:`${J}__flow-item--collapsed`,header:`${J}__header`,footer:`${J}__footer`,featureMenuObserver:`${J}__feature-menu-observer`,actionExit:`${J}__action--exit`,loader:`${J}__loader`,featuresHeading:`${J}__heading`,paginationText:`${J}__pagination-text`,paginationActionBar:`${J}__pagination-action-bar`,paginationMenuButton:`${J}__pagination-menu-button`,paginationPrevious:`${J}__pagination-previous`,paginationNext:`${J}__pagination-next`},Xe=G.ofType({key:"type",defaultKeyValue:"button",base:Wr,typeMap:{button:bt,toggle:Ss}}),Oe=new bt({icon:"magnifying-glass-plus",id:"zoom-to-feature",title:"{messages.zoom}",className:Te.zoomInMagnifyingGlass}),ws=new bt({icon:"trash",id:"remove-selected-feature",title:"{messages.remove}",className:Te.trash}),rt=new bt({icon:"magnifying-glass-plus",id:"zoom-to-clustered-features",title:"{messages.zoom}",className:Te.zoomInMagnifyingGlass}),Se=new Ss({icon:"table",id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:Te.table,value:!1}),Ve=Oe.clone();let je=class extends he{constructor(e,t){super(e,t),this.messages=null,this.closed=!1,this.closable=!0,this._handleOpenFeature=s=>{this.emit("open-feature",{feature:s})},this._handleZoomToFeature=s=>{this.emit("zoom-to-feature",{featureWidget:s})}}loadDependencies(){return Fe({action:()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vW),__vite__mapDeps([0,1]),import.meta.url),"action-bar":()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vY),__vite__mapDeps([0,1]),import.meta.url),"action-group":()=>_(()=>import("./index-BFudLC3v.js").then(e=>e.vX),__vite__mapDeps([0,1]),import.meta.url),"flow-item":()=>_(()=>import("./index-D4Fyp3lU.js"),__vite__mapDeps([53,0,1]),import.meta.url)})}render(){const{flowItems:e}=this,t=e==null?void 0:e.toArray();return p(Vs,null,t==null?void 0:t.map((s,r)=>this._renderFlowItem(s,r===e.length-1)))}_handleCloseClick(){this.emit("close")}_handleExitClick(){this.emit("exit")}_handleDrillInBackClick(){var t;const e=(t=this.flowItems)==null?void 0:t.pop();e&&("showAllEnabled"in e.viewModel&&(e.viewModel.showAllEnabled=!1),e&&(e.viewModel=null,e.destroy()))}_getExitMessage(e){switch(e.flowType){case"feature":case"feature-association":return"";case"feature-relationship":return this.messages.exitRelatedRecords;case"feature-utility-network-associations":case"feature-utility-network-association-type":return this.messages.exitAssociations}}_renderFlowItem(e,t){const{messages:s,closable:r,closed:n}=this,a="graphic"in e&&!e.isTable,d=e.flowType==="feature-association",c=this._getExitMessage(e),u=s.selectFeature;return p("calcite-flow-item",{bind:this,closable:r,closed:n,description:this._getDrillInFlowItemDescription(e),heading:e.title??"",key:`flow-item-${e.viewModel.uid}`,selected:t,onCalciteFlowItemBack:h=>{h.preventDefault(),this._handleDrillInBackClick()},onCalciteFlowItemClose:this._handleCloseClick},p("calcite-action",{appearance:"transparent",bind:this,class:W.actionExit,icon:"move-up",key:"exit-action",onclick:this._handleExitClick,slot:"header-actions-start",text:c,title:c}),a?p("calcite-action",{appearance:"transparent",bind:this,icon:"zoom-to-object",key:"open-feature-action",onclick:()=>this._handleOpenFeature(e),slot:"header-actions-end",text:u,title:u}):null,d?p("calcite-action-bar",{expandDisabled:!0,expanded:!0,key:"header-action-bar",scale:"s",slot:"action-bar"},p("calcite-action-group",{overlayPositioning:"fixed",scale:"s"},this._renderDefaultActions(e))):null,p("div",{class:W.container},e.render()))}_renderDefaultActions(e){const t=this._getActionTitle(Ve);return p("calcite-action",{active:Ve.active,appearance:"solid",bind:this,"data-action-uid":Ve.uid,disabled:Ve.disabled,icon:Ve.icon??"question",indicator:Ve.indicator,key:`action-${Ve.uid}`,loading:Ve.active,onclick:()=>this._handleZoomToFeature(e),scale:"s",text:t,textEnabled:!0,title:t})}_getActionTitle(e){const{messages:t}=this,{id:s}=e,r=e.title??"";return s==="zoom-to-feature"?me(r,{messages:t}):r}_getDrillInFlowItemDescription(e){switch(e.flowType){case"feature":case"feature-association":case"feature-utility-network-associations":return e.viewModel.description??"";case"feature-relationship":return e.featureCountDescription;case"feature-utility-network-association-type":return e.description??""}}};o([l()],je.prototype,"flowItems",void 0),o([l(),re("esri/widgets/Features/t9n/Features")],je.prototype,"messages",void 0),o([l()],je.prototype,"closed",void 0),o([l()],je.prototype,"closable",void 0),je=o([k("esri.widgets.Features.FeaturesDrillIn")],je);const Ho=je,zo="OBJECTID",Go="esri.widgets.Popup.PopupViewModel",Ht=()=>se.getLogger(Go),Qo=i=>{const{event:e,view:t,viewModel:s}=i,{action:r}=e;if(!r)return Promise.reject(new A("trigger-action:missing-arguments","Event has no action"));const{disabled:n,id:a}=r;if(!a)return Promise.reject(new A("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new A("trigger-action:invalid-action","Action is disabled"));if(a===Oe.id)return er(s).catch(Hr);if(a===rt.id)return Jo(s);if(a===Se.id)return s.browseClusterEnabled=!s.browseClusterEnabled,s.featureMenuOpen=s.browseClusterEnabled,Promise.resolve();if(a===ws.id){s.visible=!1;const{selectedFeature:d}=s;if(!d)return Promise.reject(new A(`trigger-action:${ws.id}`,"selectedFeature is required",{selectedFeature:d}));const{sourceLayer:c}=d;return c?c.remove(d):t==null||t.graphics.remove(d),Promise.resolve()}return Promise.resolve()};function Ks(i){const{selectedFeature:e,location:t,view:s}=i;return s?e??t??null:null}function We(i){var e,t;return!!i&&i.isAggregate&&((t=(e=i.sourceLayer)==null?void 0:e.featureReduction)==null?void 0:t.type)==="cluster"}async function Zo(i,e){if((e==null?void 0:e.type)!=="3d"||!i||i.declaredClass!=="esri.Graphic")return!0;const t=e.getViewForGraphic(i);if(t&&"whenGraphicBounds"in t){let s=null;try{s=await t.whenGraphicBounds(i,{useViewElevation:!0})}catch{}return!s||!s.boundingBox||s.boundingBox[0]===s.boundingBox[3]&&s.boundingBox[1]===s.boundingBox[4]&&s.boundingBox[2]===s.boundingBox[5]}return!0}async function er(i,e){var m,f;const{location:t,selectedFeature:s,view:r,zoomFactor:n}=i;await((m=e==null?void 0:e.viewModel)==null?void 0:m.updateGeometry());const a=e==null?void 0:e.graphic,d=a!=null&&a.geometry?a:Ks(i);if(!r||!d){const g=new A("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:d,view:r});throw Ht().error(g),g}const c=r.scale/n,u=(a==null?void 0:a.geometry)??((f=i.selectedFeature)==null?void 0:f.geometry)??t,h=u!=null&&u.type==="point"&&await Zo(a??s,r);Oe.active=!0,Oe.disabled=!0;try{await i.zoomTo({target:{target:d,scale:h?c:void 0}})}catch(g){if(vt(g))return;const y=new A("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:a??s});Ht().error(y)}finally{Oe.active=!1,Oe.disabled=!1,i.zoomToLocation=null,h&&(i.location=u)}}async function Jo(i){const{selectedFeature:e,view:t}=i;if((t==null?void 0:t.type)!=="2d"){const a=new A("zoomToCluster:invalid-view","View must be 2d MapView.",{view:t});throw Ht().error(a),a}if(!e||!We(e)){const a=new A("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:e});throw Ht().error(a),a}const[s,r]=await xi(t,e);rt.active=!0,rt.disabled=!0;const{extent:n}=await s.queryExtent(r);n&&await i.zoomTo({target:n}),rt.active=!1,rt.disabled=!1}async function Xo(i){const{view:e,selectedFeature:t}=i;if(!e||!t)return;const[s,r]=await xi(e,t),{extent:n}=await s.queryExtent(r);i.selectedClusterBoundaryFeature.geometry=n,e.graphics.add(i.selectedClusterBoundaryFeature)}async function Yo(i){const{selectedFeature:e,view:t}=i;if(!t||!e)return;const[s,r]=await xi(t,e);Se.active=!0,Se.disabled=!0;const{features:n}=await s.queryFeatures(r);Se.active=!1,Se.disabled=!1,Se.value=!0;const a={features:[e].concat(n)};(i==null?void 0:i.initialDisplayMode)==="feature"&&(a.featureMenuOpen=!0),i==null||i.open(a)}async function xi(i,e){const t=await i.whenLayerView(e.sourceLayer),s=t.createQuery(),r=e.getObjectId();return s.aggregateIds=r!=null?[r]:[],[t,s]}function Ko(i){Se.value=!1;const e=i.features.filter(t=>We(t));e.length&&(i.features=e)}const di="location-scale-handle",ea=()=>[Oe.clone()],ta=()=>[rt.clone(),Se.clone()];let Lt=null;function ia(i,e){return i==="building-scene"||e==="2d"&&(i==="map-image"||i==="tile"||i==="imagery"||i==="imagery-tile")}let C=class extends zr(Xs){constructor(e){super(e),this._pendingPromises=new xn,this._fetchFeaturesController=null,this._highlightPromises={"highlight-active-feature":null,"highlight-selected-feature":null},this._selectedClusterFeature=null,this.actions=new Xe,this.activeFeature=null,this.autoCloseEnabled=!1,this.browseClusterEnabled=!1,this.content=null,this.defaultPopupTemplateEnabled=!1,this.featurePage=null,this.featuresPerPage=20,this.featureMenuOpen=!1,this.featureMenuTitle=null,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.initialDisplayMode="feature",this.selectedClusterBoundaryFeature=new Ye({symbol:new Gr({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null,this._debouncedLocationUpdate=Ne(async t=>{var a,d,c,u;const{spatialReference:s}=this,r=(d=(a=this.selectedFeature)==null?void 0:a.geometry)==null?void 0:d.type,n=this.location??t;if(r&&r!=="mesh"&&s&&n&&this.selectedFeature)if(r!=="point")try{const h=this.selectedFeature;let m=h.geometry;const f=this._getHighlightLayer(h),g=h.getObjectId();if(!f||!this.view)return;if(g){const y=(c=this.view)==null?void 0:c.allLayerViews.find(I=>I.layer.uid===f.uid);if(!y||!("queryFeatures"in y))return;const v=y.createQuery();v.outSpatialReference=s,v.objectIds=[g],v.returnGeometry=!0;const{features:b}=await y.queryFeatures(v);m=(u=b[0])==null?void 0:u.geometry}if(!m||m.type==="mesh")return;if(m=Qr(m,s),Lt||(Lt=await _(()=>import("./geometryEngineAsync-Bl5oqJGC.js"),__vite__mapDeps([54,0,1]),import.meta.url)),!await Lt.intersects(m,n)){const y=(await Lt.nearestCoordinate(m,n)).coordinate??n;this.selectedFeature===h&&(this.location=y)}}catch(h){vt(h)||se.getLogger(this).error(h)}else this.location=hi(this.selectedFeature.geometry)??n})}initialize(){this.addHandles([this.on("view-change",()=>this._autoClose()),w(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),w(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),w(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.animation)==null?void 0:t.state},e=>this._animationStateChange(e)),w(()=>this.location,e=>this._locationChange(e)),w(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),w(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),w(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),w(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>Qo({event:e,viewModel:this,view:this.view})),Je(()=>!this.waitingForResult,()=>this._waitingForResultChange(),Zr),w(()=>[this.features,this.map,this.spatialReference,this.timeZone],()=>this._updateFeatureVMs()),w(()=>{var e;return(e=this.view)==null?void 0:e.scale},()=>this._viewScaleChange()),Je(()=>!this.visible,()=>this.browseClusterEnabled=!1),w(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null,this.map=null,this.spatialReference=null,this.timeZone=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new Xe;e.removeAll();const{actions:t,defaultActions:s,defaultPopupTemplateEnabled:r,includeDefaultActions:n,selectedFeature:a}=this,d=n?s.concat(t):t,c=a&&(typeof a.getEffectivePopupTemplate=="function"&&a.getEffectivePopupTemplate(r)||a.popupTemplate),u=c==null?void 0:c.actions,h=c!=null&&c.overwriteActions?u:(u==null?void 0:u.concat(d))??d;return h==null||h.filter(Boolean).forEach(m=>e.add(m)),e}get defaultActions(){const e=this._get("defaultActions")||new Xe;return e.removeAll(),e.addMany(We(this.selectedFeature)?ta():ea()),e}get featureCount(){return this.features.length}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:s,promiseCount:r,selectedFeatureIndex:n}=this,a=r&&t.length;this.initialDisplayMode!=="list"?a&&s&&n===-1?this.selectedFeatureIndex=0:a&&n!==-1||(this.selectedFeatureIndex=t.length?0:-1):(!a||a&&s===r)&&(this.selectedFeatureIndex=-1)}set location(e){var n,a;let t=e;const s=(n=this.spatialReference)==null?void 0:n.isWebMercator;((a=e==null?void 0:e.spatialReference)==null?void 0:a.isWGS84)&&s&&(t=Jr(e)),this._set("location",t)}get map(){var e;return((e=this.view)==null?void 0:e.map)??null}set map(e){this._override("map",e)}get pendingPromisesCount(){return this._pendingPromises.size}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){this._pendingPromises.clear(),this.features=[],Array.isArray(e)&&e.length?(this._set("promises",e),(e=e.slice()).forEach(t=>this._pendingPromises.add(t)),e.reduce((t,s)=>t.finally(()=>s.then(r=>{this._pendingPromises.has(s)&&this._updateFeatures(r)}).finally(()=>this._pendingPromises.delete(s)).catch(()=>{})),Promise.resolve())):this._set("promises",[])}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return t===-1?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;(isNaN(e)||e<0||!t)&&(e=-1),this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)??null}set spatialReference(e){this._override("spatialReference",e)}get state(){const{view:e,map:t}=this;return e?e.ready?"ready":"disabled":t?"ready":"disabled"}get timeZone(){var e;return((e=this.view)==null?void 0:e.timeZone)??Ps}set timeZone(e){this._overrideIfSome("timeZone",e)}get waitingForContents(){return this.featureViewModels.some(e=>e.waitingForContent)}get waitingForResult(){return!(!(this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}centerAtLocation(){const{view:e}=this,t=Ks(this);return t&&e?this.callGoTo({target:{target:t,scale:e.scale}}):Promise.reject(new A("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e}))}zoomTo(e){return this.callGoTo(e)}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,t){var r;const{view:s}=this;if(!s||!e)throw new A("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:s});return s.fetchPopupFeatures(e,{pointerType:(r=t==null?void 0:t.event)==null?void 0:r.pointerType,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t==null?void 0:t.signal})}open(e){const t={updateLocationEnabled:!1,promises:[],fetchFeatures:!1,...e,visible:!0},{fetchFeatures:s}=t;delete t.fetchFeatures,s&&this._setFetchFeaturesPromises(t.location);const r=["actionsMenuOpen","collapsed"];for(const n of r)delete t[n];this.set(t)}triggerAction(e){const t=this.allActions.at(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex+1,this.featureCount),this}previous(){return this.selectedFeatureIndex=this._getRoundRobinIndex(this.selectedFeatureIndex-1,this.featureCount),this}disableClusterBrowsing(){Ko(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:t}=this;(e==null?void 0:e.type)==="2d"?We(t)?(await Xo(this),await Yo(this)):se.getLogger(this).warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",t):se.getLogger(this).warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",t)}handleViewClick(e){this._fetchFeaturesAndOpen(e)}_getRoundRobinIndex(e,t){return(e+t)%t}_animationStateChange(e){this.zoomToLocation||(Oe.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var t,s;const e=[this.selectedClusterBoundaryFeature,this._selectedClusterFeature].filter(ot);(s=(t=this.view)==null?void 0:t.graphics)==null||s.removeMany(e),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(We(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=this.selectedFeature?[this.selectedFeature]:[])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:s,view:r}=this;r&&s&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>0?Math.floor((this.selectedFeatureIndex+1)/this.featuresPerPage):null}_featureViewModelsChange(){this.featurePage=this.featureCount>0?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:s,featuresPerPage:r,featureViewModels:n}=this;if(s==null)return;const a=((s-1)*r+t)%t,d=a+r;n.slice(a,d).forEach((c,u)=>{c&&(c.graphic??(c.graphic=e[a+u]))})}async _selectedFeatureChange(e){var a,d;const{location:t,updateLocationEnabled:s,view:r}=this;if(!e||!r)return;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),We(e)?void 0:(e.symbol=await Gi(e),this._selectedClusterFeature=e,void r.graphics.add(this._selectedClusterFeature));const n=(a=e.sourceLayer)==null?void 0:a.type;if(n!=="map-image"&&n!=="imagery"&&n!=="imagery-tile"||(e.symbol=await Gi(e)),!s&&t||!e.geometry){if(s&&!e.geometry){await this.centerAtLocation();const c=(d=r.center)==null?void 0:d.clone();c&&(this.location=c)}}else this.location=hi(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}async _setFetchFeaturesPromises(e){const{pendingFeatures:t}=await this._fetchFeaturesWithController({mapPoint:e});this.promises=t}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:s,view:r,spatialReference:n,map:a,timeZone:d,location:c}=this;if(We(t[0])||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!(t!=null&&t.length))return;const u=s.slice(),h=[];t.forEach((m,f)=>{if(!m)return;let g=null;if(u.some((y,v)=>(y&&y.graphic===m&&(g=y,u.splice(v,1)),!!g)),g)h[f]=g;else{const y=new $i({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:n,graphic:m===e?m:null,location:c,map:a,view:r,timeZone:d});h[f]=y}}),u.forEach(m=>m&&!m.destroyed&&m.destroy()),this._set("featureViewModels",h)}async _getScreenPoint(e,t){const{spatialReference:s,view:r}=this;if(!r)return null;await(r==null?void 0:r.when());const n=e==null?void 0:e.spatialReference;return n&&s?(await Xr(n,s,null,t),r.toScreen(e)):null}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null}async _projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,event:s,signal:r}){return this.fetchFeatures(t??await this._getScreenPoint(e??this.location,{signal:r}),{signal:r,event:s})}_fetchFeaturesWithController({mapPoint:e,screenPoint:t,event:s}){this._cancelFetchingFeatures();const r=new AbortController,{signal:n}=r;this._fetchFeaturesController=r;const a=this._projectScreenPointAndFetchFeatures({mapPoint:e,screenPoint:t,signal:n,event:s});return a.catch(()=>{}).then(()=>{this._fetchFeaturesController=null}),a}async _fetchFeaturesAndOpen(e){const{mapPoint:t,screenPoint:s}=e,{view:r}=this;this.removeHandles(di),this.addHandles([w(()=>{var a;return(a=this.view)==null?void 0:a.scale},()=>this._debouncedLocationUpdate(t).catch(a=>{vt(a)||se.getLogger(this).error(a)})),Je(()=>!this.visible,()=>{this.removeHandles(di)},{once:!0})],di);const{pendingFeatures:n}=await this._fetchFeaturesWithController({mapPoint:t,screenPoint:s,event:e});r!=null&&r.popup&&"open"in r.popup&&r.popup.open({location:t??void 0,promises:n})}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}_getHighlightLayer(e){const{layer:t,sourceLayer:s}=e;return s&&"layer"in s&&s.layer?s.layer:(s==null?void 0:s.type)==="map-notes"||(s==null?void 0:s.type)==="subtype-group"?s:t}_getHighlightLayerView(e,t){return t instanceof Yr&&this._mapIncludesLayer(t)?this._getLayerView(e,t):t instanceof kn&&t.parent&&this._mapIncludesLayer(t.parent)?this._getLayerView(e,t.parent):null}_getHighlightTarget(e,t,s){if(ia(t.type,s))return e;const r=e.getObjectId();if(r!=null)return r;const n=t.type==="imagery"?void 0:"objectIdField"in t?t.objectIdField||zo:null,a=e.attributes;return a&&n&&a[n]||e}_mapIncludesLayer(e){var t,s;return!!((s=(t=this.map)==null?void 0:t.allLayers)!=null&&s.includes(e))}async _highlightFeature(e,t){this.removeHandles(e);const s=this[t];if(!s)return;const{highlightEnabled:r,view:n,visible:a}=this;if(!n||!r||!a)return;const d=this._getHighlightLayer(s);if(!d)return;const c=this._getHighlightLayerView(n,d);if(!c)return;this._highlightPromises[e]=c;const u=await c;if(!(u&&Ln(u)&&this._highlightPromises[e]===c&&this[t]&&this.highlightEnabled))return;const h=u.highlight(this._getHighlightTarget(s,d,n.type));this.addHandles(h,e)}async _highlightActiveFeature(){return this._highlightFeature("highlight-active-feature","activeFeature")}async _highlightSelectedFeature(){return this._highlightFeature("highlight-selected-feature","selectedFeature")}_updateFeatures(e){const{features:t}=this,s=e.filter(r=>!t.includes(r));s!=null&&s.length&&(this.features=t.concat(s))}};o([l()],C.prototype,"_fetchFeaturesController",void 0),o([l({type:Xe})],C.prototype,"actions",void 0),o([l({readOnly:!0})],C.prototype,"active",null),o([l()],C.prototype,"activeFeature",void 0),o([l({readOnly:!0})],C.prototype,"allActions",null),o([l()],C.prototype,"autoCloseEnabled",void 0),o([l()],C.prototype,"browseClusterEnabled",void 0),o([l()],C.prototype,"content",void 0),o([l({type:Xe,readOnly:!0})],C.prototype,"defaultActions",null),o([l({type:Boolean})],C.prototype,"defaultPopupTemplateEnabled",void 0),o([l({readOnly:!0})],C.prototype,"featureCount",null),o([l()],C.prototype,"featurePage",void 0),o([l({value:[]})],C.prototype,"features",null),o([l()],C.prototype,"featuresPerPage",void 0),o([l()],C.prototype,"featureMenuOpen",void 0),o([l()],C.prototype,"featureMenuTitle",void 0),o([l()],C.prototype,"featureViewModelAbilities",void 0),o([l({readOnly:!0})],C.prototype,"featureViewModels",void 0),o([l()],C.prototype,"highlightEnabled",void 0),o([l()],C.prototype,"includeDefaultActions",void 0),o([l()],C.prototype,"initialDisplayMode",void 0),o([l({type:yi})],C.prototype,"location",null),o([l()],C.prototype,"map",null),o([l({readOnly:!0})],C.prototype,"pendingPromisesCount",null),o([l({readOnly:!0})],C.prototype,"promiseCount",null),o([l()],C.prototype,"promises",null),o([l({readOnly:!0})],C.prototype,"selectedClusterBoundaryFeature",void 0),o([l({value:null,readOnly:!0})],C.prototype,"selectedFeature",null),o([l({value:-1})],C.prototype,"selectedFeatureIndex",null),o([l({readOnly:!0})],C.prototype,"selectedFeatureViewModel",null),o([l({type:Gt})],C.prototype,"spatialReference",null),o([l({readOnly:!0})],C.prototype,"state",null),o([l()],C.prototype,"timeZone",null),o([l()],C.prototype,"title",void 0),o([l()],C.prototype,"updateLocationEnabled",void 0),o([l()],C.prototype,"view",void 0),o([l()],C.prototype,"visible",void 0),o([l({readOnly:!0})],C.prototype,"waitingForContents",null),o([l({readOnly:!0})],C.prototype,"waitingForResult",null),o([l()],C.prototype,"zoomFactor",void 0),o([l()],C.prototype,"zoomToLocation",void 0),o([l()],C.prototype,"centerAtLocation",null),C=o([k("esri.widgets.Features.FeaturesViewModel")],C);const Zt=C;let fe=class extends ye{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!1,this.featureMenuHeading=!0,this.featureNavigation=!0,this.featureListLayerTitle=!0,this.flow=!0,this.heading=!0,this.spinner=!0}};o([l({type:Boolean,nonNullable:!0})],fe.prototype,"actionBar",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"closeButton",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"collapseButton",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"featureMenuHeading",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"featureNavigation",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"featureListLayerTitle",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"flow",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"heading",void 0),o([l({type:Boolean,nonNullable:!0})],fe.prototype,"spinner",void 0),fe=o([k("esri.widgets.Features.FeaturesVisibleElements")],fe);const tr=fe,bs="selected-index",sa=0,Is="features-spinner";function Ms(i){return(i==null?void 0:i.declaredClass.startsWith("esri.layers."))??!1}let x=class extends Qs(he){constructor(i,e){super(i,e),this._featureMenuIntersectionObserverCallback=([t])=>{t!=null&&t.isIntersecting&&this.viewModel.featurePage!=null&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._featureMenuIntersectionObserverNode=null,this._spinner=null,this._feature=null,this._focusAbortController=null,this._drillInFlowItems=new G,this._drillInWidget=new Ho({flowItems:this._drillInFlowItems}),this._rootNode=null,this._rootFlowItemNode=null,this._featureMenuViewportNode=null,this._actionBarMenuNode=null,this.collapsed=!1,this.featureNavigationTop=!1,this.headerActions=new Xe,this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.responsiveActionsEnabled=!1,this.viewModel=new Zt,this.visibleElements=new tr,this._renderAction=(t,s)=>{const r=this._getActionTitle(t),{type:n,active:a,uid:d,disabled:c,indicator:u}=t;return t.visible?p("calcite-action",{active:n==="toggle"&&t.value,appearance:"solid",bind:this,"data-action-id":t.id,"data-action-uid":d,disabled:c,icon:this._getActionIcon(t),indicator:u,key:`action-${s}`,loading:a,onclick:this._triggerAction,scale:"s",text:r,textEnabled:!this._hideActionText,title:this._hideActionText?r:void 0},this._getFallbackIcon(t)):null},this._openFeatureMenu=()=>{this.featureMenuOpen=!0,this._focusFlowItemNode()},this._closeFeatureMenu=()=>{this.featureMenuOpen=!1,this._focusFlowItemNode()},this._previousFeature=()=>{this.viewModel.previous()},this._nextFeature=()=>{this.viewModel.next()},this._handleFeatureBack=()=>{this.initialDisplayMode==="list"?(this.selectedFeatureIndex=-1,this._focusFlowItemNode()):this._openFeatureMenu()},this._handleFeatureMenuBack=()=>{this.initialDisplayMode==="list"?(this.selectedFeatureIndex=-1,this._focusFlowItemNode()):this.featureMenuOpen&&this._closeFeatureMenu()},this._storeRootNode=t=>{this._rootNode=t},this._displaySpinnerThrottled=_t(()=>this._displaySpinner(),sa),this._addSelectedFeatureIndexHandle(),this.addHandles([this._displaySpinnerThrottled,w(()=>{var t;return(t=this.viewModel)==null?void 0:t.active},()=>this._toggleScreenLocationEnabled()),w(()=>{var t;return(t=this.viewModel)==null?void 0:t.active},t=>this._drillInWidget.closed=!t),w(()=>{var t;return(t=this.visibleElements)==null?void 0:t.closeButton},t=>this._drillInWidget.closable=t),w(()=>{var t;return(t=this.visibleElements)==null?void 0:t.spinner},t=>this._spinnerEnabledChange(t)),w(()=>{var t;return(t=this.viewModel)==null?void 0:t.view},(t,s)=>this._viewChange(t,s)),w(()=>{var t,s;return(s=(t=this.viewModel)==null?void 0:t.view)==null?void 0:s.ready},(t,s)=>this._viewReadyChange(t??!1,s??!1)),w(()=>{var t,s;return[(t=this.viewModel)==null?void 0:t.waitingForResult,(s=this.viewModel)==null?void 0:s.location]},()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),w(()=>{var t;return(t=this.viewModel)==null?void 0:t.screenLocation},()=>this._closeOpenActionMenu()),w(()=>this.selectedFeatureWidget,()=>this._destroyDrillInFlowItemWidgets()),w(()=>{var s;const t=(s=this.selectedFeatureWidget)==null?void 0:s.viewModel;return[t==null?void 0:t.title,t==null?void 0:t.state]},()=>this._setTitleFromFeatureWidget()),w(()=>{var s;const t=(s=this.selectedFeatureWidget)==null?void 0:s.viewModel;return[t==null?void 0:t.content,t==null?void 0:t.state]},()=>this._setContentFromFeatureWidget()),w(()=>{var t;return(t=this.viewModel)==null?void 0:t.featureViewModels},()=>this._featureMenuViewportScrollTop()),w(()=>this._drillInFlowItems.length,()=>this._focusFlowItemNode()),this._drillInWidget.on("close",()=>this.close()),this._drillInWidget.on("exit",()=>this._destroyDrillInFlowItemWidgets()),this._drillInWidget.on("open-feature",({feature:t})=>this._openRelatedFeature(t)),this._drillInWidget.on("zoom-to-feature",({featureWidget:t})=>er(this.viewModel,t))])}loadDependencies(){return Fe({action:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vW),__vite__mapDeps([0,1]),import.meta.url),"action-bar":()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vY),__vite__mapDeps([0,1]),import.meta.url),"action-group":()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vX),__vite__mapDeps([0,1]),import.meta.url),button:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vZ),__vite__mapDeps([0,1]),import.meta.url),icon:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vV),__vite__mapDeps([0,1]),import.meta.url),flow:()=>_(()=>import("./index-lMnjL2dc.js"),__vite__mapDeps([55,0,1]),import.meta.url),"flow-item":()=>_(()=>import("./index-D4Fyp3lU.js"),__vite__mapDeps([53,0,1]),import.meta.url),list:()=>_(()=>import("./index-BoOF33T4.js"),__vite__mapDeps([40,0,1,41,42,43]),import.meta.url),"list-item":()=>_(()=>import("./index-D9YxSY9e.js"),__vite__mapDeps([44,0,1,45,46,47,48,43,49]),import.meta.url),"list-item-group":()=>_(()=>import("./index-Br9-2cP7.js"),__vite__mapDeps([56,0,1,49]),import.meta.url),loader:()=>_(()=>import("./index-BFudLC3v.js").then(i=>i.vU),__vite__mapDeps([0,1]),import.meta.url)})}destroy(){var i,e,t;this._destroyDrillInFlowItemWidgets(),this._destroySelectedFeatureWidget(),this._destroySpinner(),this._unobserveFeatureMenuObserver(),(i=this._featureMenuIntersectionObserver)==null||i.disconnect(),(e=this._drillInWidget)==null||e.destroy(),(t=this._focusAbortController)==null||t.abort()}get _hideActionText(){var e;if(!this.responsiveActionsEnabled)return!1;const i=(e=this.view)==null?void 0:e.widthBreakpoint;return i==="xsmall"||i==="small"||i==="medium"}get _featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&!!this.viewModel.selectedFeature&&this.visibleElements.featureNavigation}get _isCollapsed(){return this._collapseEnabled&&this.collapsed}get _collapseEnabled(){return this.visibleElements.collapseButton&&(this.initialDisplayMode==="list"||!!this.title&&!!this.content)}get active(){return this.viewModel.active}get content(){return this.viewModel.content}set content(i){this.viewModel.content=i}get icon(){return null}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(i){this.viewModel.featureMenuOpen=i}get featureMenuTitle(){return this.viewModel.featureMenuTitle}set featureMenuTitle(i){this.viewModel.featureMenuTitle=i}get features(){return this.viewModel.features}set features(i){this.viewModel.features=i}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(i){this.viewModel.goToOverride=i}get initialDisplayMode(){return this.viewModel.initialDisplayMode}set initialDisplayMode(i){this.viewModel.initialDisplayMode=i}get location(){return this.viewModel.location}set location(i){this.viewModel.location=i}get label(){var i;return((i=this.messages)==null?void 0:i.widgetLabel)??""}set label(i){this._overrideIfSome("label",i)}get map(){return this.viewModel.map}set map(i){this.viewModel.map=i}get promises(){return this.viewModel.promises}set promises(i){this.viewModel.promises=i}get selectedFeature(){return this.viewModel.selectedFeature}get selectedDrillInFeature(){const i=Array.from(this._drillInFlowItems).at(-1);if(!i)return null;const{flowType:e}=i;return e==="feature-association"||e==="feature-relationship"?i.graphic??null:null}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(i){this.viewModel.selectedFeatureIndex=i}get selectedFeatureWidget(){const{_feature:i,headingLevel:e,_drillInFlowItems:t,timeZone:s,spatialReference:r,map:n}=this,{selectedFeatureViewModel:a}=this.viewModel,d={title:!1};return a?(i?(i.viewModel=a,i.visibleElements=d):this._feature=new Zs({flowItems:t,headingLevel:e+1,timeZone:s,spatialReference:r,map:n,viewModel:a,visibleElements:d}),this._feature):null}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(i){this.viewModel.spatialReference=i}get title(){return this.viewModel.title}set title(i){this.viewModel.title=i}get timeZone(){return this.viewModel.timeZone}set timeZone(i){this.viewModel.timeZone=i}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(i){this.viewModel.updateLocationEnabled=i}get view(){return this.viewModel.view}set view(i){this.viewModel.view=i}get visible(){return this.viewModel.visible}set visible(i){this.viewModel.visible=i}blur(){var e;const{active:i}=this.viewModel;i?(e=this._rootFlowItemNode)==null||e.blur():se.getLogger(this).warn("Features can only be blurred when currently active.")}clear(){return this.viewModel.clear()}close(){this.viewModel.visible=!1}fetchFeatures(i,e){return this.viewModel.fetchFeatures(i,e)}focus(){const{active:i}=this.viewModel;i?this._focusFlowItemNode():se.getLogger(this).warn("Features can only be focused when currently active.")}next(){return this.viewModel.next()}open(i){this.removeHandles(bs);const e={collapsed:(i==null?void 0:i.collapsed)??!1};this.set(e),this.viewModel.open(i),this.addHandles(Je(()=>!this.viewModel.waitingForResult,()=>this._addSelectedFeatureIndexHandle(),{once:!0}))}previous(){return this.viewModel.previous()}triggerAction(i){return this.viewModel.triggerAction(i)}render(){return p("div",{afterCreate:this._storeRootNode,bind:this,class:this.classes(W.base,T.widget,T.panel),onkeydown:this._onMainKeydown},this._renderHeader(),this._renderContentContainer())}_renderFeatureNavigation(){return[this._renderPagination(),this.initialDisplayMode==="list"?this._renderFeaturePaginationText():this._renderFeatureMenuButton()]}_renderHeader(){return this.featureNavigationTop&&this._featureNavigationVisible?p("div",{class:W.header,key:"header-actions"},this._renderFeatureNavigation()):null}_renderFooter(){return!this.featureNavigationTop&&this._featureNavigationVisible?p("div",{class:W.footer,key:"footer-actions",slot:"footer"},this._renderFeatureNavigation()):null}_renderFeaturePaginationText(){const{messages:i,viewModel:e}=this,{featureCount:t,selectedFeatureIndex:s}=e;return p("div",{class:W.paginationText,key:"feature-pagination-text"},me(i.pageText,{index:ut(s+1),total:ut(t)}))}_renderFeatureMenuButton(){const{messages:i,viewModel:e}=this,{featureCount:t,selectedFeatureIndex:s,pendingPromisesCount:r}=e;return p("calcite-action",{appearance:"solid",bind:this,class:W.paginationMenuButton,icon:"list",key:"feature-menu-button",label:i.selectFeature,loading:r>0,onclick:this._openFeatureMenu,scale:"s",text:me(i.pageText,{index:ut(s+1),total:ut(t)}),textEnabled:!0,title:i.selectFeature})}_renderPagination(){const{previous:i,next:e}=this.messagesCommon.pagination;return p("calcite-action-bar",{class:W.paginationActionBar,expandDisabled:!0,key:"pagination-action-bar",layout:"horizontal",overflowActionsDisabled:!0,scale:"s"},p("calcite-action-group",{scale:"s"},p("calcite-action",{appearance:"solid",class:W.paginationPrevious,icon:"chevron-left",iconFlipRtl:!0,label:i,onclick:this._previousFeature,scale:"s",text:i,title:i}),p("calcite-action",{appearance:"solid",icon:"chevron-right",iconFlipRtl:!0,label:e,onclick:this._nextFeature,scale:"s",text:e,title:e})))}_renderFeatureMenuItem(i){const{initialDisplayMode:e}=this,{selectedFeatureViewModel:t,featureViewModels:s}=this.viewModel,r=i===t,n=s.indexOf(i);return p("calcite-list-item",{bind:this,"data-feature-index":n,key:`feature-menu-item-${i.uid}`,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onmouseleave:this._removeActiveFeature,onmouseover:this._setActiveFeature,selected:r,onCalciteListItemSelect:this._selectFeature},p("span",{innerHTML:i.title||this.messagesCommon.untitled,slot:"content"}),e==="list"?p("calcite-icon",{flipRtl:!0,icon:"chevron-right",scale:"s",slot:"content-end"}):null)}_groupResultsByLayer(){const{featureViewModels:i}=this.viewModel,e=new Map;return i.forEach(t=>{const s=t==null?void 0:t.graphic;if(!s)return;const{layer:r,sourceLayer:n}=s,a=(Ms(r)?r:null)||(Ms(n)?n:null),d=e.get(a)??[];e.set(a,[...d,t])}),e}_renderFeatureMenu(){const{messages:i,viewModel:e}=this,t=this._groupResultsByLayer(),s=this.initialDisplayMode==="list"?"none":"single";return e.featureViewModels.length?p("calcite-list",{displayMode:"flat",label:i==null?void 0:i.featuresList,selectionAppearance:"icon",selectionMode:s},Array.from(t.keys(),r=>{var d;const n=(d=t.get(r))==null?void 0:d.map(c=>this._renderFeatureMenuItem(c)),a=r?r.title??this.messagesCommon.untitled:null;return this.visibleElements.featureListLayerTitle&&a!==null?p("calcite-list-item-group",{heading:a,key:(r==null?void 0:r.uid)||"map-graphics"},n):n})):null}_renderHeaderAction(i,e){const t=i.title||"";return i.visible?p("calcite-action",{active:i.type==="toggle"&&i.value,appearance:"solid",bind:this,"data-action-id":i.id,"data-action-uid":i.uid,disabled:i.disabled,icon:i.icon??void 0,indicator:i.indicator,key:`header-action-${e}`,loading:i.active,onclick:this._triggerHeaderAction,slot:"header-actions-end",text:t,title:t}):null}_renderHeaderActions(){return this.headerActions.map((i,e)=>this._renderHeaderAction(i,e)).toArray()}_renderContentFeature(){const{headingLevel:i,visibleElements:e,_isCollapsed:t,_collapseEnabled:s,featureNavigationTop:r,_drillInFlowItems:n,initialDisplayMode:a,selectedFeature:d,featureMenuOpen:c}=this,{title:u,active:h}=this.viewModel,m=e.heading&&u?u:"";if(a==="list"&&!d)return null;const f=n.length===0&&(a==="list"?!!d:!c);return p("calcite-flow-item",{afterCreate:this._storeRootFlowItemNode,bind:this,class:this.classes({[W.contentFeature]:!0,[W.flowItemCollapsed]:t}),closable:e.closeButton,closed:!h,collapsed:t,collapseDirection:r?"down":"up",collapsible:s,headingLevel:i,key:"root-flow-item",selected:f,onCalciteFlowItemBack:this._handleFeatureBack,onCalciteFlowItemClose:this.close,onCalciteFlowItemToggle:this._handleCollapseToggle},m?p(Ai,{class:this.classes(W.featuresHeading,T.heading),innerHTML:m,key:"header-content",level:this.headingLevel,slot:"header-content"}):null,this._renderHeaderActions(),this._renderActionBar(),p("div",{class:this.classes(W.container,W.contentContainer)},this._renderContent()),this._renderFooter())}_renderFeatureMenuContainer(){const{viewModel:i,visibleElements:e,featureMenuTitle:t,messages:s,messagesCommon:r,_drillInFlowItems:n,initialDisplayMode:a,featureMenuOpen:d,selectedFeature:c,_collapseEnabled:u,_isCollapsed:h,featureNavigationTop:m,headingLevel:f}=this,{active:g,featureViewModels:y,pendingPromisesCount:v}=i,{featureMenuHeading:b}=e,I=t??s.selectFeature;if(a==="feature"&&!d)return null;const M=n.length===0&&(a==="list"?!c:d);return p("calcite-flow-item",{afterCreate:this._storeFeatureMenuFlowItemNode,bind:this,class:this.classes({[W.flowItemCollapsed]:h}),closable:a==="list"&&e.closeButton,closed:!g,collapsed:a==="list"&&h,collapseDirection:m?"down":"up",collapsible:a==="list"&&u,description:b?me(s.total,{total:y.length}):void 0,heading:b?I:void 0,headingLevel:f,key:"feature-menu",loading:i.waitingForContents,selected:M,onCalciteFlowItemBack:E=>{E.preventDefault(),this._handleFeatureMenuBack()},onCalciteFlowItemClose:this.close,onCalciteFlowItemToggle:this._handleCollapseToggle},a==="list"?this._renderHeaderActions():null,v>0?p("calcite-loader",{class:W.loader,inline:!0,key:"feature-menu-loader",label:r.loading,slot:"header-actions-end"}):null,p("div",{class:W.container},this._renderFeatureMenu()),p("div",{afterCreate:this._featureMenuIntersectionObserverCreated,bind:this,class:W.featureMenuObserver}),a==="feature"?p("calcite-button",{appearance:"transparent",onclick:this._handleFeatureMenuBack,slot:"footer-actions",width:"full"},r.back):null)}_renderContentContainer(){const i=this.initialDisplayMode==="list"?[this._renderFeatureMenuContainer(),this._renderContentFeature(),this._drillInWidget.render()]:[this._renderContentFeature(),this._renderFeatureMenuContainer(),this._drillInWidget.render()];return this.visibleElements.flow?p("calcite-flow",{key:"content-container"},i):i}_getFallbackIcon(i){const{className:e,icon:t}=i;if(t)return null;const s=Kr({action:i,feature:this.selectedFeature}),r={[W.icon]:!!e,[W.actionImage]:!!s};return e&&(r[e]=!0),s||e?p("span",{"aria-hidden":"true",class:this.classes(W.icon,r),key:"icon",styles:en(s)}):null}_renderActionBar(){var i;return!this._isCollapsed&&this.visibleElements.actionBar&&((i=this.viewModel.allActions)!=null&&i.length)?p("calcite-action-bar",{expandDisabled:!0,expanded:!this._hideActionText,key:"header-action-bar",scale:"s",slot:"action-bar"},p("calcite-action-group",{afterCreate:e=>this._actionBarMenuNode=e,overlayPositioning:"fixed",scale:"s"},this._renderActions())):null}_renderActions(){return this.viewModel.allActions.toArray().map(this._renderAction)}_renderContent(){var e;const i=(e=this.viewModel)==null?void 0:e.content;return i?typeof i=="string"?p("div",{class:B.contentNode,innerHTML:i,key:i}):this.renderNodeContent(i):null}_handleCollapseToggle(){this.collapsed=!this.collapsed}async _openRelatedFeature(i){await i.viewModel.updateGeometry();const e=i.graphic,t=e==null?void 0:e.geometry;if(t==null||e==null)return;this._destroyDrillInFlowItemWidgets(),await this.viewModel.zoomTo({target:t});const s=hi(t);this.open({features:[e],location:s??void 0}),this._focusFlowItemNode()}async _focusFlowItemNode(){var t,s;(t=this._focusAbortController)==null||t.abort(),this._focusAbortController=new AbortController;const i=this._focusAbortController.signal;await De(Rs(i));const e=(s=this._rootNode)==null?void 0:s.querySelector("calcite-flow-item[selected]");tn(e)}_storeRootFlowItemNode(i){this._rootFlowItemNode=i}_storeFeatureMenuFlowItemNode(i){this._featureMenuViewportNode=i}_setActiveFeature(i){var s;const{viewModel:e}=this,t=i.currentTarget["data-feature-index"];e.activeFeature=((s=e.features)==null?void 0:s[t])||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_selectFeature(i){const e=i.currentTarget["data-feature-index"];isNaN(e)||(this.viewModel.selectedFeatureIndex=e),this.initialDisplayMode==="feature"?this._handleFeatureMenuBack():this._focusFlowItemNode()}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(i){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(i),this._featureMenuIntersectionObserverNode=i}_getActionIcon(i){return i.icon?i.icon:i.image||i.className?void 0:"question"}_getActionTitle(i){const{messages:e,selectedFeature:t,messagesCommon:s}=this,{id:r}=i,n=t==null?void 0:t.attributes,a=i.title??"",d=r==="zoom-to-feature"?me(a,{messages:e}):r==="remove-selected-feature"?me(a,{messages:s}):r==="zoom-to-clustered-features"||r==="browse-clustered-features"?me(a,{messages:e}):i.title;return d&&n?me(d,n):d??""}_onMainKeydown(i){const{key:e}=i;e==="ArrowLeft"&&(i.stopPropagation(),this._handleFeatureMenuBack(),this.previous()),e==="ArrowRight"&&(i.stopPropagation(),this._handleFeatureMenuBack(),this.next())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&this._featureMenuViewportNode.scrollContentTo({top:0})}_setContentFromFeatureWidget(){const{selectedFeatureWidget:i}=this;i&&(this.viewModel.content=i)}_setTitleFromFeatureWidget(){const{selectedFeatureWidget:i,messagesCommon:e}=this,t=i==null?void 0:i.viewModel;i&&(this.viewModel.title=(t==null?void 0:t.state)==="error"?e==null?void 0:e.errorMessage:(t==null?void 0:t.title)||"")}_addSelectedFeatureIndexHandle(){const i=w(()=>{var e;return(e=this.viewModel)==null?void 0:e.selectedFeatureIndex},(e,t)=>this._selectedFeatureIndexUpdated(e,t));this.addHandles(i,bs)}_selectedFeatureIndexUpdated(i,e){const{featureCount:t}=this.viewModel;t&&i!==e&&i!==-1&&(this._destroyDrillInFlowItemWidgets(),this._rootFlowItemNode&&this._rootFlowItemNode.scrollContentTo({top:0}))}_triggerHeaderAction(i){const e=i.currentTarget;if(e.disabled)return;const t=e.dataset.actionUid,s=this.headerActions.find(({uid:r})=>r===t);s&&!s.disabled&&((s==null?void 0:s.type)==="toggle"&&(s.value=!s.value),this.emit("trigger-header-action",{action:s}))}_triggerAction(i){const e=i.currentTarget;if(e.disabled)return;const t=e.dataset.actionUid,{allActions:s}=this.viewModel,r=s.findIndex(a=>a.uid===t),n=s.at(r);n&&n.type==="toggle"&&(n.value=!n.value),this.viewModel.triggerAction(r)}_createSpinner(i){i&&(this._spinner=new Wo({view:i}),i.ui.add(this._spinner,{key:Is,position:"manual",internal:!0}))}_wireUpView(i){var e;this._destroySpinner(),i&&((e=this.visibleElements)!=null&&e.spinner)&&this._createSpinner(i)}_hideSpinner(){const{_spinner:i}=this;i&&(i.location=null,i.hide())}_viewReadyChange(i,e){var t;i?this._wireUpView((t=this.viewModel)==null?void 0:t.view):e&&this.viewModel.clear()}_viewChange(i,e){i&&e&&this.viewModel.clear()}_destroySelectedFeatureWidget(){const{_feature:i}=this;i&&(i.viewModel=null,!i.destroyed&&i.destroy()),this._feature=null}_closeOpenActionMenu(){const{_actionBarMenuNode:i}=this;i&&(i.menuOpen=!1)}_destroyDrillInFlowItemWidgets(){this._drillInFlowItems.drain(i=>{"showAllEnabled"in i.viewModel&&(i.viewModel.showAllEnabled=!1),i.viewModel=null,i.destroy()})}_toggleScreenLocationEnabled(){const{viewModel:i}=this;i&&(i.screenLocationEnabled=i.active)}_displaySpinner(){const{_spinner:i}=this;if(!i)return;const{location:e,waitingForResult:t}=this.viewModel;t&&e?i.show({location:e}):i.hide()}_destroySpinner(){var e,t;const{_spinner:i}=this;i&&((t=(e=i.view)==null?void 0:e.ui)==null||t.remove(i,Is),i.destroy(),this._spinner=null)}_spinnerEnabledChange(i){var e;this._destroySpinner(),i&&this._createSpinner((e=this.viewModel)==null?void 0:e.view)}};o([l()],x.prototype,"_drillInFlowItems",void 0),o([l()],x.prototype,"_hideActionText",null),o([l()],x.prototype,"_featureNavigationVisible",null),o([l()],x.prototype,"_isCollapsed",null),o([l()],x.prototype,"_collapseEnabled",null),o([l({readOnly:!0})],x.prototype,"active",null),o([l()],x.prototype,"collapsed",void 0),o([l()],x.prototype,"content",null),o([l()],x.prototype,"icon",null),o([l()],x.prototype,"featureMenuOpen",null),o([l()],x.prototype,"featureMenuTitle",null),o([l()],x.prototype,"featureNavigationTop",void 0),o([l()],x.prototype,"features",null),o([l()],x.prototype,"goToOverride",null),o([l({type:Xe})],x.prototype,"headerActions",void 0),o([l()],x.prototype,"headingLevel",void 0),o([l()],x.prototype,"initialDisplayMode",null),o([l()],x.prototype,"location",null),o([l()],x.prototype,"label",null),o([l()],x.prototype,"map",null),o([l(),re("esri/widgets/Features/t9n/Features")],x.prototype,"messages",void 0),o([l(),re("esri/t9n/common")],x.prototype,"messagesCommon",void 0),o([l()],x.prototype,"promises",null),o([l()],x.prototype,"responsiveActionsEnabled",void 0),o([l({readOnly:!0})],x.prototype,"selectedFeature",null),o([l({readOnly:!0})],x.prototype,"selectedDrillInFeature",null),o([l()],x.prototype,"selectedFeatureIndex",null),o([l({readOnly:!0})],x.prototype,"selectedFeatureWidget",null),o([l()],x.prototype,"spatialReference",null),o([l()],x.prototype,"title",null),o([l()],x.prototype,"timeZone",null),o([l()],x.prototype,"updateLocationEnabled",null),o([l()],x.prototype,"view",null),o([l({type:Zt}),Os(["triggerAction","trigger-action"])],x.prototype,"viewModel",void 0),o([l({type:tr,nonNullable:!0})],x.prototype,"visibleElements",void 0),o([l()],x.prototype,"visible",null),x=o([k("esri.widgets.Features")],x);const ra=x,pe="esri-popup",Be=`${pe}--is-docked`,j={base:pe,baseHidden:`${pe}--hidden`,main:`${pe}__main-container`,shadow:`${pe}--shadow`,isDocked:Be,isDockedTopLeft:`${Be}-top-left`,isDockedTopCenter:`${Be}-top-center`,isDockedTopRight:`${Be}-top-right`,isDockedBottomLeft:`${Be}-bottom-left`,isDockedBottomCenter:`${Be}-bottom-center`,isDockedBottomRight:`${Be}-bottom-right`,alignTopCenter:`${pe}--aligned-top-center`,alignBottomCenter:`${pe}--aligned-bottom-center`,alignTopLeft:`${pe}--aligned-top-left`,alignBottomLeft:`${pe}--aligned-bottom-left`,alignTopRight:`${pe}--aligned-top-right`,alignBottomRight:`${pe}--aligned-bottom-right`,pointer:`${pe}__pointer`,pointerDirection:`${pe}__pointer-direction`};let fi=class extends Zt{constructor(i){super(i)}};fi=o([k("esri.widgets.Popup.PopupViewModel")],fi);const ir=fi;let we=class extends ye{constructor(){super(...arguments),this.actionBar=!0,this.closeButton=!0,this.collapseButton=!0,this.featureMenuHeading=!0,this.featureNavigation=!0,this.featureListLayerTitle=!0,this.heading=!0,this.spinner=!0}};o([l({type:Boolean,nonNullable:!0})],we.prototype,"actionBar",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"closeButton",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"collapseButton",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"featureMenuHeading",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"featureNavigation",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"featureListLayerTitle",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"heading",void 0),o([l({type:Boolean,nonNullable:!0})],we.prototype,"spinner",void 0),we=o([k("esri.widgets.Popup.PopupVisibleElements")],we);const sr=we,na=200,As={buttonEnabled:!0,position:"auto",breakpoint:{width:544}};let L=class extends he{constructor(i,e){super(i,e),this._dockAction=new bt({id:"popup-dock-action"}),this._featuresWidget=new ra({responsiveActionsEnabled:!0}),this._containerNode=null,this._mainContainerNode=null,this._pointerOffsetInPx=16,this._focusAbortController=null,this.alignment="auto",this.dockEnabled=!1,this.headingLevel=2,this.messages=null,this.viewModel=new ir,this.visibleElements=new sr}initialize(){this.addHandles([w(()=>{var i,e;return[(e=(i=this.viewModel)==null?void 0:i.view)==null?void 0:e.widthBreakpoint,this.dockEnabled]},()=>this._handleDockIcon(),P),w(()=>{var i,e;return[this.dockEnabled,(i=this.messages)==null?void 0:i.undock,(e=this.messages)==null?void 0:e.dock]},()=>this._handleDockEnabled(),P),w(()=>this.dockOptions,i=>{const{_dockAction:e}=this,t=this._featuresWidget.headerActions;t.remove(e),i.buttonEnabled&&t.add(e)},P),w(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},()=>this._positionContainer()),w(()=>{var i;return[(i=this.viewModel)==null?void 0:i.active,this.dockEnabled]},()=>this._toggleScreenLocationEnabled()),w(()=>{var i,e,t,s,r,n,a;return[(i=this.viewModel)==null?void 0:i.screenLocation,(t=(e=this.viewModel)==null?void 0:e.view)==null?void 0:t.padding,(r=(s=this.viewModel)==null?void 0:s.view)==null?void 0:r.size,(n=this.viewModel)==null?void 0:n.active,(a=this.viewModel)==null?void 0:a.location,this.alignment]},()=>this.reposition()),w(()=>{var i,e;return(e=(i=this.viewModel)==null?void 0:i.view)==null?void 0:e.size},(i,e)=>this._updateDockEnabledForViewSize(i,e)),w(()=>{var i;return(i=this.viewModel)==null?void 0:i.view},(i,e)=>this._viewChange(i,e)),w(()=>{var i,e;return(e=(i=this.viewModel)==null?void 0:i.view)==null?void 0:e.ready},(i,e)=>this._viewReadyChange(i??!1,e??!1)),w(()=>this.viewModel,()=>this._featuresWidget.viewModel=this.viewModel,P),w(()=>this._featureNavigationTop,i=>this._featuresWidget.featureNavigationTop=i,P),w(()=>this.headingLevel,i=>this._featuresWidget.headingLevel=i,P),w(()=>this.visibleElements.actionBar,i=>this._featuresWidget.visibleElements.actionBar=!!i,P),w(()=>this.visibleElements.closeButton,i=>this._featuresWidget.visibleElements.closeButton=!!i,P),w(()=>this.visibleElements.collapseButton,i=>this._featuresWidget.visibleElements.collapseButton=!!i,P),w(()=>this.visibleElements.heading,i=>this._featuresWidget.visibleElements.heading=!!i,P),w(()=>this.visibleElements.spinner,i=>this._featuresWidget.visibleElements.spinner=!!i,P),w(()=>this.visibleElements.featureNavigation,i=>this._featuresWidget.visibleElements.featureNavigation=!!i,P),w(()=>this.visibleElements.featureListLayerTitle,i=>this._featuresWidget.visibleElements.featureListLayerTitle=!!i,P),yt(()=>this._featuresWidget,"trigger-header-action",i=>{i.action===this._dockAction&&(this.dockEnabled=!this.dockEnabled)})])}destroy(){var i;this._dockAction.destroy(),this._featuresWidget&&(this._featuresWidget.viewModel=new Zt,this._featuresWidget.destroy()),(i=this._focusAbortController)==null||i.abort()}get _featureNavigationTop(){const{currentAlignment:i,currentDockPosition:e}=this;return i==="bottom-left"||i==="bottom-center"||i==="bottom-right"||e==="top-left"||e==="top-center"||e==="top-right"}get actions(){return this.viewModel.actions}set actions(i){this.viewModel.actions=i}get active(){return this.viewModel.active}get autoCloseEnabled(){return this.viewModel.autoCloseEnabled}set autoCloseEnabled(i){this.viewModel.autoCloseEnabled=i}get defaultPopupTemplateEnabled(){return this.viewModel.defaultPopupTemplateEnabled}set defaultPopupTemplateEnabled(i){this.viewModel.defaultPopupTemplateEnabled=i}get content(){return this.viewModel.content}set content(i){this.viewModel.content=i}get collapsed(){return this._featuresWidget.collapsed}set collapsed(i){this._featuresWidget.collapsed=i}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||As}set dockOptions(i){var d,c;const e={...As},t=(c=(d=this.viewModel)==null?void 0:d.view)==null?void 0:c.breakpoints,s={};t&&(s.width=t.xsmall,s.height=t.xsmall);const r={...e,...i},n={...e.breakpoint,...s},{breakpoint:a}=r;typeof a=="object"?r.breakpoint={...n,...a}:a&&(r.breakpoint=n),this._set("dockOptions",r),this._setCurrentDockPosition(),this.reposition()}get featureCount(){return this.viewModel.featureCount}get featureMenuOpen(){return this.viewModel.featureMenuOpen}set featureMenuOpen(i){this.viewModel.featureMenuOpen=i}get features(){return this.viewModel.features}set features(i){this.viewModel.features=i}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(i){this.viewModel.goToOverride=i}get highlightEnabled(){return this.viewModel.highlightEnabled}set highlightEnabled(i){this.viewModel.highlightEnabled=i}get icon(){return"popup"}set icon(i){this._overrideIfSome("icon",i)}get initialDisplayMode(){return this.viewModel.initialDisplayMode}set initialDisplayMode(i){this.viewModel.initialDisplayMode=i}get location(){return this.viewModel.location}set location(i){this.viewModel.location=i}get label(){var i;return((i=this.messages)==null?void 0:i.widgetLabel)??""}set label(i){this._overrideIfSome("label",i)}get promises(){return this.viewModel.promises}set promises(i){this.viewModel.promises=i}get selectedFeature(){return this.viewModel.selectedFeature}get selectedDrillInFeature(){return this._featuresWidget.selectedDrillInFeature??null}get selectedFeatureIndex(){return this.viewModel.selectedFeatureIndex}set selectedFeatureIndex(i){this.viewModel.selectedFeatureIndex=i}get selectedFeatureWidget(){return this._featuresWidget.selectedFeatureWidget}get title(){return this.viewModel.title}set title(i){this.viewModel.title=i}get updateLocationEnabled(){return this.viewModel.updateLocationEnabled}set updateLocationEnabled(i){this.viewModel.updateLocationEnabled=i}get view(){return this.viewModel.view}set view(i){this.viewModel.view=i}get visible(){return this.viewModel.visible}set visible(i){this.viewModel.visible=i}blur(){const{active:i}=this.viewModel;i||se.getLogger(this).warn("Popup can only be blurred when currently active."),this._featuresWidget.blur()}clear(){return this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(i,e){return this.viewModel.fetchFeatures(i,e)}focus(){const{active:i}=this.viewModel;i||se.getLogger(this).warn("Popup can only be focused when currently active."),this._handleFocus()}next(){return this.viewModel.next()}open(i){const e=!!i&&!!i.featureMenuOpen,t={collapsed:!!i&&!!i.collapsed,featureMenuOpen:e};this.set(t),this.viewModel.open(i),i!=null&&i.shouldFocus&&this._handleFocus(!0)}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(i){return this.viewModel.triggerAction(i)}render(){var h,m,f,g;const{dockEnabled:i,currentAlignment:e,currentDockPosition:t}=this,{active:s,screenLocation:r}=this.viewModel,n=s&&i,a=s&&!i,d=(m=(h=this.selectedFeature)==null?void 0:h.layer)==null?void 0:m.title,c=(g=(f=this.selectedFeature)==null?void 0:f.layer)==null?void 0:g.id,u={[j.alignTopCenter]:e==="top-center",[j.alignBottomCenter]:e==="bottom-center",[j.alignTopLeft]:e==="top-left",[j.alignBottomLeft]:e==="bottom-left",[j.alignTopRight]:e==="top-right",[j.alignBottomRight]:e==="bottom-right",[j.isDocked]:n,[j.shadow]:a,[j.isDockedTopLeft]:t==="top-left",[j.isDockedTopCenter]:t==="top-center",[j.isDockedTopRight]:t==="top-right",[j.isDockedBottomLeft]:t==="bottom-left",[j.isDockedBottomCenter]:t==="bottom-center",[j.isDockedBottomRight]:t==="bottom-right"};return p("div",{afterCreate:this._positionContainer,afterUpdate:this._positionContainer,"aria-hidden":(!s).toString(),"aria-label":sn(this.title??""),"aria-modal":"false",bind:this,class:this.classes(j.base,u,{[j.baseHidden]:!r&&!i}),"data-layer-id":c,"data-layer-title":d,role:"dialog"},s?[this._renderMainContainer(),this._renderPointer()]:null)}_renderPointer(){return this.dockEnabled?null:p("div",{class:j.pointer,key:"popup-pointer",role:"presentation"},p("div",{class:this.classes(j.pointerDirection,j.shadow)}))}_renderMainContainer(){const{dockEnabled:i}=this,e={[j.shadow]:i};return p("div",{afterCreate:this._setMainContainerNode,afterUpdate:this._setMainContainerNode,bind:this,class:this.classes(j.main,T.widget,e)},this._featuresWidget.render())}_getAnimationDurationMS(){const{_containerNode:i}=this;return i?1e3*parseFloat(window.getComputedStyle(i).animationDuration):na}async _handleFocus(i=!1){var t;(t=this._focusAbortController)==null||t.abort(),this._focusAbortController=new AbortController;const e=this._focusAbortController.signal;i&&await qt(()=>{var s;return((s=this.viewModel)==null?void 0:s.active)===!0},{signal:e}),await De(Rs(e)),await De(bi(this._getAnimationDurationMS(),e)),this._featuresWidget.focus()}_isOutsideView(i){const{popupHeight:e,popupWidth:t,screenLocation:s,side:r,view:n}=i;if(isNaN(t)||isNaN(e)||!n||!s)return!1;const a=n.padding;return r==="right"&&s.x+t/2>n.width-a.right||r==="left"&&s.x-t/2<a.left||r==="top"&&s.y-e<a.top||r==="bottom"&&s.y+e>n.height-a.bottom}_calculateAutoAlignment(i){if(i!=="auto")return i;const{_pointerOffsetInPx:e,_containerNode:t,_mainContainerNode:s,viewModel:r}=this,{screenLocation:n,view:a}=r;if(n==null||!a||!t)return"top-center";function d(E){return parseInt(E.replaceAll(/[^-\d.]/g,""),10)}const c=s?window.getComputedStyle(s,null):null,u=c?d(c.getPropertyValue("max-height")):0,h=c?d(c.getPropertyValue("height")):0,{height:m,width:f}=t.getBoundingClientRect(),g=f+e,y=Math.max(m,u,h)+e,v=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"right",view:a}),b=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"left",view:a}),I=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"top",view:a}),M=this._isOutsideView({popupHeight:y,popupWidth:g,screenLocation:n,side:"bottom",view:a});return b?I?"bottom-right":"top-right":v?I?"bottom-left":"top-left":I?M?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(i){return typeof i=="function"?i.call(this):i}_getCurrentAlignment(){const{alignment:i,dockEnabled:e}=this;return e||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(i)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(i){const e=["left","right"];return $e(this.container)&&e.reverse(),i==null?void 0:i.replace(/leading/gi,e[0]).replaceAll(/trailing/gi,e[1])}_callDockPosition(i){return typeof i=="function"?i.call(this):i}_getDockPosition(){var i;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((i=this.dockOptions)==null?void 0:i.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_calculateAutoDockPosition(i){var a;if(i!=="auto")return i;const e=(a=this.viewModel)==null?void 0:a.view,t=$e(this.container)?"top-left":"top-right";if(!e)return t;const s=e.padding||{left:0,right:0,top:0,bottom:0},r=e.width-s.left-s.right,{breakpoints:n}=e;return n&&r<=n.xsmall?"bottom-center":t}_getDockIcon(){const i=this._getDockPosition();if(this.dockEnabled)return"minimize";switch(i){case"top-left":case"bottom-left":return"dock-left";case"top-center":return"maximize";case"bottom-center":return"dock-bottom";default:return"dock-right"}}_handleDockIcon(){this._dockAction.icon=this._getDockIcon()}_handleDockEnabled(){var i,e;this._dockAction.title=this.dockEnabled?(i=this.messages)==null?void 0:i.undock:(e=this.messages)==null?void 0:e.dock}_setMainContainerNode(i){this._mainContainerNode=i}_positionContainer(i=this._containerNode){if(i&&(this._containerNode=i),!this._containerNode)return;const{screenLocation:e}=this.viewModel,{width:t}=this._containerNode.getBoundingClientRect(),s=this._calculatePositionStyle(e,t);s&&Object.assign(this._containerNode.style,s)}_calculateFullWidth(i){const{currentAlignment:e,_pointerOffsetInPx:t}=this;return e==="top-left"||e==="bottom-left"||e==="top-right"||e==="bottom-right"?i+t:i}_calculateAlignmentPosition(i,e,t,s){const{currentAlignment:r,_pointerOffsetInPx:n}=this;if(!t)return;const{padding:a}=t,d=s/2,c=t.height-e,u=t.width-i;return r==="bottom-center"?{top:e+n-a.top,left:i-d-a.left}:r==="top-left"?{bottom:c+n-a.bottom,right:u+n-a.right}:r==="bottom-left"?{top:e+n-a.top,right:u+n-a.right}:r==="top-right"?{bottom:c+n-a.bottom,left:i+n-a.left}:r==="bottom-right"?{top:e+n-a.top,left:i+n-a.left}:r==="top-center"?{bottom:c+n-a.bottom,left:i-d-a.left}:void 0}_calculatePositionStyle(i,e){const{dockEnabled:t,view:s}=this;if(!s)return;if(t)return{left:"",top:"",right:"",bottom:""};if(i==null||!e)return;const r=this._calculateFullWidth(e),n=this._calculateAlignmentPosition(i.x,i.y,s,r);return n?{top:n.top!==void 0?`${n.top}px`:"auto",left:n.left!==void 0?`${n.left}px`:"auto",bottom:n.bottom!==void 0?`${n.bottom}px`:"auto",right:n.right!==void 0?`${n.right}px`:"auto"}:void 0}_viewChange(i,e){i&&e&&(this.close(),this.clear())}_viewReadyChange(i,e){i?this._wireUpView():e&&(this.close(),this.clear())}_wireUpView(){this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(i,e,t){const[s,r]=i,[n,a]=e,{width:d=0,height:c=0}=t??{};return s<=d&&n>d||s>d&&n<=d||r<=c&&a>c||r>c&&a<=c}_updateDockEnabledForViewSize(i,e){var u,h;if(!i||!e)return;const t=((h=(u=this.viewModel)==null?void 0:u.view)==null?void 0:h.padding)||{left:0,right:0,top:0,bottom:0},s=t.left+t.right,r=t.top+t.bottom,n=[],a=[];n[0]=i[0]-s,n[1]=i[1]-r,a[0]=e[0]-s,a[1]=e[1]-r;const{dockOptions:d}=this,c=d.breakpoint;this._dockingThresholdCrossed(n,a,c)&&this._setDockEnabledForViewSize(d),this._setCurrentDockPosition()}_toggleScreenLocationEnabled(){const{dockEnabled:i,viewModel:e}=this;if(!e)return;const t=e.active&&!i;e.screenLocationEnabled=t}_shouldDockAtCurrentViewSize(i){var d,c;const e=i.breakpoint,t=(c=(d=this.viewModel)==null?void 0:d.view)==null?void 0:c.ui;if(!t)return!1;const{width:s,height:r}=t;if(isNaN(s)||isNaN(r)||!e)return!1;const n=e.hasOwnProperty("width")&&s<=(e.width??0),a=e.hasOwnProperty("height")&&r<=(e.height??0);return n||a}_setDockEnabledForViewSize(i){i.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(i))}};o([l({readOnly:!0})],L.prototype,"_featureNavigationTop",null),o([l()],L.prototype,"actions",null),o([l({readOnly:!0})],L.prototype,"active",null),o([l()],L.prototype,"alignment",void 0),o([l()],L.prototype,"autoCloseEnabled",null),o([l()],L.prototype,"defaultPopupTemplateEnabled",null),o([l()],L.prototype,"content",null),o([l()],L.prototype,"collapsed",null),o([l({readOnly:!0})],L.prototype,"currentAlignment",null),o([l({readOnly:!0})],L.prototype,"currentDockPosition",null),o([l()],L.prototype,"dockOptions",null),o([l()],L.prototype,"dockEnabled",void 0),o([l({readOnly:!0})],L.prototype,"featureCount",null),o([l()],L.prototype,"featureMenuOpen",null),o([l()],L.prototype,"features",null),o([l()],L.prototype,"goToOverride",null),o([l()],L.prototype,"headingLevel",void 0),o([l()],L.prototype,"highlightEnabled",null),o([l()],L.prototype,"icon",null),o([l()],L.prototype,"initialDisplayMode",null),o([l()],L.prototype,"location",null),o([l()],L.prototype,"label",null),o([l(),re("esri/widgets/Popup/t9n/Popup")],L.prototype,"messages",void 0),o([l()],L.prototype,"promises",null),o([l({readOnly:!0})],L.prototype,"selectedFeature",null),o([l({readOnly:!0})],L.prototype,"selectedDrillInFeature",null),o([l()],L.prototype,"selectedFeatureIndex",null),o([l({readOnly:!0})],L.prototype,"selectedFeatureWidget",null),o([l()],L.prototype,"title",null),o([l()],L.prototype,"updateLocationEnabled",null),o([l()],L.prototype,"view",null),o([l({type:ir}),Os(["triggerAction","trigger-action"])],L.prototype,"viewModel",void 0),o([l()],L.prototype,"visible",null),o([l({type:sr,nonNullable:!0})],L.prototype,"visibleElements",void 0),L=o([k("esri.widgets.Popup")],L);const El=L;export{El as default};
