import{a as us}from"./CIMSymbolHelper-ul9lMn7I.js";import{a2 as Ve,bD as ae,bA as oi,cj as _i,W as u,kx as C,r3 as pe,oY as cs,kb as ri,ke as ps,tr as Z,ts as N,tt as L,tu as G,nH as J,el as dt,eo as _e,ep as Tt,n8 as $i,en as Xe,eq as Pi,mF as ds,tv as Mi,r4 as D,tw as ai,tx as fs,kj as ft,ty as ms,tz as vt,es as be,b as st,em as ni,bJ as li,ak as Ti,ky as He,kz as ye,bL as De,oh as ui,q6 as hs,e_ as ze,ck as ys,oy as bt,mU as ci,tA as vs,ee as bs,rQ as gs,qX as xs,iu as ws,G as Ss,q5 as et,j1 as Vs,aP as zs}from"./index-DKbcOXvO.js";import{g as V,P as de,_ as n,a as y,U as Q,r as U,z as E,a8 as mt,d as ce,y as Le,x as ke,h as g,Q as F,a7 as ee,X as A,l as Ai,T as gt,b as X,f as Se,i as xt,Y as z,a9 as _s,R as Nt,aa as $s,a4 as Ri,a5 as At,c as xe,o as Ci,V as Ii,n as ue,s as K,m as I,e as q,C as Oi,j as Fi,q as we,M as Ut,A as Di,w as Ht,a2 as ne,K as Ee,p as Ze,u as Ei,v as Ps,k as Rt,G as Ms,W as _t,ab as Ts,ac as As,E as pi,L as Rs,ad as Cs}from"./GraphShaderModule-DC334t3a.js";import{j as di,l as Ct,m as fi,p as Qe,u as Je,v as Is,x as Gt,y as Li,A as Os,G as Be,I as qt,K as jt,L as Wt,M as Kt,N as Xt,O as Zt,P as $e,Q as H,c as ki,R as ht,T as Bi,U as wt,V as Ni,W as Yt,X as k,Y as B,Z as St,o as le,_ as Fs,$ as mi,a0 as Qt,a1 as Ds,a2 as Es,a3 as Ls,D as ot,r as hi,e as yi,a4 as Jt,a5 as ks,a6 as Bs,a7 as Ns,a8 as Us,a9 as vi,aa as Ui,ab as bi,F as Hs,a as Gs,ac as Hi,ad as ei,ae as Gi,af as qi,b as tt,g as qs,i as js,q as Ws,d as Ks}from"./UpdateTracking2D-C6eAXqiy.js";import{t as Xs}from"./Technique-UXOeImSB.js";import{E as gi}from"./BufferObject-Bzw_3oj2.js";import{s as Zs,i as ji,x as Wi}from"./Program-HYRYH4Rq.js";import{o as Ys}from"./VertexArrayObject-idG1FX9h.js";import{t as Qs}from"./VertexElementDescriptor-BOD-G50G.js";import{t as Js,c as eo}from"./rasterizingUtils-ZyXE8c0k.js";import{c as xi}from"./WGLContainer-Bfqd03g2.js";import{r as to,s as $t}from"./streamLayerUtils-CKwt2uXH.js";import{QueueProcessor as io}from"./QueueProcessor-Bb2ObthY.js";class so{get forceStaticPath(){return Ve("esri-cim-animations-enable-status")==="disabled"}get forceAnimatedPath(){return Ve("esri-cim-animations-enable-status")==="forced"}get freezeGlobalTime(){return Ve("esri-cim-animations-freeze-time")??!1}get spotlightAnimatedSymbols(){return!!Ve("esri-cim-animations-spotlight")}get forceGlobalTimeOrigin(){return Ve("esri-cim-animations-freeze-time")!==!1}}const ti=new so,It={[ae.BYTE]:1,[ae.UNSIGNED_BYTE]:1,[ae.SHORT]:2,[ae.UNSIGNED_SHORT]:2,[ae.HALF_FLOAT]:2,[ae.INT]:4,[ae.UNSIGNED_INT]:4,[ae.FLOAT]:4};let oo=class{constructor(e,t){this._boundPart=null,this.vertexBuffers=new Map,this.indexBuffers=new Map,this.groups=[];for(const i in t.vertex){const{data:o,attributes:r}=t.vertex[i],a=gi.createVertex(e,oi.STATIC_DRAW,o);this.vertexBuffers.set(i,{buffer:a,attributes:r})}for(const i in t.index){const{data:o}=t.index[i],r=gi.createIndex(e,oi.STATIC_DRAW,o);this.indexBuffers.set(i,{buffer:r})}for(const i of t.groups)this.groups.push({...i,vertexArrays:new Map});this.parts=t.parts}bind(e,t,i){var l;this._boundPart=i;const{group:o}=this.parts[this._boundPart],r=this.groups[o];if(!r)throw new Error(`Missing group ${o}.`);let a=r.vertexArrays.get(t.stringHash);if(!a){const c=new Set(t.locations.keys()),d=r.index?(l=this.indexBuffers.get(r.index))==null?void 0:l.buffer:null,p=new Map,f=new Map;for(const[m,{buffer:h,attributes:x}]of this.vertexBuffers){const v=x.filter(b=>c.has(b.name));v.length>0&&(p.set(m,v),f.set(m,h))}a=new Ys(e,t.locations,p,f,d),r.vertexArrays.set(t.stringHash,a)}e.bindVAO(a)}draw(e){if(this._boundPart==null)throw new Error("Mesh.bind() has not been called.");const{start:t,count:i}=this.parts[this._boundPart],{group:o}=this.parts[this._boundPart],{primitive:r,index:a}=this.groups[o];if(a){const l=this.indexBuffers.get(a);if(!l)throw new Error(`Missing index buffer "${a}".`);const{indexType:c}=l.buffer;if(!c)throw new Error("Buffer type error.");e.drawElements(r,i,c,t*It[c])}else e.drawArrays(r,t,i)}unbind(e){this._boundPart=null,e.bindVAO(null)}destroy(){for(const{vertexArrays:e}of this.groups)for(const[t,i]of e)i.disposeVAOOnly();for(const{buffer:e}of this.vertexBuffers.values())e.dispose();for(const{buffer:e}of this.indexBuffers.values())e.dispose()}};const ro={position:{type:ae.SHORT,count:2}};let ao=class Ot extends oo{static create(e,t){const i=[];let{stride:o}=t;if(o==null){o=0;for(const[p,{count:f,type:m,offset:h}]of Object.entries(t.layout)){if(h!=null)throw new Error("Stride cannot be computed automatically when attribute offsets are supplied explicitly.");o+=f*It[m]}}let r=0;for(const[p,{count:f,offset:m,type:h,normalized:x}]of Object.entries(t.layout)){m!=null&&(r=m);const v=new Qs(p,f,h,r,o,x!=null&&x,0);i.push(v),r+=f*It[h]}const a={primitive:t.primitive};t.index!=null&&(a.index="indexData");let{count:l}=t;if(l==null&&(l=t.index?t.index.length:t.vertex.byteLength/o,Math.floor(l)!==l))throw new Error(`The byte length of vertex data must be an exact multiple of the stride, which is ${o}.`);const c={start:0,count:l,group:0,primitive:t.primitive},d={vertex:{vertexData:{data:t.vertex,attributes:i}},parts:[c],groups:[a]};return t.index!=null&&(d.index={indexData:{data:t.index}}),new Ot(e,d,t.layout)}static fromVertexStream(e,t){return Ot.create(e,{primitive:_i.TRIANGLE_STRIP,vertex:new Uint16Array(t),layout:ro})}constructor(e,t,i){super(e,t),this._spec=i}bind(e,t,i=0){super.bind(e,t,i)}},ve=class extends de{};u([V(n)],ve.prototype,"globalTime",void 0),u([V(y)],ve.prototype,"animationTextureSize",void 0),u([V(Q)],ve.prototype,"animationTexture",void 0),u([V(U)],ve.prototype,"toScreen",void 0),u([V(U)],ve.prototype,"toNdc",void 0),u([V(n)],ve.prototype,"mapRotation",void 0),u([V(n)],ve.prototype,"pixelRatio",void 0);let Vt=class extends de{getVVRotationMat4(e){return E(di(e),mt.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(fi),i=Le(t),o=ke(t);return new mt(o,i,0,0,i.multiply(new n(-1)),o,0,0,0,0,1,0,0,0,0,1)})}getVVRotationMat3(e){return E(di(e),U.identity(),()=>{const t=this.getNormalizedAngle(e).multiply(fi),i=Le(t),o=ke(t);return new U(o,i,0,i.multiply(new n(-1)),o,0,0,0,1)})}getNormalizedAngle(e){const t=ce(this.rotationType,new n(Ct.Arithmatic));return E(t,new n(90).subtract(e),e)}};u([V(n)],Vt.prototype,"rotationType",void 0);class Ft extends Qe{}u([g(3,z)],Ft.prototype,"animationPointerAndBaseSizeAndReferenceSize",void 0),u([g(4,y)],Ft.prototype,"zoomRange",void 0);class no extends $e{}let re=class extends Je{_getScreenPosition(e){const{pos:t,translation:i,rotation:o,scale:r,offset:a,id:l,vvScale:c}=e,d=Is(this,l).multiply(Math.PI/180),p=i.x.multiply(4/3),f=i.y.multiply(-1).multiply(4/3),m=Le(d),h=ke(d),x=h.multiply(p).add(ee(m).multiply(f)),v=m.multiply(p).add(h.multiply(f)),b=Le(o.subtract(d)),w=ke(o.subtract(d)),_=new n(0),R=new n(1),{pixelRatio:O}=this.animationInfo,$=new U(R,_,_,_,R,_,x.multiply(O),v.multiply(O),R),P=new U(w,b.multiply(-1),_,b,w,_,0,0,R),T=r.multiply(c).multiply(O).multiply(4/3),M=P.multiply(T),S=this.animationInfo.toScreen.multiply(new A(t,1)),Ue=$.multiply(S).xy,Pe=M.multiply(new A(a,0)).xy;return Ue.add(Pe)}_clip(e,t){let i=super.clip(e,t);const o=Ai(this._getLocalTimeOrigin(e),new n(0));return ti.forceGlobalTimeOrigin||(i=i.add(gt([o,()=>new n(2)],[!0,()=>new n(0)]))),i}_getLocalTimeOrigin(e){return this.storage.getLocalTimeOrigin(e)}_toNdc(e){return this.animationInfo.toNdc.multiply(new A(e,1)).xy}_getEvalParams(e,t){const{globalTime:i,animationTextureSize:o,animationTexture:r}=this.animationInfo;return{globalTime:i,localTimeOrigin:this._getLocalTimeOrigin(e.id),animationTextureSize:o,animationTexture:r,pixelDimensions:t}}_getColor(e,t){return E(ce(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return X(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=X(this.mosaicInfo.texture,e),o=new n(.5).subtract(Gt(i)).multiply(t.distanceToPx).multiply(Li),r=Se(new n(.5).subtract(o),new n(0),new n(1)),a=t.color.multiply(r),l=t.outlineSize.multiply(.5),c=xt(o).subtract(l),d=Se(new n(.5).subtract(c),new n(0),new n(1)),p=t.outlineColor.multiply(d);return new n(1).subtract(p.a).multiply(a).add(p)}};function Me(s,e,t){const i=s.add(new y(e,0)),o=X(t.animationTexture,i.add(.5).divide(t.animationTextureSize)).xy;return s=s.add(o),_s({animationPointer:s,...t},z,null,r=>{const{out:a}=r;if(!a)throw new Error("out is null");return Os({...r,out:a})})}u([V(Be)],re.prototype,"mosaicInfo",void 0),u([V(ve)],re.prototype,"animationInfo",void 0),u([F(qt)],re.prototype,"visualVariableColor",void 0),u([F(jt)],re.prototype,"visualVariableOpacity",void 0),u([F(Wt)],re.prototype,"visualVariableSizeMinMaxValue",void 0),u([F(Kt)],re.prototype,"visualVariableSizeScaleStops",void 0),u([F(Xt)],re.prototype,"visualVariableSizeStops",void 0),u([F(Zt)],re.prototype,"visualVariableSizeUnitValue",void 0),u([F(Vt)],re.prototype,"visualVariableRotation",void 0);var ge;(function(s){s[s.transform=0]="transform",s[s.fromColor=1]="fromColor",s[s.toColor=2]="toColor",s[s.colorMix=3]="colorMix",s[s.toOpacity=4]="toOpacity",s[s.opacityMix=5]="opacityMix"})(ge||(ge={}));let Ge=class extends Ft{};u([g(5,y)],Ge.prototype,"offset",void 0),u([g(6,y)],Ge.prototype,"uv",void 0),u([g(7,z)],Ge.prototype,"sizing",void 0),u([g(8,n)],Ge.prototype,"angle",void 0);class qe extends Nt{}u([g(12,y)],qe.prototype,"offsetNextVertex1",void 0),u([g(13,y)],qe.prototype,"offsetNextVertex2",void 0),u([g(14,y)],qe.prototype,"textureUVNextVertex1",void 0),u([g(15,y)],qe.prototype,"textureUVNextVertex2",void 0);class lo extends no{}function fe(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}let Dt=class extends re{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],uv:["textureUVNextVertex1","textureUVNextVertex2"]}}_vertexPreamble(e){const{id:t,pos:i,offset:o,animationPointerAndBaseSizeAndReferenceSize:r,uv:a,sizing:l,angle:c}=e,d=r.xy,p=r.z,f=r.w,m=l.xy,h=l.z,x=H(e.bitset,le.bitset.isStroke),v=l.w,b=H(e.bitset,le.bitset.scaleSymbolsProportionally),w=this._getEvalParams(e,m),_=Me(d,ge.transform,w),R=gt([ce(H(e.bitset,le.bitset.isMapAligned),new n(1)),this.view.rotation.divide(180).multiply(Math.PI)],[!0,new n(0)]),O=new $s(ke(R),Le(R.multiply(-1)),Le(R),ke(R)).multiply(_.xy),$=_.z.subtract(R).subtract(c.multiply(ki)),P=_.w,T=H(e.bitset,le.bitset.isSDF),M=ht(this,t,new n(f)).divide(new n(f));return{baseSize:p,animationPointer:d,strokeWidth:h,isOutline:x,unscaledDistanceToPx:v,scaleSymbolsProportionally:b,isSDF:T,position:this._getScreenPosition({id:t,pos:i,offset:o,referenceSize:f,translation:O,rotation:$,scale:P,vvScale:M}),uv:a,evalParams:w,vvScale:M,scale:P}}vertex(e,t){const{position:i,animationPointer:o,evalParams:r,isOutline:a,unscaledDistanceToPx:l,vvScale:c,uv:d,strokeWidth:p,scaleSymbolsProportionally:f,scale:m,isSDF:h,baseSize:x}=this._vertexPreamble(e),v=this._toNdc(i);let b=Me(o,ge.fromColor,r);b=new z(b.rgb.multiply(b.a),b.a);let w=Me(o,ge.toColor,r);w=new z(w.rgb.multiply(w.a),w.a);let _=Me(o,ge.colorMix,r);_=new z(_.rgb.multiply(_.a),_.a);const R=Me(o,ge.toOpacity,r).a,O=Me(o,ge.opacityMix,r).a,$=Bi(this,e.id,b,Ri(wt(e.bitset,le.bitset.colorLocked),new At(a))),P=xe($,w,_),T=Ni(this,e.id),M=xe(T,R,O),S=P.multiply(M),Ue=this.clip(e.id,e.zoomRange),Pe=l.multiply(c);return{glPosition:new z(v,Ue,1),uv:d.divide(this.mosaicInfo.size),color:S.multiply(new n(1).subtract(a)),outlineColor:S.multiply(a),distanceToPx:Pe,strokeWidth:p.multiply(xe(new n(1),m,f)),isOutline:a,isSDF:h,...this.maybeRunHittest(e,t,{pos:e.pos,size:x,sizeCorrection:new n(1),isMapAligned:new n(1),vvRotationMat3:new U(1,0,0,0,1,0,0,0,1),placementMat3:new U(1,0,0,0,1,0,0,0,1),outlineSize:new n(1),distanceToPx:Pe,isSDF:h})}}fragment(e){let t=this._getColor(e.uv,{color:e.color,distanceToPx:e.distanceToPx,isSDF:e.isSDF,outlineColor:e.outlineColor,outlineSize:e.strokeWidth});return ti.spotlightAnimatedSymbols&&(t=t.add(new z(0,.3,0,.3))),this.getFragmentOutput(t,e)}hittest(e,t,i){return E(Ci(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_hittestSmallMarker(e,t,i){const{position:o,distance:r,smallSymbolDistance:a}=this.hittestRequest,l=r.subtract(a),{viewMat3:c,tileMat3:d}=this.view,p=c.multiply(d).multiply(new A(i.pos,1)).xy,f=i.size.multiply(.5);return Ii(p,o).subtract(f).add(l)}_hittestMarker(e,t,i){const o=this._vertexPreamble({...e}).position,r=this._vertexPreamble({...e,offset:t.offsetNextVertex1,uv:t.textureUVNextVertex1}).position,a=this._vertexPreamble({...e,offset:t.offsetNextVertex2,uv:t.textureUVNextVertex2}).position,l=this.hittestRequest.position,c=this.hittestRequest.distance,d=Yt(l,o,r,a);return E(ue(d,c),d,this._hittestSamples(o,r,a,e,t,i))}_hittestSamples(e,t,i,o,r,a){const{outlineSize:l,isSDF:c,distanceToPx:d}=a,p=this.hittestRequest.position,f=this.hittestRequest.distance,m=k(p.add(new y(ee(f),ee(f))),e,t,i),h=k(p.add(new y(0,ee(f))),e,t,i),x=k(p.add(new y(f,ee(f))),e,t,i),v=k(p.add(new y(ee(f),0)),e,t,i),b=k(p,e,t,i),w=k(p.add(new y(f,0)),e,t,i),_=k(p.add(new y(ee(f),f)),e,t,i),R=k(p.add(new y(0,f)),e,t,i),O=k(p.add(new y(f,f)),e,t,i),$=o.uv.divide(this.mosaicInfo.size),P=r.textureUVNextVertex1.divide(this.mosaicInfo.size),T=r.textureUVNextVertex2.divide(this.mosaicInfo.size),M={color:new z(1,1,1,1),outlineSize:l,outlineColor:new z(1,1,1,1),isSDF:c,distanceToPx:d};let S=new n(0);return S=S.add(B(m).multiply(this._getColor(fe(m,$,P,T),M).a)),S=S.add(B(h).multiply(this._getColor(fe(h,$,P,T),M).a)),S=S.add(B(x).multiply(this._getColor(fe(x,$,P,T),M).a)),S=S.add(B(v).multiply(this._getColor(fe(v,$,P,T),M).a)),S=S.add(B(b).multiply(this._getColor(fe(b,$,P,T),M).a)),S=S.add(B(w).multiply(this._getColor(fe(w,$,P,T),M).a)),S=S.add(B(_).multiply(this._getColor(fe(_,$,P,T),M).a)),S=S.add(B(R).multiply(this._getColor(fe(R,$,P,T),M).a)),S=S.add(B(O).multiply(this._getColor(fe(O,$,P,T),M).a)),K(S,new n(.05)).multiply(St(this.hittestRequest))}};u([C(0,I(Ge)),C(1,I(qe))],Dt.prototype,"vertex",null),u([C(0,I(lo))],Dt.prototype,"fragment",null);let j=class extends Xs{constructor(){super(...arguments),this.symbologyPlane=pe.FILL,this._input=null}},uo=class extends j{render(e,t){const{context:i,painter:o}=e,{target:r}=t,{freezeGlobalTime:a}=ti,l=0,c=o.textureManager.animationStore.getTexture(i,l),d=[2/e.state.size[0],0,0,0,-2/e.state.size[1],0,-1,1,1],p=Array.from(cs(ri(),d)),f=Array.from(ps(ri(),p,r.transforms.displayViewScreenMat3)),m=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,m.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey,!0),animationInfo:{globalTime:a===!1?e.time/1e3:a,animationTextureSize:[c.descriptor.width,c.descriptor.height],animationTexture:{unit:6,texture:c},toScreen:f,toNdc:d,mapRotation:e.state.rotation,pixelRatio:e.state.pixelRatio}},defines:{...L(e)},optionalAttributes:{zoomRange:!0},useComputeBuffer:!0}),o.setPipelineState({...G(e)}),o.submitDraw(e,t),a===!1&&r.requestRender()}},co=class extends uo{constructor(){super(...arguments),this.type=q.AnimatedMarker,this.symbologyPlane=pe.MARKER,this.shaders={geometry:new Dt}}},Ki=class extends Oi{};u([g(0,y)],Ki.prototype,"pos",void 0);let po=class extends $e{},Xi=class extends de{};u([V(n)],Xi.prototype,"dotSize",void 0);let rt=class extends de{};u([V(Q)],rt.prototype,"locations",void 0),u([V(n)],rt.prototype,"pixelRatio",void 0),u([V(n)],rt.prototype,"tileZoomFactor",void 0);const fo=1e-6;class Ae extends Fi{vertex(e){const t=new U(1,0,0,0,-1,0,0,1,1).multiply(new A(e.pos.xy.divide(J),1)),i=X(this.draw.locations,t.xy),o=we(this.instance.dotSize.divide(2),new n(1));let r=new n(0);r=r.add(K(i.a,new n(fo)).multiply(2));let a=o.add(this.instance.dotSize);const l=this.view.displayViewScreenMat3.multiply(new A(e.pos.add(.5),1)),c=new z(l.xy,r,1),d=this.instance.dotSize.divide(a),p=new n(-1).divide(o.divide(a));return a=a.multiply(this.draw.pixelRatio.multiply(this.draw.tileZoomFactor)),{glPosition:c,glPointSize:a,color:i,ratio:d,invEdgeRatio:p}}fragment(e){const t=Ut(e.glPointCoord.subtract(.5)).multiply(2),i=Di(new n(0),new n(1),e.invEdgeRatio.multiply(t.subtract(e.ratio)).add(1)),o=new Ht;return o.fragColor=e.color.multiply(i),o}}u([V(Xi)],Ae.prototype,"instance",void 0),u([V(rt)],Ae.prototype,"draw",void 0),u([V(Fs)],Ae.prototype,"view",void 0),u([C(0,I(Ki))],Ae.prototype,"vertex",null),u([C(0,I(po))],Ae.prototype,"fragment",null);let Zi=class extends Qe{};u([g(3,n)],Zi.prototype,"inverseArea",void 0);let at=class extends de{};u([V(ne.ofType(z,2))],at.prototype,"isActive",void 0),u([V(ne.ofType(z,8))],at.prototype,"colors",void 0),u([V(n)],at.prototype,"dotValue",void 0);let Re=class extends de{};u([V(Q)],Re.prototype,"dotTexture0",void 0),u([V(Q)],Re.prototype,"dotTexture1",void 0),u([V(n)],Re.prototype,"tileZoomFactor",void 0),u([V(n)],Re.prototype,"pixelRatio",void 0),u([V(n)],Re.prototype,"tileDotsOverArea",void 0);let Ce=class extends Je{_dotThreshold(e,t,i){return e.divide(t).divide(i)}vertex(e){const t=new U(2/J,0,0,0,-2/J,0,-1,1,1).multiply(new A(e.pos,1)),i=this.clip(e.id),o=new z(t.xy,i,1),r=this.storage.getVVData(e.id).multiply(this.instance.isActive.get(0)).multiply(e.inverseArea),a=this.storage.getDataDrivenData0(e.id).multiply(this.instance.isActive.get(1)).multiply(e.inverseArea),l=this.draw.tileZoomFactor.multiply(J).divide(this.draw.pixelRatio),c=this._dotThreshold(r,this.instance.dotValue,this.draw.tileDotsOverArea),d=this._dotThreshold(a,this.instance.dotValue,this.draw.tileDotsOverArea),p=e.pos.add(.5).divide(l);return{glPosition:o,color:new z(0,0,0,0),textureCoords:p,thresholds0:c,thresholds1:d}}fragment(e){const t=new Ht,i=X(this.draw.dotTexture0,e.textureCoords),o=X(this.draw.dotTexture1,e.textureCoords),r=e.thresholds0.subtract(i),a=e.thresholds1.subtract(o);let l;const c=mt.fromColumns(this.instance.colors[0],this.instance.colors[1],this.instance.colors[2],this.instance.colors[3]),d=mt.fromColumns(this.instance.colors[4],this.instance.colors[5],this.instance.colors[6],this.instance.colors[7]);if(this.blending){const p=K(new n(0),r),f=K(new n(0),a),m=Ze(p,r).add(Ze(f,a)),h=K(m,new n(0)),x=new n(1).subtract(h),v=m.add(h),b=r.multiply(p).divide(v),w=a.multiply(f).divide(v),_=c.multiply(b).add(d.multiply(w));l=x.multiply(_)}else{const p=we(mi(r),mi(a)),f=K(p,new n(0)),m=new n(1).subtract(f),h=K(p,r),x=K(p,a),v=c.multiply(h).add(d.multiply(x));l=m.multiply(v)}return t.fragColor=l,t}hittest(e){return St(this.hittestRequest)}};u([Ee],Ce.prototype,"blending",void 0),u([V(at)],Ce.prototype,"instance",void 0),u([V(Re)],Ce.prototype,"draw",void 0),u([C(0,I(Zi))],Ce.prototype,"vertex",null),u([C(0,I($e))],Ce.prototype,"fragment",null);const mo={pos:{count:2,type:ae.UNSIGNED_SHORT}};let ho=class{constructor(){this._dotTextureSize=0,this._dotTextures=null,this._dotMesh=null}destroy(){this._disposeTextures(),this._dotFBO&&this._dotFBO.dispose(),this._dotMesh&&this._dotMesh.destroy()}getFBO(e){if(this._dotFBO==null){const t=J,i=J,o=new dt(t,i);o.samplingMode=_e.NEAREST,o.wrapMode=Tt.CLAMP_TO_EDGE;const r=new Zs(e,new ji($i.DEPTH_STENCIL,t,i));this._dotFBO=new Wi(e,o,r)}return this._dotFBO}getDotDensityMesh(e){if(this._dotMesh==null){const t=J,i=t*t,o=2,r=new Int16Array(i*o);for(let a=0;a<t;a++)for(let l=0;l<t;l++)r[o*(l+a*t)]=l,r[o*(l+a*t)+1]=a;this._dotMesh=ao.create(e,{primitive:_i.POINTS,vertex:r,count:i,layout:mo})}return this._dotMesh}getDotDensityTextures(e,t,i){if(this._dotTextureSize===t&&this._seed===i||(this._disposeTextures(),this._dotTextureSize=t,this._seed=i),this._dotTextures===null){const o=new ds(i);this._dotTextures=[this._allocDotDensityTexture(e,t,o),this._allocDotDensityTexture(e,t,o)]}return this._dotTextures}_disposeTextures(){if(this._dotTextures){for(let e=0;e<this._dotTextures.length;e++)this._dotTextures[e].dispose();this._dotTextures=null}}_allocDotDensityTexture(e,t,i){const o=new Float32Array(t*t*4);for(let a=0;a<o.length;a++)o[a]=i.getFloat();const r=new dt;return r.dataType=Xe.FLOAT,r.samplingMode=_e.NEAREST,r.width=t,r.height=t,new Pi(e,r,o)}},yo=class extends j{constructor(){super(...arguments),this.type=q.DotDensity,this.shaders={polygon:new Ce,point:new Ae,fill:new Qt},this._resources=new Map}render(e,t){Mi(e)||D(e)?this._renderPolygons(e,t):this._renderDotDensity(e,t)}_renderPolygons(e,t){const{painter:i}=e;i.setShader({shader:this.shaders.fill,uniforms:{...N(e,t.target),visualVariableColor:null,visualVariableOpacity:null},defines:{...L(e)},optionalAttributes:{zoomRange:!1},useComputeBuffer:D(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}_renderDotDensity(e,t){const{context:i,painter:o,requiredLevel:r}=e,a=t.instance.getInput().uniforms,l=this._getOrCreateResourcesRecord(i),c=l.getDotDensityTextures(i,J,a.seed),d=1/2**(r-t.target.key.level),p=J,f=p*window.devicePixelRatio*p*window.devicePixelRatio,m=1/d*(1/d),h=a.dotScale?e.state.scale/a.dotScale:1,x=a.dotValue*h*m;o.setShader({shader:this.shaders.polygon,uniforms:{...N(e,t.target),instance:{isActive:a.isActive,colors:a.colors,dotValue:Math.max(1,x)},draw:{dotTexture0:{unit:ai,texture:c[0]},dotTexture1:{unit:fs,texture:c[1]},tileZoomFactor:d,pixelRatio:window.devicePixelRatio,tileDotsOverArea:f/(J*window.devicePixelRatio*J*window.devicePixelRatio)}},defines:{...L(e),blending:a.blending},optionalAttributes:{},useComputeBuffer:!1});const v=i.getViewport();i.setViewport(0,0,J,J);const b=i.getBoundFramebufferObject(),w=l.getFBO(i);i.bindFramebuffer(w),i.setClearColor(0,0,0,0),i.clear(ft.COLOR),o.setPipelineState({color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1}),o.updatePipelineState(i),o.submitDraw(e,t),i.bindFramebuffer(b),i.setViewport(v.x,v.y,v.width,v.height);const _=l.getFBO(i).colorTexture,R={shader:this.shaders.point,uniforms:{view:ms(e,t.target),instance:{dotSize:a.dotSize},draw:{locations:{unit:ai,texture:_},tileZoomFactor:1,pixelRatio:window.devicePixelRatio}},defines:{...L(e)},optionalAttributes:{},useComputeBuffer:!1};o.setPipelineState(G(e)),o.submitDrawMesh(i,R,l.getDotDensityMesh(i))}shutdown(e){var t;super.shutdown(e),(t=this._resources.get(e))==null||t.destroy(),this._resources.delete(e)}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new ho,this._resources.set(e,t)),t}},vo=class extends j{constructor(){super(...arguments),this.type=q.ComplexFill,this.shaders={geometry:new Ds}}render(e,t){const{context:i,painter:o}=e,r=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}};function Ne(s){const e=1/s;return{antialiasing:e,blur:0+e}}let bo=class extends j{constructor(){super(...arguments),this.type=q.ComplexOutlineFill,this.shaders={geometry:new Es}}render(e,t){const{context:i,painter:o,pixelRatio:r}=e,a=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,a.uniforms),...N(e,t.target),antialiasingControls:Ne(r),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...L(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}},go=class extends j{constructor(){super(...arguments),this.type=q.Fill,this.shaders={geometry:new Qt}}render(e,t){const{painter:i}=e,o=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,o.uniforms),...N(e,t.target)},defines:L(e),optionalAttributes:o.optionalAttributes,useComputeBuffer:D(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};class je extends Ls{}u([g(5,z)],je.prototype,"tlbr",void 0),u([g(6,y)],je.prototype,"relativePosition",void 0),u([g(7,n)],je.prototype,"gradientMethod",void 0),u([g(8,y)],je.prototype,"relativeGradientSize",void 0);class xo extends $e{}class nt extends Qt{vertex(e,t){const{tlbr:i,relativePosition:o,gradientMethod:r,relativeGradientSize:a}=e,l=E(wt(e.bitset,yi.isAbsolute),this.view.displayZoomFactor,new n(1));return{...super.vertex(e,t),tlbr:i,relativePosition:o,gradientMethod:r,gradientSize:a.multiply(l),isDiscrete:H(e.bitset,yi.isDiscrete)}}fragment(e){const{tlbr:t,relativePosition:i,gradientMethod:o,gradientSize:r,isDiscrete:a}=e,l=E(ue(a,new n(.5)),r.subtract(1),new y(0)),c=gt([ce(o,new n(hi.rectangular)),()=>{const h=xt(i).add(l).divide(r);return ot(we(h.x,h.y))}],[ce(o,new n(hi.circular)),ot(Ei(Ze(i,i)).add(l.x).divide(r.x))],[!0,ot(i.x.add(l.x).divide(r.x))]),d=new y(Se(c,new n(0),new n(1)),.5),p=xe(t.xy,t.zw,d).divide(this.mosaicInfo.size),f=X(this.mosaicInfo.texture,p),m=e.color.a;return this.getFragmentOutput(f.multiply(m),e,new n(0))}}u([V(Be)],nt.prototype,"mosaicInfo",void 0),u([C(0,I(je)),C(1,I(Jt))],nt.prototype,"vertex",null),u([C(0,I(xo))],nt.prototype,"fragment",null);let wo=class extends j{constructor(){super(...arguments),this.type=q.GradientFill,this.shaders={geometry:new nt},this.symbologyPlane=pe.FILL}render(e,t){const{context:i,painter:o}=e,r=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}},So=class extends j{constructor(){super(...arguments),this.type=q.OutlineFill,this.shaders={geometry:new ks}}render(e,t){const{painter:i,pixelRatio:o}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),antialiasingControls:Ne(o)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}},Vo=class extends j{constructor(){super(...arguments),this.type=q.PatternFill,this.shaders={geometry:new Bs}}render(e,t){const{context:i,painter:o}=e,r=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}},zo=class extends j{constructor(){super(...arguments),this.type=q.PatternOutlineFill,this.shaders={geometry:new Ns}}render(e,t){const{context:i,painter:o,pixelRatio:r}=e,a=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,a.uniforms),...N(e,t.target),antialiasingControls:Ne(r),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey),localTileOffset:vt(t.target)},defines:{...L(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}},Et=class{constructor(e,t,i,o){this.dataType=e,this.samplingMode=t,this.pixelFormat=i,this.internalFormat=o}};function _o(s,e){const{textureFloatLinear:t,colorBufferFloat:i}=s.capabilities,o=i==null?void 0:i.textureFloat,r=i==null?void 0:i.textureHalfFloat,a=i==null?void 0:i.floatBlend,l=s.driverTest.floatBufferBlend.result;if(!o&&!r)throw new st("heatmap:missing-color-buffer-float","HeatmapRenderer requires the WebGL extension EXT_color_buffer_float or EXT_color_buffer_half_float or WEBGL_color_buffer_float.");if(!(a&&l||r))throw new st("heatmap:missing-float-blend","HeatmapRenderer requires the WebGL extension EXT_float_blend or EXT_color_buffer_half_float."+(l?"":" This device claims support for EXT_float_blend, but does not actually support it."));const c=o&&a&&l,d=r,p=t,f=!!(i!=null&&i.R32F),m=!!(i!=null&&i.R16F);if(c&&p)return p||e.warnOnce("Missing WebGL extension OES_texture_float_linear. Heatmap quality may be reduced."),new Et(Xe.FLOAT,p?_e.LINEAR:_e.NEAREST,f?be.RED:be.RGBA,f?ni.R32F:be.RGBA);if(d)return new Et(Xe.HALF_FLOAT,_e.LINEAR,m?be.RED:be.RGBA,m?ni.R16F:be.RGBA);throw new st("heatmap:missing-hardware-support","HeatmapRenderer requires WebGL extensions that allow it to render and blend to float or half float textures.")}new Et(Xe.HALF_FLOAT,_e.NEAREST,be.RGBA,be.RGBA);const $o=()=>Ti.getLogger("esri.views.2d.engine.webgl.shaderGraph.techniques.heatmap.HeatmapResources");let Po=class{destroy(){this._accumulateFramebuffer=li(this._accumulateFramebuffer),this._resolveGradientTexture=li(this._resolveGradientTexture),this._prevGradientHash=null,this._qualityProfile=null}get initialized(){return this._accumulateFramebuffer!=null&&this._resolveGradientTexture!=null}get accumulateFramebuffer(){return this._accumulateFramebuffer}get resolveGradientTexture(){return this._resolveGradientTexture}loadQualityProfile(e){if(this._qualityProfile==null){const t=_o(e,$o());this._qualityProfile={...t,defines:{usesHalfFloatPrecision:t.dataType!==Xe.FLOAT}}}return this._qualityProfile}ensureAccumulateFBO(e,t,i){if(this._accumulateFramebuffer==null){const{dataType:o,samplingMode:r,pixelFormat:a,internalFormat:l}=this.loadQualityProfile(e),c=new dt(t,i);c.pixelFormat=a,c.internalFormat=l,c.dataType=o,c.samplingMode=r,c.wrapMode=Tt.CLAMP_TO_EDGE;const d=new ji($i.DEPTH_STENCIL,t,i);this._accumulateFramebuffer=new Wi(e,c,d)}else{const{width:o,height:r}=this._accumulateFramebuffer;o===t&&r===i||this._accumulateFramebuffer.resize(t,i)}return this._accumulateFramebuffer}ensureResolveGradientTexture(e,t,i){if(this._resolveGradientTexture==null){const o=new dt;o.wrapMode=Tt.CLAMP_TO_EDGE,this._resolveGradientTexture=new Pi(e,o),this._prevGradientHash=null}return this._prevGradientHash!==t&&(this._resolveGradientTexture.resize(i.length/4,1),this._resolveGradientTexture.setData(i),this._prevGradientHash=t),this._resolveGradientTexture}};function Yi(s){return s?.25:1}let Qi=class extends Qe{};u([g(5,y)],Qi.prototype,"offset",void 0);let Mo=class extends $e{},Lt=class extends de{};u([V(n)],Lt.prototype,"radius",void 0),u([V(n)],Lt.prototype,"isFieldActive",void 0);let We=class extends Je{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){const{radius:t,isFieldActive:i}=this.kernelControls,o=e.offset,r=i.multiply(this.storage.getVVData(e.id).x).add(new n(1).subtract(i)),a=this.view.displayViewScreenMat3.multiply(new A(e.pos,1)).add(this.view.displayViewMat3.multiply(new A(o,0)).multiply(t)),l=this.clip(e.id);return{glPosition:new z(a.xy,l,1),offset:o,fieldValue:r,color:new z(0),...this.maybeRunHittest(e,{},null)}}fragment(e){const{offset:t,fieldValue:i}=e,o=Ut(t),r=K(o,new n(1)),a=new n(1).subtract(o.multiply(o)),l=a.multiply(a),c=r.multiply(l).multiply(i).multiply(new n(Yi(this.usesHalfFloatPrecision)));return this.getFragmentOutput(new z(c),e)}hittest(e){const{viewMat3:t,tileMat3:i}=this.view,o=t.multiply(i).multiply(new A(e.pos,1));return Us(o.xy,this.kernelControls.radius,this.hittestRequest.position)}};u([Ee],We.prototype,"usesHalfFloatPrecision",void 0),u([V(Lt)],We.prototype,"kernelControls",void 0),u([C(0,I(Qi))],We.prototype,"vertex",null),u([C(0,I(Mo))],We.prototype,"fragment",null);let Ji=class extends Oi{};u([g(0,y)],Ji.prototype,"position",void 0);let To=class extends Ps{},lt=class extends de{};u([V(Q)],lt.prototype,"texture",void 0),u([V(y)],lt.prototype,"minAndInvRange",void 0),u([V(n)],lt.prototype,"normalization",void 0);let es=class extends de{};u([V(Q)],es.prototype,"texture",void 0);let Ie=class extends Fi{constructor(){super(...arguments),this.usesHalfFloatPrecision=!1}vertex(e){return{glPosition:new z(e.position.multiply(2).subtract(1),1,1),uv:e.position}}fragment(e){const{accumulatedDensity:t,gradient:i}=this;let o=X(t.texture,e.uv).r.divide(new n(Yi(this.usesHalfFloatPrecision)));o=o.multiply(t.normalization),o=o.subtract(t.minAndInvRange.x).multiply(t.minAndInvRange.y);const r=X(i.texture,new y(o,.5)),a=new Ht;return a.fragColor=new z(r.rgb.multiply(r.a),r.a),a}};u([Ee],Ie.prototype,"usesHalfFloatPrecision",void 0),u([V(lt)],Ie.prototype,"accumulatedDensity",void 0),u([V(es)],Ie.prototype,"gradient",void 0),u([C(0,I(Ji))],Ie.prototype,"vertex",null),u([C(0,I(To))],Ie.prototype,"fragment",null);let Ao=class extends j{constructor(){super(...arguments),this.type=q.Heatmap,this.drawPhase=De.MAP|De.HITTEST|De.DEBUG,this.shaders={accumulate:new We,resolve:new Ie},this._isBound=!1,this._resources=new Map}shutdown(e){var t;super.shutdown(e),(t=this._resources.get(e))==null||t.destroy(),this._resources.delete(e),this._prevFBO=null,this._unbind()}render(e,t){const{context:i,painter:o,state:r}=e,a=t.instance.getInput(),{isFieldActive:l}=a.uniforms,c=this._getOrCreateResourcesRecord(i),d=c.loadQualityProfile(i);D(e)||this._bind(e,c,a),o.setShader({shader:this.shaders.accumulate,uniforms:{...N(e,t.target),kernelControls:{radius:wi(a,r),isFieldActive:l?1:0}},defines:{...L(e),...d.defines},optionalAttributes:{},useComputeBuffer:D(e)});const p=D(e)?Co:is;o.setPipelineState(p),o.submitDraw(e,t)}getStencilReference(e){return ts(e)}renderResolvePass(e,t){if(D(e))return;const{context:i,painter:o}=e,r=this._resources.get(i);if(this._prevFBO==null||this._prevViewport==null||!(r!=null&&r.initialized))return;const{defines:a}=r.loadQualityProfile(i),{minDensity:l,maxDensity:c,radius:d}=t.getInput().uniforms,p=8,f=9,m=r.accumulateFramebuffer,h=r.resolveGradientTexture,x={shader:this.shaders.resolve,uniforms:{accumulatedDensity:{texture:{unit:p,texture:m.colorTexture},minAndInvRange:[l,1/(c-l)],normalization:3/(d*d*Math.PI)},gradient:{texture:{unit:f,texture:h}}},defines:a,optionalAttributes:{},useComputeBuffer:!1};i.bindFramebuffer(this._prevFBO),i.setViewport(0,0,this._prevViewport.width,this._prevViewport.height),i.bindTexture(m.colorTexture,p),i.bindTexture(h,f),o.setPipelineState(Io),o.submitDrawMesh(i,x,o.quadMesh),this._unbind()}_getOrCreateResourcesRecord(e){let t=this._resources.get(e);return t==null&&(t=new Po,this._resources.set(e,t)),t}_unbind(){this._prevFBO=null,this._prevViewport=null,this._isBound=!1}_bind(e,t,i){if(this._isBound)return;const{context:o,state:r,pixelRatio:a}=e,l=o.getBoundFramebufferObject(),c=o.getViewport();this._prevFBO=l,this._prevViewport=c;const{gradient:d,gradientHash:p}=i.uniforms;t.ensureResolveGradientTexture(o,p,d);const{width:f,height:m}=c,h=Ro(wi(i,r),a),x=f*h,v=m*h,b=t.ensureAccumulateFBO(o,x,v);o.blitFramebuffer(l,b,0,0,l.width,l.height,0,0,b.width,b.height,ft.STENCIL,_e.NEAREST),o.bindFramebuffer(b),o.setViewport(0,0,b.width,b.height),o.setColorMask(!0,!0,!0,!0),o.setClearColor(0,0,0,0),o.clear(ft.COLOR),this._isBound=!0}};function Ro(s,e){const t=e>1.5?.25:.5;return s<1/(2*t)?1:t}function ts(s){return s.key.level+1}const is={color:{write:[!0,!0,!0,!0],blendMode:"additive"},depth:!1,stencil:{write:!1,test:{ref:ts,compare:He.GEQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.REPLACE}}}},Co={...is,stencil:!1},Io={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:!1,stencil:!1};function wi(s,e){const{referenceScale:t,radius:i}=s.uniforms;return i*(t!==0?t/e.scale:1)}const Oo=360/254;var Y;(function(s){s[s.Color=0]="Color",s[s.Outline=1]="Outline",s[s.Halo=2]="Halo"})(Y||(Y={}));let ie=class extends Qe{};u([g(3,z)],ie.prototype,"color",void 0),u([g(4,y)],ie.prototype,"offset",void 0),u([g(5,y)],ie.prototype,"textureUV",void 0),u([g(6,n)],ie.prototype,"fontSize",void 0),u([g(7,n)],ie.prototype,"referenceSize",void 0),u([g(8,z)],ie.prototype,"outlineColor",void 0),u([g(9,z)],ie.prototype,"haloColor",void 0),u([g(10,y)],ie.prototype,"outlineAndHaloSize",void 0),u([g(11,y)],ie.prototype,"zoomRange",void 0),u([g(12,n)],ie.prototype,"clipAngle",void 0),u([g(13,z)],ie.prototype,"referenceSymbol",void 0);let kt=class extends Nt{};u([g(14,y)],kt.prototype,"offsetNextVertex1",void 0),u([g(15,y)],kt.prototype,"offsetNextVertex2",void 0);let Fo=class extends $e{},W=class extends Je{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"]},this.textRenderPassType=Y.Color,this.isBackgroundPass=!1,this.isLabel=!1}clipLabel(e,t,i){const o=t.multiply(Oo),r=xt(this.view.rotation.subtract(o)),a=Rt(new n(360).subtract(r),r);let l=new n(0);const c=Ms(this.view.currentZoom.multiply(ui)).divide(ui),d=e.x,p=e.y,f=new n(1).subtract(K(d,c)).multiply(2),m=K(new n(90),a).multiply(2),h=new n(2).multiply(new n(1).subtract(K(c,p)));return l=l.add(i.multiply(f)),l=l.add(i.multiply(m)),l=l.add(h),l}vertex(e,t){const i=H(e.bitset,Hs),o=new n(1).subtract(i);let r=e.fontSize,a=r.divide(vi);const l=this.textRenderPassType===Y.Outline?e.outlineColor:this.textRenderPassType===Y.Halo?e.haloColor:this._getVertexColor(e),c=this.isLabel?this.storage.getLabelVisibility(e.id):new n(1),d=this.isLabel?l.multiply(c):l,p=this.view.displayViewScreenMat3.multiply(new A(e.pos,1));let f=e.offset,m=new n(1),h=U.identity(),x=new y(0);if(this.isLabel){if(!e.referenceSymbol)throw new Error("InternalError: Optional attribute 'referenceSymbol' expected for labels");const O=e.referenceSymbol,$=O.xy,P=O.z,T=this._unpackDirection(O.w),M=ht(this,e.id,P).divide(2),S=T.multiply(M.add(hs));x=$.add(S),f=f.add(x)}else m=ht(this,e.id,e.referenceSize).divide(e.referenceSize),r=r.multiply(m),a=a.multiply(m),f=f.multiply(m),h=Ui(this,e.id),f=h.multiply(new A(f,0)).xy;const v=H(e.bitset,Gs),b=this._getViewRotationMatrix(v).multiply(new A(f,0));let w=this.isLabel?this.clipLabel(e.zoomRange,e.clipAngle,v):this.clip(e.id,e.zoomRange);w=this.isBackgroundPass?w.add(o.multiply(2)):w.add(i.multiply(2));let _=new n(0);if(this.textRenderPassType===Y.Outline&&(w=w.add(E(ce(e.outlineAndHaloSize.x,new n(0)),new n(2),new n(0))),_=new n(e.outlineAndHaloSize.x).divide(a).divide(bi)),this.textRenderPassType===Y.Halo){const O=e.outlineAndHaloSize.x,$=new n(e.outlineAndHaloSize.y);w=w.add(E(ce($,new n(0)),new n(2),new n(0))),_=$.add(O).divide(a).divide(bi)}const R=this.isLabel?Ri(ue(w,new n(1)),Ai(c,new n(0))):new At(!1);return{glPosition:new z(p.xy.add(b.xy),w,1),color:d,size:a,textureUV:e.textureUV.divide(this.mosaicInfo.size),antialiasingWidth:new n(.105*vi).divide(r).divide(this.view.pixelRatio),outlineDistanceOffset:_,...this.maybeRunHittest(e,t,{vvSizeAdjustment:m,vvRotation:h,labelOffset:x,labelClipped:R})}}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,o=new n(1).subtract(e);return t.multiply(e).add(i.multiply(o))}fragment(e){const t=new n(.25),i=new n(1).subtract(t),o=X(this.mosaicInfo.texture,e.textureUV).a;let r=i.subtract(e.outlineDistanceOffset);this.highlight&&(r=r.divide(2));const a=e.antialiasingWidth,l=Di(r.subtract(a),r.add(a),o);return this.getFragmentOutput(e.color.multiply(l),e)}hittest(e,t,{vvSizeAdjustment:i,vvRotation:o,labelOffset:r,labelClipped:a}){let l,c,d;this.isLabel?(l=new A(e.offset.add(r),0),c=new A(t.offsetNextVertex1.add(r),0),d=new A(t.offsetNextVertex2.add(r),0)):(l=o.multiply(new A(e.offset.multiply(i),0)),c=o.multiply(new A(t.offsetNextVertex1.multiply(i),0)),d=o.multiply(new A(t.offsetNextVertex2.multiply(i),0)));const{viewMat3:p,tileMat3:f}=this.view,m=p.multiply(f).multiply(new A(e.pos,1)),h=m.add(f.multiply(l)).xy,x=m.add(f.multiply(c)).xy,v=m.add(f.multiply(d)).xy,b=Yt(this.hittestRequest.position,h.xy,x.xy,v.xy);return this.isLabel?E(a,St(this.hittestRequest),b):b}_unpackDirection(e){const t=new _t(e),i=Ts(t,new _t(2)),o=As(t,new _t(3));return new y(new n(i).subtract(1),new n(o).subtract(1))}_getVertexColor(e){let t=e.color;if(this.visualVariableColor){const i=this.storage.getColorValue(e.id);t=this.visualVariableColor.getColor(i,e.color,new At(!1))}if(this.visualVariableOpacity){const i=this.storage.getOpacityValue(e.id),o=this.visualVariableOpacity.getOpacity(i);t=t.multiply(o)}return t}};u([F(qt)],W.prototype,"visualVariableColor",void 0),u([F(jt)],W.prototype,"visualVariableOpacity",void 0),u([F(Vt)],W.prototype,"visualVariableRotation",void 0),u([F(Wt)],W.prototype,"visualVariableSizeMinMaxValue",void 0),u([F(Kt)],W.prototype,"visualVariableSizeScaleStops",void 0),u([F(Xt)],W.prototype,"visualVariableSizeStops",void 0),u([F(Zt)],W.prototype,"visualVariableSizeUnitValue",void 0),u([V(Be)],W.prototype,"mosaicInfo",void 0),u([Ee],W.prototype,"textRenderPassType",void 0),u([Ee],W.prototype,"isBackgroundPass",void 0),u([Ee],W.prototype,"isLabel",void 0),u([C(0,I(ie)),C(1,I(kt))],W.prototype,"vertex",null),u([C(0,I(Fo))],W.prototype,"fragment",null);let Do=class extends j{constructor(){super(...arguments),this.type=q.Label,this.shaders={geometry:new W},this.drawPhase=De.LABEL|De.LABEL_ALPHA|De.HITTEST,this.symbologyPlane=pe.TEXT}render(e,t){const{context:i,painter:o}=e,r=L(e),a={...G(e)},l=t.instance.getInput(),c={shader:this.shaders.geometry,uniforms:{...Z(e,t.target,l.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...r,textRenderPassType:Y.Color,isBackgroundPass:!0,isLabel:!0},optionalAttributes:l.optionalAttributes,useComputeBuffer:D(e)};o.setPipelineState(a),o.setShader(c),o.submitDraw(e,t),o.setShader({...c,defines:{...r,textRenderPassType:Y.Halo,isBackgroundPass:!1,isLabel:!0}}),o.submitDraw(e,t),o.setShader({...c,defines:{...r,textRenderPassType:Y.Color,isBackgroundPass:!1,isLabel:!0}}),o.submitDraw(e,t)}},Oe=class extends Hi{};u([g(9,n)],Oe.prototype,"accumulatedDistance",void 0),u([g(10,n)],Oe.prototype,"totalLength",void 0),u([g(11,n)],Oe.prototype,"gradientSize",void 0),u([g(12,y)],Oe.prototype,"segmentDirection",void 0),u([g(13,z)],Oe.prototype,"tlbr",void 0);let ss=class extends de{};u([V(n)],ss.prototype,"isColorPass",void 0);let ut=class extends ei{vertex(e,t){const{totalLength:i,gradientSize:o,segmentDirection:r,tlbr:a}=e,l=Gi(this,e),c=H(e.bitset,tt.isAlongLine),d=i.divide(this.view.displayZoomFactor),p=E(wt(e.bitset,tt.isAbsoluteSize),()=>{const h=E(ue(c,new n(.5)),d,l.halfWidth);return o.divide(h)},o),f=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Ze(r,l.scaledOffset)).divide(d),m=a.divide(this.mosaicInfo.size.xyxy);return{...l,tlbr:m,relativePositionAlongLine:f,relativeGradientSize:p,isAlongLine:H(e.bitset,tt.isAlongLine),isDiscrete:H(e.bitset,tt.isDiscrete),...this.maybeRunHittest(e,t,l.halfWidth)}}fragment(e){const{isAlongLine:t,isDiscrete:i,relativePositionAlongLine:o,relativeGradientSize:r,normal:a,tlbr:l}=e,c=qi(e,this.antialiasingControls.blur),d=new n(.5).multiply(a.y).add(new n(.5)),p=E(ue(t,new n(.5)),o,d),f=E(ue(i,new n(.5)),r.subtract(1),new n(0)),m=ot(p.add(f).divide(r)),h=xe(l.xy,l.zw,new y(Se(m,new n(0),new n(1)),.5)),x=X(this.mosaicInfo.texture,h),v=e.opacity.multiply(c),b=this.getFragmentOutput(x.multiply(v),e),w=K(new n(.5),this.technique.isColorPass).multiply(Ve("gradient-depth-epsilon")),_=K(new n(0),a.y).multiply(new n(Ve("gradient-depth-bias")).subtract(w));return b.glFragDepth=Se(Ut(a).add(_),new n(0),new n(1)),b}};u([V(Be)],ut.prototype,"mosaicInfo",void 0),u([V(ss)],ut.prototype,"technique",void 0),u([C(0,I(Oe)),C(1,I(Jt))],ut.prototype,"vertex",null);let Eo=class extends j{constructor(){super(...arguments),this.type=q.GradientStroke,this.shaders={geometry:new ut},this.symbologyPlane=pe.LINE}_getShaderOptions(e,t,i){const{context:o,painter:r,pixelRatio:a}=e,l=t.instance.getInput();return{shader:this.shaders.geometry,uniforms:{...Z(e,t.target,l.uniforms),...N(e,t.target),antialiasingControls:Ne(a),mosaicInfo:r.textureManager.getMosaicInfo(o,t.textureKey),technique:{isColorPass:i}},defines:{...L(e)},optionalAttributes:l.optionalAttributes,useComputeBuffer:D(e)}}render(e,t){const{painter:i}=e;if(D(e)||Mi(e)){const a=G(e);return i.setPipelineState(a),i.setShader(this._getShaderOptions(e,t,1)),void i.submitDraw(e,t)}e.context.setClearDepth(1),e.context.clear(ft.DEPTH);const o={color:!1,depth:{write:{zNear:0,zFar:1},test:He.LESS},stencil:{write:!1,test:{ref:a=>a.stencilRef,compare:He.EQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.KEEP}}}};i.setShader(this._getShaderOptions(e,t,0)),i.setPipelineState(o),i.submitDraw(e,t);const r={color:{write:[!0,!0,!0,!0],blendMode:"composite"},depth:{write:!1,test:He.LEQUAL},stencil:{write:!1,test:{ref:a=>a.stencilRef,compare:He.EQUAL,mask:255,op:{fail:ye.KEEP,zFail:ye.KEEP,zPass:ye.KEEP}}}};i.setShader(this._getShaderOptions(e,t,1)),i.setPipelineState(r),i.submitDraw(e,t)}},Lo=class extends j{constructor(){super(...arguments),this.type=q.Line,this.shaders={geometry:new ei},this.symbologyPlane=pe.LINE}render(e,t){const{painter:i,pixelRatio:o}=e,r=t.instance.getInput();i.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),antialiasingControls:Ne(o)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),i.setPipelineState(G(e)),i.submitDraw(e,t)}};class Fe extends Hi{}u([g(9,n)],Fe.prototype,"accumulatedDistance",void 0),u([g(10,y)],Fe.prototype,"segmentDirection",void 0),u([g(11,n)],Fe.prototype,"offsetAlongLine",void 0),u([g(12,n)],Fe.prototype,"capType",void 0),u([g(13,z)],Fe.prototype,"tlbr",void 0);class Bt extends ei{_getDistanceRatio(e,t){const i=H(e.bitset,qs);return i.multiply(we(t,new n(.25)).multiply(new n(2))).add(new n(1).subtract(i).multiply(ze(1)))}_getSDFAlpha(e){const{halfWidth:t,normal:i,tlbr:o,patternSize:r,accumulatedDistance:a,offsetAlongLine:l,dashToPx:c,capType:d}=e,p=r.x.divide(Js).multiply(c),f=pi(a.add(l).divide(p)),m=xe(o.xy,o.zw,new y(f,.5)),h=Gt(X(this.mosaicInfo.texture,m)).multiply(2).subtract(1).multiply(eo).multiply(c),x=i.y.multiply(t),v=gt([ce(d,new n(1)),h.subtract(t)],[ce(d,new n(2)),Ei(Rs(we(h,new n(0)),new n(2)).add(x.multiply(x))).subtract(t)],[!0,h]),b=Se(new n(.25).subtract(v),new n(0),new n(1));return new z(b)}_getPatternColor(e){const{halfWidth:t,normal:i,color:o,accumulatedDistance:r,patternSize:a,sampleAlphaOnly:l,tlbr:c}=e,d=a.y.multiply(new n(2).multiply(t).divide(a.x)),p=pi(r.divide(d)),f=new n(.5).multiply(i.y).add(new n(.5)),m=xe(c.xy,c.zw,new y(f,p));let h=X(this.mosaicInfo.texture,m);return this.visualVariableColor!=null&&(h=E(ue(l,new n(.5)),new z(o.a),o)),h}vertex(e,t){const{segmentDirection:i,tlbr:o,bitset:r}=e,a=Gi(this,e),l=e.accumulatedDistance.divide(this.view.displayZoomFactor).add(Ze(i,a.scaledOffset)),c=new y(o.z.subtract(o.x),o.w.subtract(o.y)),d=o.divide(this.mosaicInfo.size.xyxy),p=H(r,js),f=H(r,Ws),m=E(ue(p,new n(.5)),this._getDistanceRatio(e,a.scaledHalfWidth),new n(1));return{...a,tlbr:d,patternSize:c,accumulatedDistance:l,isSDF:p,sampleAlphaOnly:f,dashToPx:m,offsetAlongLine:e.offsetAlongLine,capType:e.capType,...this.maybeRunHittest(e,t,a.halfWidth)}}fragment(e){const{color:t,opacity:i,isSDF:o}=e,r=qi(e,this.antialiasingControls.blur),a=E(ue(o,new n(.5)),this._getSDFAlpha(e),this._getPatternColor(e)),l=t.multiply(i).multiply(r).multiply(a);return this.getFragmentOutput(l,e)}}u([V(Be)],Bt.prototype,"mosaicInfo",void 0),u([C(0,I(Fe)),C(1,I(Jt))],Bt.prototype,"vertex",null);let ko=class extends j{constructor(){super(...arguments),this.type=q.TexturedLine,this.shaders={geometry:new Bt},this.symbologyPlane=pe.LINE}render(e,t){const{context:i,painter:o,pixelRatio:r}=e,a=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,a.uniforms),...N(e,t.target),antialiasingControls:Ne(r),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...L(e)},optionalAttributes:a.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}};class he extends Qe{}u([g(3,z)],he.prototype,"color",void 0),u([g(4,z)],he.prototype,"outlineColor",void 0),u([g(5,y)],he.prototype,"offset",void 0),u([g(6,y)],he.prototype,"textureUV",void 0),u([g(7,z)],he.prototype,"sizing",void 0),u([g(8,n)],he.prototype,"placementAngle",void 0),u([g(9,n)],he.prototype,"sdfDecodeCoeff",void 0),u([g(10,y)],he.prototype,"zoomRange",void 0);class Ke extends Nt{}u([g(12,y)],Ke.prototype,"offsetNextVertex1",void 0),u([g(13,y)],Ke.prototype,"offsetNextVertex2",void 0),u([g(14,y)],Ke.prototype,"textureUVNextVertex1",void 0),u([g(15,y)],Ke.prototype,"textureUVNextVertex2",void 0);class Bo extends $e{}function me(s,e,t,i){return e.multiply(s.x).add(t.multiply(s.y)).add(i.multiply(s.z))}function Pt(s){return s.multiply(s).divide(128)}class oe extends Je{constructor(){super(...arguments),this.computeAttributes={offset:["offsetNextVertex1","offsetNextVertex2"],textureUV:["textureUVNextVertex1","textureUVNextVertex2"]}}vertex(e,t){const i=Pt(e.sizing.x),o=Pt(e.sizing.y),r=Pt(e.sizing.z),a=e.placementAngle,l=H(e.bitset,le.bitset.isSDF),c=H(e.bitset,le.bitset.isMapAligned),d=H(e.bitset,le.bitset.scaleSymbolsProportionally),p=wt(e.bitset,le.bitset.colorLocked),f=Ni(this,e.id),m=Bi(this,e.id,e.color,p).multiply(f),h=this.view.displayViewScreenMat3.multiply(new A(e.pos.xy,1)),x=ht(this,e.id,r).divide(r),v=i.multiply(x),b=e.offset.xy.multiply(x);let w=o.multiply(d.multiply(x.subtract(1)).add(1));w=Rt(w,we(v.subtract(.99),new n(0)));const _=we(w,new n(1)),R=Rt(w,new n(1)),O=U.fromRotation(a.multiply(ki)),$=Ui(this,e.id),P=this._getViewRotationMatrix(c).multiply($).multiply(O).multiply(new A(b.xy,0)),T=this.clip(e.id,e.zoomRange),M=new z(h.xy.add(P.xy),T,1),S=e.textureUV.divide(this.mosaicInfo.size),Ue=e.outlineColor.multiply(R),Pe=H(e.bitset,le.bitset.overrideOutlineColor),si=e.sdfDecodeCoeff.multiply(v);return{glPosition:M,color:m,textureUV:S,outlineColor:Ue,outlineSize:_,distanceToPx:si,isSDF:l,overrideOutlineColor:Pe,...this.maybeRunHittest(e,t,{pos:e.pos,size:v,sizeCorrection:x,isMapAligned:c,vvRotationMat3:$,placementMat3:O,outlineSize:_,distanceToPx:si,isSDF:l})}}fragment(e){const t=this._getColor(e.textureUV,e);return this.getFragmentOutput(t,e)}hittest(e,t,i){return E(Ci(i.size,this.hittestRequest.smallSymbolSizeThreshold),this._hittestSmallMarker(e,t,i),this._hittestMarker(e,t,i))}_getViewRotationMatrix(e){const t=this.view.displayViewMat3,i=this.view.displayMat3,o=new n(1).subtract(e);return t.multiply(e).add(i.multiply(o))}_getViewScreenMatrix(e){const t=this.view.viewMat3.multiply(this.view.tileMat3),i=this.view.tileMat3,o=new n(1).subtract(e);return t.multiply(e).add(i.multiply(o))}_getColor(e,t){return E(ce(t.isSDF,new n(1)),this._getSDFColor(e,t),this._getSpriteColor(e,t))}_getSpriteColor(e,t){return X(this.mosaicInfo.texture,e).multiply(t.color)}_getSDFColor(e,t){const i=X(this.mosaicInfo.texture,e),o=new n(.5).subtract(Gt(i)).multiply(t.distanceToPx).multiply(Li),r=Se(new n(.5).subtract(o),new n(0),new n(1)),a=t.color.multiply(r);let l=t.outlineSize;this.highlight&&(l=we(l,t.overrideOutlineColor.multiply(4)));const c=l.multiply(.5),d=xt(o).subtract(c),p=Se(new n(.5).subtract(d),new n(0),new n(1)),f=xe(t.outlineColor,t.color,t.overrideOutlineColor).multiply(p);return new n(1).subtract(f.a).multiply(a).add(f)}_hittestSmallMarker(e,t,i){const{position:o,distance:r,smallSymbolDistance:a}=this.hittestRequest,l=r.subtract(a),{viewMat3:c,tileMat3:d}=this.view,p=c.multiply(d).multiply(new A(i.pos,1)).xy,f=i.size.multiply(.5);return Ii(p,o).subtract(f).add(l)}_hittestMarker(e,t,i){const{pos:o,sizeCorrection:r,isMapAligned:a}=i,l=new A(e.offset.multiply(r),0),c=new A(t.offsetNextVertex1.multiply(r),0),d=new A(t.offsetNextVertex2.multiply(r),0),{viewMat3:p,tileMat3:f}=this.view,m=p.multiply(f).multiply(new A(o,1)),h=this._getViewScreenMatrix(a).multiply(i.vvRotationMat3).multiply(i.placementMat3),x=m.add(h.multiply(l)).xy,v=m.add(h.multiply(c)).xy,b=m.add(h.multiply(d)).xy,w=this.hittestRequest.position,_=this.hittestRequest.distance,R=Yt(w,x,v,b);return E(ue(R,_),R,this._hittestSamples(x,v,b,e,t,i))}_hittestSamples(e,t,i,o,r,a){const{outlineSize:l,isSDF:c,distanceToPx:d}=a,p=this.hittestRequest.position,f=this.hittestRequest.distance,m=k(p.add(new y(ee(f),ee(f))),e,t,i),h=k(p.add(new y(0,ee(f))),e,t,i),x=k(p.add(new y(f,ee(f))),e,t,i),v=k(p.add(new y(ee(f),0)),e,t,i),b=k(p,e,t,i),w=k(p.add(new y(f,0)),e,t,i),_=k(p.add(new y(ee(f),f)),e,t,i),R=k(p.add(new y(0,f)),e,t,i),O=k(p.add(new y(f,f)),e,t,i),$=o.textureUV.divide(this.mosaicInfo.size),P=r.textureUVNextVertex1.divide(this.mosaicInfo.size),T=r.textureUVNextVertex2.divide(this.mosaicInfo.size),M={color:new z(1),outlineColor:new z(1),overrideOutlineColor:new n(1),outlineSize:l,distanceToPx:d,isSDF:c};let S=new n(0);return S=S.add(B(m).multiply(this._getColor(me(m,$,P,T),M).a)),S=S.add(B(h).multiply(this._getColor(me(h,$,P,T),M).a)),S=S.add(B(x).multiply(this._getColor(me(x,$,P,T),M).a)),S=S.add(B(v).multiply(this._getColor(me(v,$,P,T),M).a)),S=S.add(B(b).multiply(this._getColor(me(b,$,P,T),M).a)),S=S.add(B(w).multiply(this._getColor(me(w,$,P,T),M).a)),S=S.add(B(_).multiply(this._getColor(me(_,$,P,T),M).a)),S=S.add(B(R).multiply(this._getColor(me(R,$,P,T),M).a)),S=S.add(B(O).multiply(this._getColor(me(O,$,P,T),M).a)),K(S,new n(.05)).multiply(St(this.hittestRequest))}}u([F(qt)],oe.prototype,"visualVariableColor",void 0),u([F(jt)],oe.prototype,"visualVariableOpacity",void 0),u([F(Vt)],oe.prototype,"visualVariableRotation",void 0),u([F(Wt)],oe.prototype,"visualVariableSizeMinMaxValue",void 0),u([F(Kt)],oe.prototype,"visualVariableSizeScaleStops",void 0),u([F(Xt)],oe.prototype,"visualVariableSizeStops",void 0),u([F(Zt)],oe.prototype,"visualVariableSizeUnitValue",void 0),u([V(Be)],oe.prototype,"mosaicInfo",void 0),u([C(0,I(he)),C(1,I(Ke))],oe.prototype,"vertex",null),u([C(0,I(Bo))],oe.prototype,"fragment",null);let No=class extends j{constructor(){super(...arguments),this.type=q.Marker,this.shaders={geometry:new oe},this.symbologyPlane=pe.MARKER}render(e,t){const{context:i,painter:o}=e,r=t.instance.getInput();o.setShader({shader:this.shaders.geometry,uniforms:{...Z(e,t.target,r.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey,!0)},defines:{...L(e)},optionalAttributes:r.optionalAttributes,useComputeBuffer:D(e)}),o.setPipelineState(G(e)),o.submitDraw(e,t)}},Uo=class{constructor(){this.computeAttributes={}}get locationsMap(){const e=new Map;for(const t in this.locations)e.set(t,this.locations[t].index);return e}get optionPropertyKeys(){if(!this._optionPropertyKeys){const e=new Set(Object.keys(this.options));this._optionPropertyKeys=e}return this._optionPropertyKeys}get _transformFeedbackBindings(){return[]}get locationInfo(){if(!this._locationInfo){const e=this.locationsMap,t=Array.from(e.entries()).map(([o,r])=>`${o}.${r}`).join("."),i=ys(t);this._locationInfo={hash:i,stringHash:t,locations:e,computeAttributeMap:this.computeAttributes}}return this._locationInfo}get renamedLocationsMap(){const e=new Map;for(const[t,i]of this.locationsMap.entries())e.set("a_"+t,i);return e}getShaderKey(e,t,i){return`${Object.keys(e).map(o=>`${o}.${e[o]}`).join(".")}.${Object.keys(i).filter(o=>i[o]).map(o=>`${o}_${i[o].toString()}`).join(".")}.${Object.keys(t).filter(o=>this.optionPropertyKeys.has(o)).join(".")}`}getProgram(e,t,i,o){let r="",a="";for(const l in i)if(i[l]){const c=typeof i[l]=="boolean"?`#define ${l}
`:`#define ${l} ${i[l]}
`;r+=c,a+=c}return r+=this.vertexShader,a+=this.fragmentShader,new Cs(r,a,this.renamedLocationsMap,this.locationInfo,this._getUniformBindings(t),this._transformFeedbackBindings)}_getUniformBindings(e){const t=[];for(const i in this.required){const o=this.required[i];t.push({uniformHydrated:null,shaderModulePath:i,uniformName:i,uniformType:o.type,uniformArrayElementType:Si(o),uniformArrayLength:Vi(o)})}for(const i in e){const o=this.options[i];if(e[i])for(const r in o){const a=o[r];t.push({uniformHydrated:null,shaderModulePath:`${i}.${r}`,uniformName:r,uniformType:a.type,uniformArrayElementType:Si(a),uniformArrayLength:Vi(a)})}}return t}};const Si=s=>{var e;return s.type==="array"?(e=s.elementType)==null?void 0:e.type:void 0},Vi=s=>s.type==="array"?s.size:void 0,Ho={hittestDist:n,hittestPos:y},Go={filterFlags:Q,animation:Q,visualVariableData:Q,dataDriven0:Q,dataDriven1:Q,dataDriven2:Q,gpgpu:Q,size:n},qo={displayViewScreenMat3:U,displayViewMat3:U,displayMat3:U,viewMat3:U,tileMat3:U,displayZoomFactor:n,requiredZoomFactor:n,tileOffset:y,currentScale:n,currentZoom:n,metersPerSRUnit:n};let jo=class extends Uo{constructor(){super(...arguments),this.vertexShader=xi("materials/pie/pie.vert"),this.fragmentShader=xi("materials/pie/pie.frag"),this.required={...Go,...qo,outlineWidth:n,colors:ne,defaultColor:z,othersColor:z,outlineColor:z,donutRatio:n,sectorThreshold:n},this.options={hittestUniforms:Ho,visualVariableSizeMinMaxValue:{minMaxValueAndSize:z},visualVariableSizeScaleStops:{sizes:{...ne.ofType(n,8),type:"array",elementType:n,size:8},values:{...ne.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeStops:{sizes:{...ne.ofType(n,8),type:"array",elementType:n,size:8},values:{...ne.ofType(n,8),type:"array",elementType:n,size:8}},visualVariableSizeUnitValue:{unitValueToPixelsRatio:n},visualVariableOpacity:{opacities:{...ne.ofType(n,8),type:"array",elementType:n,size:8},opacityValues:{...ne.ofType(n,8),type:"array",elementType:n,size:8}}},this.locations={pos:{index:0,type:y},id:{index:1,type:A},bitset:{index:2,type:n},offset:{index:3,type:y},texCoords:{index:4,type:y},size:{index:5,type:y},referenceSize:{index:6,type:n},zoomRange:{index:7,type:y}},this.defines={VV_SIZE_MIN_MAX_VALUE:"boolean",VV_SIZE_SCALE_STOPS:"boolean",VV_SIZE_FIELD_STOPS:"boolean",VV_SIZE_UNIT_VALUE:"boolean",VV_OPACITY:"boolean",HITTEST:"boolean",numberOfFields:"number",highlight:"boolean",inside:"boolean",outside:"boolean"}}setNumberOfFields(e){this.required.colors={...ne.ofType(z,e),type:"array",elementType:z,size:e}}},Wo=class extends j{constructor(){super(...arguments),this.type=q.PieChart,this.shaders={geometry:new jo},this.symbologyPlane=pe.MARKER}render(e,t){var m,h;const{painter:i}=e,{instance:o,target:r}=t,a=this.shaders.geometry,l=o.getInput(),c=l.uniforms.numberOfFields,d=D(e),p=N(e,r),f=L(e);a.setNumberOfFields(c),i.setShader({shader:a,uniforms:{...Z(e,t.target,l.uniforms.shader),...p.storage,...p.view,hittestUniforms:p.hittestRequest?{hittestDist:(m=p.hittestRequest)==null?void 0:m.distance,hittestPos:(h=p.hittestRequest)==null?void 0:h.position}:null},defines:{VV_SIZE_MIN_MAX_VALUE:!!l.uniforms.shader.visualVariableSizeMinMaxValue,VV_SIZE_SCALE_STOPS:!!l.uniforms.shader.visualVariableSizeScaleStops,VV_SIZE_FIELD_STOPS:!!l.uniforms.shader.visualVariableSizeStops,VV_SIZE_UNIT_VALUE:!!l.uniforms.shader.visualVariableSizeUnitValue,VV_OPACITY:!!l.uniforms.shader.visualVariableOpacity,HITTEST:d,highlight:p.highlight?1:0,...f,numberOfFields:c},optionalAttributes:{},useComputeBuffer:d}),i.setPipelineState(G(e)),i.submitDraw(e,t)}},Ko=class extends j{constructor(){super(...arguments),this.type=q.Text,this.shaders={geometry:new W},this.symbologyPlane=pe.TEXT}render(e,t){const{context:i,painter:o}=e,r=L(e),a=t.instance.getInput(),l={shader:this.shaders.geometry,uniforms:{...Z(e,t.target,a.uniforms),...N(e,t.target),mosaicInfo:o.textureManager.getMosaicInfo(i,t.textureKey)},defines:{...r,isBackgroundPass:!0,isLabel:!1,textRenderPassType:Y.Color},optionalAttributes:a.optionalAttributes,useComputeBuffer:D(e)};o.setShader(l),o.setPipelineState(G(e)),o.submitDraw(e,t),o.setShader({...l,defines:{...r,isBackgroundPass:!1,isLabel:!1,textRenderPassType:Y.Halo}}),o.submitDraw(e,t),o.setShader({...l,defines:{...r,isBackgroundPass:!1,isLabel:!1,textRenderPassType:Y.Outline}}),o.submitDraw(e,t),o.setShader({...l,defines:{...r,isBackgroundPass:!1,isLabel:!1,textRenderPassType:Y.Color}}),o.submitDraw(e,t)}};const te={fill:new go,patternFill:new Vo,complexFill:new vo,gradientFill:new wo,outlineFill:new So,patternOutlineFill:new zo,complexOutlineFill:new bo,marker:new No,pieChart:new Wo,line:new Lo,texturedLine:new ko,gradientStroke:new Eo,text:new Ko,label:new Do,heatmap:new Ao,dotDensity:new yo,animatedMarker:new co};function Za(){for(const s in te)te[s].startup()}function Ya(s){for(const e in te)te[e].shutdown(s)}function yt(s,e){const t=s.slice(0,e),i=e-t.length;for(let o=0;o<i;o++){const r=t[t.length-1];t.push(r)}return t}function Xo(s){if(!s)return[0,0,0,0];const{r:e,g:t,b:i,a:o}=s;return[e*(o/255),t*(o/255),i*(o/255),o]}const ct=8,os=ct-2,rs=()=>Ti.getLogger("esri.views.2d.layers.features.support.rendererUtils");function as(s){return s.map(e=>Zo(e)?Yo(e.clone()):e)}function Zo(s){return(s.type==="size"||s.type==="color"||s.type==="opacity")&&s.stops!=null}function Yo(s){return s.stops=er(s.type,s.stops??[]),s}function Te(s,e,t){return(1-t)*s+t*e}function Qo(s,e){const[t,...i]=e,o=i.pop(),r=i[0].value,a=i[i.length-1].value,l=(a-r)/os,c=[];for(let d=r;d<a;d+=l){let p=0;for(;d>=i[p].value;)p++;const f=i[p],m=e[p-1],h=d-m.value,x=f.value===m.value?1:h/(f.value-m.value);if(s==="color"){const v=i[p],b=e[p-1],w=v.color.clone();w.r=Te(b.color.r,w.r,x),w.g=Te(b.color.g,w.g,x),w.b=Te(b.color.b,w.b,x),w.a=Te(b.color.a,w.a,x),c.push({value:d,color:w,label:v.label})}else if(s==="size"){const v=i[p],b=e[p-1],w=ci(v.size),_=Te(ci(b.size),w,x);c.push({value:d,size:_,label:v.label})}else{const v=i[p],b=Te(e[p-1].opacity,v.opacity,x);c.push({value:d,opacity:b,label:v.label})}}return[t,...c,o]}function Jo(s){const[e,...t]=s,i=t.pop();for(;t.length>os;){let o=0,r=0;for(let a=1;a<t.length;a++){const l=t[a-1],c=t[a],d=Math.abs(c.value-l.value);d>r&&(r=d,o=a)}t.splice(o,1)}return[e,...t,i]}function er(s,e){return e.length<=ct?e:(rs().warn(`Found ${e.length} Visual Variable stops, but MapView only supports ${ct}. Displayed stops will be simplified.`),e.length>2*ct?Qo(s,e):Jo(e))}function tr(){const{supportsColorBufferFloat:s,supportsColorBufferFloatBlend:e,supportsColorBufferHalfFloat:t}=bt();return s&&e||t}function Qa(s){if(!s)return!0;switch(s.type){case"dot-density":break;case"heatmap":if(!tr()){const e=bt(),t=["supportsColorBufferFloat","supportsColorBufferFloatBlend","supportsColorBufferHalfFloat"].filter(i=>!e[i]).join(", ");return rs().errorOnce(new st("webgl-missing-extension",`Missing WebGL2 requirements for Heatmap: ${t}`)),!1}}return!0}const ir=1.25,it=128,sr=128;function or(s){var r;if(!((r=s.stops)!=null&&r.length))return null;const e=s.stops.sort((a,l)=>a.value-l.value),t=yt(e,8),i=t.map(({value:a})=>a),o=t.map(({color:a})=>Xo(a));return{values:i,colors:o}}function rr(s){var i;if(!((i=s.stops)!=null&&i.length))return null;const e=s.stops.sort((o,r)=>o.value-r.value),t=yt(e,8);return{opacityValues:t.map(({value:o})=>o),opacities:t.map(({opacity:o})=>o)}}function ar(s){return{rotationType:s.rotationType==="geographic"?Ct.Geographic:Ct.Arithmatic}}function Mt(s){var i;if(!((i=s.stops)!=null&&i.length))return null;if(s.stops.some(o=>o.useMaxValue||o.useMinValue))return(o,r)=>{const a=o.statisticsByLevel.get(r.key.level),l=s.stops.map(d=>{var p,f;return{value:d.useMaxValue?((p=a==null?void 0:a.get(s.field))==null?void 0:p.maxValue)??0:d.useMinValue?((f=a==null?void 0:a.get(s.field))==null?void 0:f.minValue)??0:d.value,size:d.size?ze(d.size):vs}}).sort((d,p)=>d.value-p.value),c=yt(l,8);return{values:c.map(({value:d})=>d),sizes:c.map(({size:d})=>d)}};const e=s.stops.sort((o,r)=>o.value-r.value),t=yt(e,8);return{values:t.map(({value:o})=>o),sizes:t.map(({size:o})=>ze(o))}}function nr(s){return e=>{const{state:t}=e;return{unitValueToPixelsRatio:bs(t.spatialReference)/gs[s.valueUnit??"meters"]/t.resolution}}}function zi(s,e){const t=e.length;if(s<e[0].value||t===1)return e[0].size;for(let i=1;i<t;i++)if(s<e[i].value){const o=(s-e[i-1].value)/(e[i].value-e[i-1].value);return e[i-1].size+o*(e[i].size-e[i-1].size)}return e[t-1].size}function lr(s){const{minDataValue:e,maxDataValue:t,minSize:i,maxSize:o}=s;if(typeof i=="object"&&typeof o=="object")return(r,a)=>{const l=r.state.scale,c=ze(zi(l,i.stops)),d=ze(zi(l,o.stops));return{minMaxValueAndSize:[e,t,c,d]}};if(typeof i=="object"||typeof o=="object")throw new Error("InternalError: Found a partial VisualVariableSizeMinMaxValue");return{minMaxValueAndSize:[e,t,ze(i),ze(o)]}}const Ye={visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:null,visualVariableSizeStops:null,visualVariableSizeScaleStops:null,visualVariableSizeOutlineScaleStops:null,visualVariableSizeUnitValue:null,visualVariableSizeMinMaxValue:null};function ns(s,e=sr,t=ir){if(s.visualVariableSizeMinMaxValue)return s.visualVariableSizeMinMaxValue instanceof Function?it:Math.max(s.visualVariableSizeMinMaxValue.minMaxValueAndSize[3]*t,e);if(s.visualVariableSizeScaleStops){if(s.visualVariableSizeScaleStops instanceof Function)return it;const i=s.visualVariableSizeScaleStops.sizes;return Math.max(i[i.length-1]*t,e)}if(s.visualVariableSizeStops){if(s.visualVariableSizeStops instanceof Function)return it;const i=s.visualVariableSizeStops.sizes;return Math.max(i[i.length-1]*t,e)}return s.visualVariableSizeUnitValue?2*it:0}function Ja(s){const e={...Ye};if(!s||!("visualVariables"in s)||!s.visualVariables)return e;for(const t of as(s.visualVariables))switch(t.type){case"color":e.visualVariableColor=or(t);break;case"opacity":e.visualVariableOpacity=rr(t);break;case"rotation":e.visualVariableRotation=ar(t);break;case"size":switch(ur(t)){case"field-stops":e.visualVariableSizeStops=Mt(t);break;case"scale-stops":t.target==="outline"?e.visualVariableSizeOutlineScaleStops=Mt(t):e.visualVariableSizeScaleStops=Mt(t);break;case"min-max":e.visualVariableSizeMinMaxValue=lr(t);break;case"unit-value":e.visualVariableSizeUnitValue=nr(t)}break}return e}function ur(s){return typeof s.minDataValue=="number"&&typeof s.maxDataValue=="number"&&s.minSize!=null&&s.maxSize!=null?"min-max":(s==null?void 0:s.valueExpression)==="$view.scale"&&Array.isArray(s.stops)?"scale-stops":s.field==null&&(s==null?void 0:s.valueExpression)==="$view.scale"||!(Array.isArray(s.stops)||"levels"in s&&s.levels)?s.field!=null||(s==null?void 0:s.valueExpression)!=="$view.scale"?"unit-value":null:"field-stops"}function cr(s){return!!(s.visualVariableSizeMinMaxValue||s.visualVariableSizeScaleStops||s.visualVariableSizeStops||s.visualVariableSizeUnitValue||s.visualVariableSizeOutlineScaleStops)}function en(s){return!!s.visualVariableRotation}function pr(s){return s.minScale||s.maxScale?{minScale:s.minScale??0,maxScale:s.maxScale??0}:null}function se(s){if(s==null)return null;if(Array.isArray(s)){const[e,t,i,o]=s;return[e,t,i,255*o]}return typeof s=="string"?s:{...s,defaultValue:se(s==null?void 0:s.defaultValue)}}async function tn(s,e){const{cimResourceManager:t,cimAnalyzer:i,scaleExpression:o}=e.schemaOptions;await Promise.all(us.fetchResources(s.symbol,t,[]));const r=i.analyzeSymbolReference(s,!1),a={scaleInfo:pr(s),scaleExpression:o},l=[];for(const c of r)switch(c.type){case"marker":l.push(...dr(c,e,a));break;case"fill":l.push(...vr(c,e,a));break;case"gradientFill":l.push(...gr(c,e,a));break;case"line":l.push(...wr(c,e,a));break;case"gradientStroke":l.push(...zr(c,e,a));break;case"text":l.push(...$r(c,e,a))}return l}function dr(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o,a=s.isOutline?{...Ye,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue,visualVariableRotation:i.visualVariableRotation};return s.animationParams?fr(r.ensureInstance(te.animatedMarker,{uniforms:a,optionalAttributes:{zoomRange:!0}}),s,Ye,t):mr(r.ensureInstance(te.marker,{uniforms:a,optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i,t)}function fr(s,e,t,i){return e.animationParams?[s.createMeshInfo({pixelDimensions:e.pixelDimensions,texelDimensions:e.texelDimensions,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,sprite:e.spriteRasterizationParam,animations:e.animationParams,scaleInfo:i.scaleInfo,scaleSymbolsProportionally:e.scaleSymbolsProportionally,strokeWidth:e.outlineWidth,isMapAligned:e.alignment===xs.MAP,colorLocked:e.colorLocked,isStroke:e.isStroke,baseSize:e.baseSize,referenceSize:e.referenceSize,angleToLine:!!e.markerPlacement&&e.markerPlacement.placement&&"angleToLine"in e.markerPlacement.placement&&e.markerPlacement.placement.angleToLine,sizeRatio:e.sizeRatio})]:[]}function mr(s,e,t,{scaleInfo:i,scaleExpression:o}){const r=cr(t);return[s.createMeshInfo({size:e.size,scaleX:e.scaleX,anchorX:e.anchorPoint.x,anchorY:e.anchorPoint.y,angle:e.rotation,color:se(e.color)??[0,0,0,0],colorLocked:e.colorLocked,frameHeight:e.frameHeight,widthRatio:e.widthRatio,scaleInfo:i,offsetX:e.offsetX,offsetY:e.offsetY,outlineColor:se(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineWidth,referenceSize:e.referenceSize||ws.CIMVectorMarker.size,rotateClockwise:e.rotateClockwise,scaleFactor:o??1,sizeRatio:e.sizeRatio,alignment:e.alignment,isAbsoluteAnchorPoint:e.isAbsoluteAnchorPoint,scaleSymbolsProportionally:e.scaleSymbolsProportionally,sprite:e.spriteRasterizationParam,hasSizeVV:r,placement:e.markerPlacement,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,transforms:e.transform,minPixelBuffer:ns(t)})]}function hr(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o;return yr(r.ensureInstance(te.fill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,t)}function yr(s,e,{scaleInfo:t}){return[s.createMeshInfo({color:se(e.color)??[0,0,0,0],scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function vr(s,e,t){if(!s.spriteRasterizationParam)return hr(s,e,t);const{uniforms:i,schemaOptions:o}=e,{store:r}=o;return br(r.ensureInstance(te.complexFill,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,i.visualVariableColor!=null,t)}function br(s,e,t,{scaleInfo:i}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const o=!!e.hasUnresolvedReplacementColor&&(!t||e.colorLocked),r=e.sampleAlphaOnly&&!o,a=e.spriteRasterizationParam;return[s.createMeshInfo({color:se(e.color)??[0,0,0,0],height:e.height,aspectRatio:e.scaleX,offsetX:e.offsetX,offsetY:e.offsetY,scaleX:1,scaleY:1,angle:e.angle,applyRandomOffset:e.applyRandomOffset,sampleAlphaOnly:r,scaleProportionally:a.resource.type==="CIMHatchFill",sprite:a,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function gr(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o;return xr(r.ensureInstance(te.gradientFill,{uniforms:{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,t)}function xr(s,e,{scaleInfo:t}){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const i=e.spriteRasterizationParam;return[s.createMeshInfo({color:se(e.color)??[0,0,0,0],angle:e.angle,gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,scaleInfo:t,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function wr(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o,a=s.isOutline?{...Ye,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},l={uniforms:a,optionalAttributes:{zoomRange:!!t.scaleInfo}},c=!!(a.visualVariableSizeMinMaxValue||a.visualVariableSizeScaleStops||a.visualVariableSizeStops||a.visualVariableSizeUnitValue);return s.spriteRasterizationParam?Vr(r.ensureInstance(te.texturedLine,l),s,c,t):Sr(r.ensureInstance(te.line,l),s,c,t)}function ii(s,e,{scaleInfo:t}){return{color:se(s.color)??[0,0,0,0],width:s.width,referenceWidth:s.referenceWidth,capType:s.cap,joinType:s.join,miterLimit:s.miterLimit,scaleInfo:t,hasSizeVV:e,effects:s.effects?{type:"cim-effect-infos",effectInfos:s.effects}:null}}function Sr(s,e,t,i){if(e.spriteRasterizationParam)throw new Error("InternalError: Sprite should not be defined");const o=ii(e,t,i);return[s.createMeshInfo(o)]}function Vr(s,e,t,i){const{spriteRasterizationParam:o,scaleDash:r,sampleAlphaOnly:a}=e;if(!o)throw new Error("InternalError: Sprite should be defined");return[s.createMeshInfo({...ii(e,t,i),offsetAlongLine:e.offsetAlongLine??0,shouldScaleDash:r??!1,shouldSampleAlphaOnly:a,isSDF:o.resource.type!=="CIMPictureStroke"&&o.resource.type!=="CIMGradientStroke",sprite:o})]}function zr(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o;return _r(r.ensureInstance(te.gradientStroke,{uniforms:s.isOutline?{...Ye,visualVariableSizeScaleStops:i.visualVariableSizeOutlineScaleStops}:{visualVariableColor:null,visualVariableOpacity:i.visualVariableOpacity,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo}}),s,t)}function _r(s,e,t){if(!e.spriteRasterizationParam)throw new Error("InternalError: Sprite should always be defined");const i=e.spriteRasterizationParam;return[s.createMeshInfo({...ii(e,!1,t),gradientMethod:e.gradientMethod,gradientSize:e.gradientSize,gradientSizeUnits:e.gradientSizeUnits,gradientType:e.gradientType,sprite:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null})]}function $r(s,e,t){const{uniforms:i,schemaOptions:o}=e,{store:r}=o;return Pr(r.ensureInstance(te.text,{uniforms:{visualVariableColor:s.colorLocked?null:i.visualVariableColor,visualVariableOpacity:i.visualVariableOpacity,visualVariableRotation:i.visualVariableRotation,visualVariableSizeMinMaxValue:i.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:i.visualVariableSizeScaleStops,visualVariableSizeStops:i.visualVariableSizeStops,visualVariableSizeUnitValue:i.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!!t.scaleInfo,referenceSymbol:!1,clipAngle:!1}}),s,i,t)}function Pr(s,e,t,{scaleInfo:i,scaleExpression:o}){return[s.createMeshInfo({boxBackgroundColor:se(e.backgroundColor),boxBorderLineColor:se(e.borderLineColor),boxBorderLineSize:e.borderLineWidth??0,color:se(e.color)??[0,0,0,0],offsetX:e.offsetX,offsetY:e.offsetY,postAngle:e.angle,fontSize:e.size,referenceSize:e.referenceSize,decoration:e.decoration,haloColor:se(e.haloColor)??[0,0,0,0],haloSize:e.haloSize??0,outlineColor:se(e.outlineColor)??[0,0,0,0],outlineSize:e.outlineSize,lineWidth:e.lineWidth||512,lineHeightRatio:1,horizontalAlignment:e.horizontalAlignment??"center",verticalAlignment:e.verticalAlignment??"baseline",useCIMAngleBehavior:!1,glyphs:e.textRasterizationParam,scaleInfo:i,effects:e.effects?{type:"cim-effect-infos",effectInfos:e.effects}:null,placement:e.markerPlacement,transforms:e.transform,scaleFactor:o??1,minPixelBuffer:ns(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null})]}function sn(s,e){return{type:"simple",filters:e,capabilities:{maxTextureSize:bt().maxTextureSize},bindings:pt(s)}}function on(s,e){const t=bt();return{type:"multi",target:"feature",keyField:to,filters:e,capabilities:{maxTextureSize:t.maxTextureSize},bindings:{[$t.TrackLine]:pt(s.trackLines.renderer),[$t.LatestObservation]:pt(s.latestObservations.renderer),[$t.PreviousObservation]:pt(s.previousObservations.renderer)}}}function zt(s){switch(s){case"opacity":return et.OPACITY;case"color":return et.COLOR;case"rotation":return et.ROTATION;case"size":return et.SIZE;default:return null}}function pt(s){if(!s)return[];switch(s.type){case"simple":case"class-breaks":case"unique-value":case"dictionary":return ls(s);case"dot-density":return Mr(s);case"pie-chart":return Tr(s);case"heatmap":return Ar(s)}}function Mr(s){const e=[];for(const t of s.attributes)e.push({binding:e.length,expression:t.valueExpression,field:t.field});return e}function Tr(s){const e=ls(s);let t=4;for(const i of s.attributes)e.push({binding:t++,expression:i.valueExpression,field:i.field});return e}function Ar({valueExpression:s,field:e}){return s||e?[{binding:0,expression:s,field:e}]:[]}function ls(s){var e;return!("visualVariables"in s)||!((e=s.visualVariables)!=null&&e.length)?[]:as(s.visualVariables).map(t=>Fr(t)).filter(Ss)}function Rr(s){return s.valueExpression==="$view.scale"?null:{binding:zt(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression,valueRepresentation:s.valueRepresentation}}function Cr(s){return{binding:zt(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Ir(s){return{binding:zt(s.type),field:s.field,normalizationField:s.normalizationField,expression:s.valueExpression}}function Or(s){return{binding:zt(s.type),expression:s.valueExpression,field:s.field}}function Fr(s){switch(s.type){case"size":return Rr(s);case"color":return Cr(s);case"opacity":return Ir(s);case"rotation":return Or(s)}}class Dr{constructor(){this.type="override-batch",this.messages=[],this._resovler=zs()}get promise(){return this._resovler.promise}resolve(){this._resovler.resolve()}add(e){this.messages.push(e)}}class rn{constructor(e){this.updateTracking=new Ks({debugName:"FeatureCommandQueue"}),this.process=e.process,this._queueProcessor=new io({concurrency:1,process:async t=>{if(t.type==="override-batch"){const i=this._nextOverrideBatch;if(i==null)throw new Error("InternalError: Override should be defined");return this._nextOverrideBatch=null,await this.process(i),void i.resolve()}return this.process(t)}})}destroy(){this.updateTracking.destroy(),this._queueProcessor.destroy(),this.clear()}clear(){this._queueProcessor.clear()}async push(e){return Vs(this.updateTracking.addPromise(this._doPush(e)))}async _doPush(e){const t=this._queueProcessor,i=t.last();switch(e.type){case"update":case"highlight":return(i==null?void 0:i.type)===e.type?void 0:t.push(e);case"override":case"edit":return this._pushOverride(e)}}_pushOverride(e){return this._nextOverrideBatch==null&&(this._nextOverrideBatch=new Dr,this._queueProcessor.push(this._nextOverrideBatch)),this._nextOverrideBatch.add(e),this._nextOverrideBatch.promise}}export{Ya as F,_r as M,Pr as P,yr as S,br as V,rn as a,sn as b,tn as c,Ja as d,cr as e,on as f,Vr as g,xr as h,en as i,te as j,ls as k,ti as l,Qa as m,pr as n,oo as o,mr as p,Za as q,ao as s,Xo as t,fr as u,ns as x,Sr as y,Ye as z};
