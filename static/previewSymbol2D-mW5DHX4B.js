import{e_ as x,b as _,bO as Z,hr as P}from"./index-DKbcOXvO.js";import{L as O}from"./colorUtils-BzQn9I3U.js";import{c as G}from"./fontUtils-BfBCIMfO.js";import{U as J,k as K}from"./quantizationUtils-Deoeu4Gm.js";import{u as V,y as W,g as Q,f as X}from"./utils-RvMyfGMI.js";import{t as A,e as Y,d as T,l as $}from"./symbolUtils-CzMVLFsX.js";import"./cimSymbolUtils-CXebtMzF.js";import"./utils-BZPv7EW8.js";import"./webStyleSymbolUtils-DxchteCT.js";import"./devEnvironmentUtils-CnNDiFMM.js";import"./webStyleAcceptedFormats-CG7ZQ6BV.js";const H="picture-fill",tt="picture-marker",it="simple-fill",nt="simple-line",ot="simple-marker",at="text",et="Aa",lt=A.size,z=A.maxSize,st=A.maxOutlineSize,U=A.lineWidth,q=225,rt=document.createElement("canvas");function R(i,t,s){if(i.type==="polygon"){const o=i.extent,u=o.width===0?1:o.width,c=o.height===0?1:o.height;i=J({originPosition:"upperLeft",scale:[u/t,c/s],translate:[o.xmin,o.ymax]},{},i);let r="";for(let e=0;e<i.rings.length;e++){const l=i.rings[e];for(let h=0;h<l.length;h++){const p=l[h][0],d=l[h][1];let n="";h===0?(n=`M${p.toString()} ${d.toString()}`,r!==""&&(n=` ${n}`),r+=n):h===l.length-1?(n=`l${p.toString()} ${d.toString()} Z`,r!==""&&(n=` ${n}`),r+=n):(n=`l${p.toString()} ${d.toString()}`,r!==""&&(n=` ${n}`),r+=n)}}return r}if(i.type==="polyline"){const o=i.extent,u=o.width===0?1:o.width,c=o.height===0?1:o.height;i=K({originPosition:"lowerLeft",scale:[u/t,c/s],translate:[o.xmin,o.ymax]},{},i);let r="";for(let e=0;e<i.paths.length;e++){const l=i.paths[e];for(let h=0;h<l.length;h++){const p=l[h][0],d=l[h][1];let n="";h===0?(n=`M${p.toString()} ${d.toString()}`,r!==""&&(n=` ${n}`),r+=n):(n=`l${p.toString()} ${d.toString()}`,r!==""&&(n=` ${n}`),r+=n)}}return r}return""}function I(i,t){const s=rt.getContext("2d"),o=[];t&&(t.weight&&o.push(t.weight),t.size&&o.push(t.size+"px"),t.family&&o.push(t.family)),s.font=o.join(" ");const{width:u,actualBoundingBoxLeft:c,actualBoundingBoxRight:r,actualBoundingBoxAscent:e,actualBoundingBoxDescent:l}=s.measureText(i);return{width:Math.ceil(Math.max(u,c+r)),height:Math.ceil(e+l),x:Math.floor(c),y:Math.floor((e-l)/2)}}function k(i){const t=i==null?void 0:i.size;return{width:t!=null&&typeof t=="object"&&"width"in t?x(t.width):null,height:t!=null&&typeof t=="object"&&"height"in t?x(t.height):null}}async function ht(i,t){const s=t.fill,o=i.color;if((s==null?void 0:s.type)==="pattern"&&o&&i.type!==H){const u=await X(s.src,o.toCss(!0));s.src=u,t.fill=s}}async function ct(i,t,s,o){var r,e,l;if(!("font"in i)||!i.font||t.shape.type!=="text")return;try{await G(i.font)}catch{}const{width:u,height:c}=k(o);if(!/[\uE600-\uE6FF]/.test(t.shape.text)){const{width:h,height:p,x:d,y:n}=I(t.shape.text,{weight:(r=t.font)==null?void 0:r.weight,size:(e=t.font)==null?void 0:e.size,family:(l=t.font)==null?void 0:l.family});s[0]=u??h,s[1]=c??p,t.shape.x=d,t.shape.y=n;let a="angle"in i?i.angle:null;if((o==null?void 0:o.rotation)!=null&&(a=(a??0)+o.rotation),a){const M=a*(Math.PI/180),L=Math.abs(Math.sin(M)),C=Math.abs(Math.cos(M));s[1]=s[0]*L+s[1]*C}}}function ut(i,t,s,o,u){var c;if(i.haloColor!=null&&i.haloSize!=null){u.masking??(u.masking=s.map(()=>[]));const r=x(i.haloSize);o[0]+=r,o[1]+=r,s.unshift([{...t,fill:null,stroke:{color:i.haloColor,width:2*r,join:"round",cap:"round"}}]),u.masking.unshift([{shape:{type:"rect",x:0,y:0,width:o[0]+2*P,height:o[1]+2*P},fill:[255,255,255],stroke:null},{...t,fill:[0,0,0,0],stroke:null}])}i.backgroundColor==null&&i.borderLineColor==null||(o[0]+=2*P,o[1]+=2*P,s.unshift([{shape:{type:"rect",x:0,y:0,width:o[0],height:o[1]},fill:i.backgroundColor,stroke:{color:i.borderLineColor,width:x(i.borderLineSize)}}]),(c=u.masking)==null||c.unshift([]))}function N(i,t){return i>t?"dark":"light"}function mt(i,t){var L,C,j,D,E;const s=typeof(t==null?void 0:t.size)=="number"?t==null?void 0:t.size:null,o=s!=null?x(s):null,u=(t==null?void 0:t.maxSize)!=null?x(t.maxSize):null;let c="angle"in i?i.angle:null;(t==null?void 0:t.rotation)!=null&&(c=(c??0)+t.rotation);const r=V(i);let e=W(i);pt(i,245)!=="dark"||t!=null&&t.ignoreWhiteSymbols||(e={width:.75,...e,color:"#bdc3c7"});let l=null;const h={shape:null,fill:r,stroke:e,offset:[0,0]};e!=null&&e.width&&(e.width=Math.min(e.width,st));const p=(e==null?void 0:e.width)||0;let d=(t==null?void 0:t.size)!=null&&((t==null?void 0:t.scale)==null||(t==null?void 0:t.scale)),n=0,a=0,M=!1;switch(i.type){case ot:{const f=i.style,{width:g,height:m}=k(t);let b=g===m&&g!=null?g:o??Math.min(x(i.size),u||z);if((t==null?void 0:t.useMarkerSymbolSize)===!0&&g!==null&&m!==null){const y=Math.min(x(i.size),u||z);b=y>g&&y>m?Math.min(g,m):y}switch(n=b,a=b,f){case"circle":h.shape={type:"circle",cx:0,cy:0,r:.5*b},d||(n+=p,a+=p);break;case"cross":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[n,.5*a]},{command:"M",values:[.5*n,0]},{command:"L",values:[.5*n,a]}]};break;case"diamond":h.shape={type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[.5*n,0]},{command:"L",values:[n,.5*a]},{command:"L",values:[.5*n,a]},{command:"Z",values:[]}]},d||(n+=p,a+=p);break;case"square":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,0]},{command:"L",values:[n,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(n+=p,a+=p),c&&(M=!0);break;case"triangle":h.shape={type:"path",path:[{command:"M",values:[.5*n,0]},{command:"L",values:[n,a]},{command:"L",values:[0,a]},{command:"Z",values:[]}]},d||(n+=p,a+=p),c&&(M=!0);break;case"x":h.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,a]},{command:"M",values:[n,0]},{command:"L",values:[0,a]}]},c&&(M=!0);break;case"path":h.shape={type:"path",path:i.path||""},d||(n+=p,a+=p),c&&(M=!0),d=!0}break}case nt:{const{width:f,height:g}=k(t),m=Q(e).reduce((v,S)=>v+S,0),b=m&&Math.ceil(U/m),y=g??o??p,w=f??(m*b||U);if(d=!0,((L=t==null?void 0:t.geometry)==null?void 0:L.type)==="polyline"&&((C=t==null?void 0:t.geometry)==null?void 0:C.extent)){n=w,a=g??n;const v=1e3,S=.15*v;l=[n,a],a=l[0]>l[1]?v*l[1]/l[0]:v,n=l[0]>l[1]?v:v*l[0]/l[1],e!=null&&e.width&&(e.width=e.width*v/(l[1]>l[0]?l[1]:l[0]),e.width>S&&(e.width=S)),h.shape={type:"path",path:R(t.geometry,n,a)}}else n=(t==null?void 0:t.maxSize)!=null?Math.min(w,t.maxSize):w,a=y,e&&(e.width=y),h.shape={type:"path",path:[{command:"M",values:[y/2,a/2]},{command:"L",values:[n-y/2,a/2]}]};break}case H:case it:{const f=typeof(t==null?void 0:t.symbolConfig)=="object"&&!!((j=t==null?void 0:t.symbolConfig)!=null&&j.isSquareFill),{width:g,height:m}=k(t);n=!f&&g!==m||g==null?o??lt:g,a=!f&&g!==m||m==null?n:m,d||(n+=p,a+=p),d=!0,(D=t==null?void 0:t.geometry)!=null&&D.extent&&((E=t==null?void 0:t.geometry)==null?void 0:E.type)==="polygon"?(l=[n,a],a=l[0]>l[1]?1e3*l[1]/l[0]:1e3,n=l[0]>l[1]?1e3:1e3*l[0]/l[1],h.shape={type:"path",path:R(t.geometry,n,a)}):h.shape=f?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[n,0]},{command:"L",values:[n,a]},{command:"L",values:[0,a]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:Y.fill[0];break}case tt:{const f=Math.min(x(i.width),u||z),g=Math.min(x(i.height),u||z),{width:m,height:b}=k(t),y=m===b&&m!=null?m:o??Math.max(f,g),w=i.width/i.height;n=w<=1?Math.ceil(y*w):y,a=w<=1?y:Math.ceil(y/w),h.shape={type:"image",x:-Math.round(n/2),y:-Math.round(a/2),width:n,height:a,src:i.url||""},c&&(M=!0);break}case at:{const f=i,g=(t==null?void 0:t.overrideText)||f.text||et,m=f.font,{width:b,height:y}=k(t),w=y??o??Math.min(x(m.size),u||z),{width:v,height:S}=I(g,{weight:m.weight,size:w,family:m.family}),B=/[\uE600-\uE6FF]/.test(g);n=b??(B?w:v),a=B?w:S;let F=.5*(B?w:S);B&&(F+=5),h.shape={type:"text",text:g,x:f.xoffset||0,y:f.yoffset||F,align:"middle",alignBaseline:f.verticalAlignment,decoration:m&&m.decoration,rotated:f.rotated,kerning:f.kerning},h.font=m&&{size:w,style:m.style,decoration:m.decoration,weight:m.weight,family:m.family};break}}return{shapeDescriptor:h,size:[n,a],outputSize:l,renderOptions:{node:t==null?void 0:t.node,scale:d,opacity:t==null?void 0:t.opacity,rotations:[c],useRotationSize:M,effectView:t==null?void 0:t.effectView,ariaLabel:t==null?void 0:t.ariaLabel}}}async function zt(i,t){var l,h,p,d,n;const{shapeDescriptor:s,size:o,renderOptions:u,outputSize:c}=mt(i,t);if(!s.shape)throw new _("symbolPreview: renderPreviewHTML2D","symbol not supported.");await ht(i,s),await ct(i,s,o,t);const r=[[s]];if(typeof(t==null?void 0:t.symbolConfig)=="object"&&((l=t==null?void 0:t.symbolConfig)!=null&&l.applyColorModulation)){const a=.6*o[0];r.unshift([{...s,offset:[-a,0],fill:T(s.fill,-.3)}]),r.push([{...s,offset:[a,0],fill:T(s.fill,.3)}]),o[0]+=2*a,u.scale=!1}i.type==="text"&&ut(i,s,r,o,u);const e=$(r,o,u);if(c&&e){const a=e.nodeName.toLowerCase()==="img"?e:e.firstChild;a.nodeName.toLowerCase()==="svg"&&a.setAttribute("viewBox",`0 0 ${o[0].toString()} ${o[1].toString()}`),a.setAttribute("width",c[0].toString()),a.setAttribute("height",c[1].toString()),c.length>2&&(a.style.setProperty("padding-left",((h=c[2])==null?void 0:h.toString())+"px"),a.style.setProperty("padding-right",((p=c[2])==null?void 0:p.toString())+"px"),a.style.setProperty("padding-top",((d=c[3])==null?void 0:d.toString())+"px"),a.style.setProperty("padding-bottom",((n=c[3])==null?void 0:n.toString())+"px"),a.style.setProperty("box-sizing","border-box"))}return e}function pt(i,t=q){const s=V(i),o=W(i),u=!s||"type"in s?null:new Z(s),c=o!=null&&o.color?new Z(o==null?void 0:o.color):null,r=u?N(O(u),t):null,e=c?N(O(c),t):null;return e?r?r===e?r:t>=q?"light":"dark":e:r}export{pt as getContrastingBackgroundTheme,mt as getRenderSymbolParameters,zt as previewSymbol2D};
